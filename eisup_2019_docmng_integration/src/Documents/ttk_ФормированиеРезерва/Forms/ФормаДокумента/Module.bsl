
&НаКлиенте
Процедура ВидОперацииПриИзменении(Элемент)
	
	УстановитьВидимостьДоступность();

КонецПроцедуры

&НаКлиенте
Процедура ВидОперацииОчистка(Элемент, СтандартнаяОбработка)
	
	УстановитьВидимостьДоступность();
	
КонецПроцедуры


&НаСервере
Процедура УстановитьВидимостьДоступность()
	
	
	Если Объект.ВидОперации = Перечисления.ttk_ФормированиеРезерваВидОперации.ПеремещениеРезерва Тогда
		
		Элементы.ЗаказПриемник.Видимость = Истина;
		
	Иначе
		
		Элементы.ЗаказПриемник.Видимость = Ложь;
		
	    Объект.ЗаказПриемник = Документы.ЗаказПокупателя.ПустаяСсылка(); 
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	УстановитьВидимостьДоступность();
КонецПроцедуры


&НаКлиенте
Процедура ОткрытьФормуПодбора(Команда)
	
	
	ПараметрыФормы = Новый Структура("МножественныйВыбор, РежимВыбора, ЗакрыватьПриВыборе,Склад", Истина, Истина, ЛОЖЬ,Объект.Склад); 
    результат = ОткрытьФормуМодально("Документ.ttk_ФормированиеРезерва.Форма.ФормаПодбораНоменклатуры", ПараметрыФормы, ЭтаФорма);


КонецПроцедуры


&НаКлиенте
Процедура НоменклатураПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка, Строка, Поле)

	Если ТипЗнч(ПараметрыПеретаскивания.Значение) = Тип("Массив") Тогда
		
		Для каждого Элемент Из ПараметрыПеретаскивания.Значение Цикл
			
			НоваяСтрокаТЧ=ЭтаФорма.Объект.Номенклатура.Добавить();
			
			НоваяСтрокаТЧ.Номенклатура 			= Элемент.Номенклатура; 
			НоваяСтрокаТЧ.Характеристика 		= Элемент.ХарактеристикаНоменклатуры; 
			НоваяСтрокаТЧ.СерияНоменклатуры 	= Элемент.СерияНоменклатуры; 
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура НоменклатураОкончаниеПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	
	
КонецПроцедуры



&НаКлиенте
Процедура ЗаполнитьТекущимиРезервамиПоЗаказу(Команда)
	
	ЗаполнитьТекущимиРезервамиПоЗаказуНаСервере();
	
КонецПроцедуры



&НаСервере
Процедура ЗаполнитьТекущимиРезервамиПоЗаказуНаСервере()
	
	Если НЕ ЗначениеЗаполнено(Объект.Склад) Тогда
		
		Сообщить("Необходимо указать склад!");
		
		Возврат;
		
	КонецЕсли;
	
	Запрос = новый Запрос;
	
	Запрос.Текст ="ВЫБРАТЬ
	|	ТоварыВРезервеНаСкладахОстатки.Номенклатура,
	|	ТоварыВРезервеНаСкладахОстатки.ХарактеристикаНоменклатуры,
	|	ТоварыВРезервеНаСкладахОстатки.СерияНоменклатуры,
	|	СУММА(ТоварыВРезервеНаСкладахОстатки.КоличествоОстаток) КАК КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.ТоварыВРезервеНаСкладах.Остатки(
	|			,
	|			ДокументРезерва = &Заказ
	|				И Склад = &Склад) КАК ТоварыВРезервеНаСкладахОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыВРезервеНаСкладахОстатки.Номенклатура,
	|	ТоварыВРезервеНаСкладахОстатки.ХарактеристикаНоменклатуры,
	|	ТоварыВРезервеНаСкладахОстатки.СерияНоменклатуры";
	
	Запрос.УстановитьПараметр("Заказ", Объект.Заказ);
	Запрос.УстановитьПараметр("Склад", Объект.Склад);
	
	Выборка =Запрос.Выполнить().Выбрать();
	
	
	Пока Выборка.Следующий() Цикл
		
		НоваяСтрокаТЧ=ЭтаФорма.Объект.Номенклатура.Добавить();
			
		НоваяСтрокаТЧ.Номенклатура 			= Выборка.Номенклатура; 
		НоваяСтрокаТЧ.Характеристика 		= Выборка.ХарактеристикаНоменклатуры; 
		НоваяСтрокаТЧ.СерияНоменклатуры 	= Выборка.СерияНоменклатуры; 
		НоваяСтрокаТЧ.Количество		 	= Выборка.КоличествоОстаток; 

		
	КонецЦикла;
	
	
			
	
КонецПроцедуры



&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	//ххх  22.10.2018 18:38:57, заявка <<<
	//Если ИмяСобытия="ПодборНоменклатурыДляРезерва" Тогда
	//	
	//	Для Сч = 0 По Параметр.ЭтаФорма.ТаблицаВыбора.Количество() -1 Цикл
	//		
	//  	 	ТекЭлемент = Параметр.ЭтаФорма.ТаблицаВыбора[Сч];
	//		
	//		НоваяСтрокаТЧ=Объект.Номенклатура.Добавить();
	//			
	//		НоваяСтрокаТЧ.Номенклатура 			= ТекЭлемент.Номенклатура; 
	//		НоваяСтрокаТЧ.Характеристика		= ТекЭлемент.ХарактеристикаНоменклатуры; 
	//		НоваяСтрокаТЧ.СерияНоменклатуры 	= ТекЭлемент.СерияНоменклатуры; 
	//		НоваяСтрокаТЧ.Количество 			= ТекЭлемент.Количество;

	//		
	//	КонецЦикла
	//	
	//КонецЕсли;
	
	Если ИмяСобытия="ПодборНоменклатурыДляРезерва" Тогда
		 ОбойтиДеревоЗначений(Параметр.ЭтаФорма.ДеревоЗНЧ);		
	КонецЕсли;

	//  22.10.2018 18:38:57 >>>
	
	

КонецПроцедуры
&НаКлиенте
Процедура ОбойтиДеревоЗначений(Элемент)
    ПодчиненныйЭлемент=Элемент.ПолучитьЭлементы();
	Для Каждого Строка из ПодчиненныйЭлемент Цикл
		Если ЗначениеЗаполнено(Строка.Выбрано)  И ЗначениеЗаполнено(Строка.Номенклатура)Тогда
			НоваяСтрокаТЧ=Объект.Номенклатура.Добавить();
				
			НоваяСтрокаТЧ.Номенклатура 			= Строка.Номенклатура; 
			НоваяСтрокаТЧ.Характеристика		= Строка.ХарактеристикаНоменклатуры; 
			НоваяСтрокаТЧ.СерияНоменклатуры 	= Строка.СерияНоменклатуры; 
			НоваяСтрокаТЧ.Количество 			= Строка.Выбрано;

		КонецЕсли;
        //Твой код по обработке строки дерева;
        ОбойтиДеревоЗначений(Строка);
    КонецЦикла;
КонецПроцедуры



