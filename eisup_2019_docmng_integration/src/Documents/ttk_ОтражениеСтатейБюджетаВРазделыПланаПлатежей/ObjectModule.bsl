
Функция ОпределитьИспользованиеБюджетнойСтатьи(Дт, БС)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Ссылка,
		|	СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Ссылка.Код,
		|	СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Период,
		|	СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Использование
		|ИЗ
		|	Справочник.СтатьиОборотовПоБюджетам.абс_ПериодыИспользования КАК СтатьиОборотовПоБюджетамабс_ПериодыИспользования
		|ГДЕ
		|	&Дт МЕЖДУ НАЧАЛОПЕРИОДА(СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Период, ГОД) И КОНЕЦПЕРИОДА(СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Период, ГОД)
		|	И СтатьиОборотовПоБюджетамабс_ПериодыИспользования.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Дт", Дт);
	Запрос.УстановитьПараметр("Ссылка", БС);
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Возврат Результат.Количество();
	
КонецФункции

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ЭтоНовый() Тогда
		Статус = Перечисления.абс_СтатусыПервичныхДокументов.Подготовка;
		Ответственный = глЗначениеПеременной("глТекущийПользователь");
	КонецЕсли;
	
	//Если Не ЗначениеЗаполнено(Организация) Тогда
	//	Организация = УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"), "ОсновнаяОрганизация");
	//КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	ТекПользователь = глЗначениеПеременной("глТекущийПользователь");
	
	НаборЗаписей = РегистрыСведений.абс_ИзменениеСтатусовПервичныхДокументов.СоздатьНаборЗаписей();	
	НаборЗаписей.Отбор.ПервичныйДокумент.Установить(Ссылка);
	НаборЗаписей.Прочитать();
	
	Запись = НаборЗаписей.Добавить();
	Запись.Период = абс_СерверныеФункции.ПолучитьДатуСервера(); 
	Запись.ПервичныйДокумент = Ссылка;
	Запись.Пользователь = ТекПользователь;	
	Запись.СтатусДокумента = Статус;	
	Запись.Комментарий = Комментарий;
	
	НаборЗаписей.Записать();
	
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	
	Дата = ТекущаяДата();
	Статус = Перечисления.абс_СтатусыПервичныхДокументов.Подготовка;
	ОтражениеСтатейБюджетаПланаПлатежей.Очистить();
	Комментарий = "";
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Если Статус = Перечисления.абс_СтатусыПервичныхДокументов.Согласован Тогда		
		//Для Каждого Стр Из ОтражениеСтатейБюджетаПланаПлатежей Цикл
		//	Если ЗначениеЗаполнено(Стр.СтатьяБюджета) Тогда
		//		БС = ОпределитьИспользованиеБюджетнойСтатьи(Дата, Стр.СтатьяБюджета);
		//		Если БС = 0 Тогда				
		//			Сообщить("В строке " + Строка(Стр.НомерСтроки) + " статья оборотов '" + Строка(Стр.СтатьяБюджета) + "' не используется в периоде " + Формат(Год(Дата), "ЧЦ=4; ЧГ=0"));
		//			Отказ = Истина;
		//			Возврат;
		//		КонецЕсли;
		//	КонецЕсли;
		//КонецЦикла;
		//
		НаборОтражениеСтатейБюджетаПланаПлатежей = РегистрыСведений.ttk_ОтражениеСтатейБюджетаВРазделыПланаПлатежей.СоздатьНаборЗаписей();
		НаборОтражениеСтатейБюджетаПланаПлатежей.Отбор.Регистратор.Установить(Ссылка);
		Для Каждого СтрОСБ Из ОтражениеСтатейБюджетаПланаПлатежей Цикл
        	НоваяЗаписьОтражениеСтатейБПП = НаборОтражениеСтатейБюджетаПланаПлатежей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗаписьОтражениеСтатейБПП, СтрОСБ);
			НоваяЗаписьОтражениеСтатейБПП.Период = Дата;
		КонецЦикла;
		НаборОтражениеСтатейБюджетаПланаПлатежей.Записать();
		//
	КонецЕсли;
	
КонецПроцедуры