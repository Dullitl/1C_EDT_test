&НаСервере
Процедура СформироватьТаблицу()
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Структ=Новый Структура;
	Структ.Вставить("МестонахождениеБиллинга", ЭтаФорма.ВладелецФормы.Объект.МестонахождениеБиллинга);
	Структ.Вставить("MONT_F", ЭтаФорма.ВладелецФормы.Объект.MONT_F);
	Структ.Вставить("ОбъектСсылка", ЭтаФорма.ВладелецФормы.Объект.Ссылка);
	ПолучитьСессии(Отказ,Структ);
	Если ЭтаФорма.Сессии.Количество()=0 Тогда
		Предупреждение("Нет сессий из биллинга, которые можно загрузить.");
		Отказ=Истина;
		Возврат;
	КонецЕсли;
	ФлагОтсутствияТекущего=Истина;
	Для й=0 По ЭтаФорма.Сессии.Количество()-1 Цикл
		ЭтаФорма.Сессии[й].Индекс=й+1;
		Если ЭтаФорма.Сессии[й].ТекущийДокумент Тогда
			ФлагОтсутствияТекущего=Ложь;
			ЭтаФорма.Элементы.Сессии.ТекущаяСтрока=ЭтаФорма.Сессии.Количество()+й;
		КонецЕсли;
	КонецЦикла;
	Если ФлагОтсутствияТекущего Тогда
		ЭтаФорма.Элементы.Сессии.ТекущаяСтрока=ЭтаФорма.Сессии.Количество()+ЭтаФорма.Сессии.Количество()-1;
	КонецЕсли;
	ЭтаФорма.Элементы.СессииКоманднаяПанель.Видимость=Ложь;
	ЭтаФорма.Заголовок="Сессии из TPI";
	ЭтаФорма.Элементы.НадписьПериод.Заголовок=ЭтаФорма.ВладелецФормы.Объект.МесяцУчёта;
	ЭтаФорма.Элементы.НадписьМестонахождение.Заголовок=ЭтаФорма.ВладелецФормы.Объект.МестонахождениеБиллинга.Наименование;
КонецПроцедуры

&НаСервере
Процедура ПолучитьСессии(Отказ,Структ)
	ТаблицаНаФорме="Сессии";
	ТЗ_Сессии=Новый ТаблицаЗначений;
	МассивРеквизитов = Новый Массив;
	Отказ=Ложь;
	МассивПеременных=Новый Массив;
	ПрефиксТаблицы=СокрЛП(Структ.МестонахождениеБиллинга.ПрефиксТаблицыНачисленияВTPI);
	Если ПрефиксТаблицы="КТТ" Тогда
		ПрефиксТаблицы="";
	Иначе
		ПрефиксТаблицы="_"+ПрефиксТаблицы;
	КонецЕсли;
	// [[1]] - Суффикс таблицы
	МассивПеременных.Добавить(ПрефиксТаблицы);
	ПрефиксСессии=СокрЛП(Структ.МестонахождениеБиллинга.ПрефиксСессииНачисленияВTPI);
	// [[2]] - Префикс для полей SESSIONID или JOURNALID
	МассивПеременных.Добавить(""+СтрДлина(ПрефиксСессии)+")='"+ПрефиксСессии);
	// [[3]] - Месяц+100*Год периода загрузки
	МассивПеременных.Добавить(СтрЗаменить(Строка(Структ.MONT_F),Символы.НПП,""));
	// [[4]] - алиас поля даты загруженной сессии
	МассивПеременных.Добавить(?(ПрефиксТаблицы="","TRANSDATE","SESSIONDATE"));
	// [[5]] - Не грузить МГМН, если БиллингМГМН=Истина, и грузить МГМН как основной если БиллингМГМН=Ложь
	МассивПеременных.Добавить(?(Структ.МестонахождениеБиллинга.БиллингМГМН," and [OPERATOR] IS NULL",""));
	// [[6]] - Грузить в пределах группы доступа - Бреда
	МассивПеременных.Добавить(?(ПустаяСтрока(Структ.МестонахождениеБиллинга.Регион),""," and ([AGENT]='"+СокрЛП(Структ.МестонахождениеБиллинга.Регион)+"')"));
 	ОбщегоНазначения.ttk_ПолучитьТаблицуИзTPIпоНастройкеОбмена(Отказ,"000001.БиллингНачисленияСодержание",ТЗ_Сессии,Истина,МассивПеременных);
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	Если ТЗ_Сессии.Количество()=0 Тогда
		Возврат;
	КонецЕсли;
	ТЗ_Сессии.Колонки.Добавить("КолСтрок",Новый ОписаниеТипов("Число"));
	ТЗ_Сессии.Колонки.Добавить("ЖурналИД",Новый ОписаниеТипов("Строка"));
	ТЗ_Сессии.Колонки.Добавить("СессияИД",Новый ОписаниеТипов("Строка"));
	ТЗ_Сессии.Колонки.Добавить("СессияДата",Новый ОписаниеТипов("Дата"));
	Для каждого йСтр Из ТЗ_Сессии Цикл
		йСтр.КолСтрок=Число(йСтр.STROK);
		йСтр.ЖурналИД=йСтр.JOURNALID;
		йСтр.СессияИД=йСтр.SESSIONID;
		йСтр.СессияДата=йСтр.SESSIONDATE;
	КонецЦикла;
	Запрос=Новый Запрос;
	Запрос.МенеджерВременныхТаблиц=Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Регион",Структ.МестонахождениеБиллинга.Регион);
	Запрос.УстановитьПараметр("Оператор",Структ.МестонахождениеБиллинга.БиллингМГМН);
	Запрос.Текст="ВЫБРАТЬ
	             |	СессииИзБиллинга.AGENT,
	             |	СессииИзБиллинга.OPERATOR,
	             |	ВЫРАЗИТЬ(СессииИзБиллинга.ЖурналИД КАК СТРОКА(20)) КАК JOURNALID,
	             |	ВЫРАЗИТЬ(СессииИзБиллинга.СессияИД КАК СТРОКА(20)) КАК SESSIONID,
	             |	СессииИзБиллинга.СессияДата КАК SESSIONDATE,
	             |	СессииИзБиллинга.NETNDS,
	             |	СессииИзБиллинга.NDS,
	             |	СессииИзБиллинга.SNDS,
	             |	СессииИзБиллинга.КолСтрок КАК STROK,
	             |	СессииИзБиллинга.QTY
	             |ПОМЕСТИТЬ ВТ_СессииИзБиллинга
	             |ИЗ
	             |	&Табл КАК СессииИзБиллинга
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	СессииИзБиллинга.JOURNALID,
	             |	СессииИзБиллинга.SESSIONID,
	             |	СессииИзБиллинга.SESSIONDATE,
	             |	СУММА(СессииИзБиллинга.NETNDS) КАК NETNDS,
	             |	СУММА(СессииИзБиллинга.NDS) КАК NDS,
	             |	СУММА(СессииИзБиллинга.SNDS) КАК SNDS,
	             |	СУММА(СессииИзБиллинга.STROK) КАК STROK,
	             |	СУММА(СессииИзБиллинга.QTY) КАК QTY
	             |ИЗ
	             |	ВТ_СессииИзБиллинга КАК СессииИзБиллинга
	             |ГДЕ
	             |	ВЫБОР
	             |			КОГДА &Регион = """"
	             |				ТОГДА ИСТИНА
	             |			ИНАЧЕ (ВЫРАЗИТЬ(&Регион КАК СТРОКА(50))) = (ВЫРАЗИТЬ(СессииИзБиллинга.AGENT КАК СТРОКА(50)))
	             |		КОНЕЦ
	             |	И ВЫБОР
	             |			КОГДА &Оператор
	             |				ТОГДА (ВЫРАЗИТЬ(СессииИзБиллинга.OPERATOR КАК СТРОКА(50))) = """"
	             |			ИНАЧЕ ИСТИНА
	             |		КОНЕЦ
	             |
	             |СГРУППИРОВАТЬ ПО
	             |	СессииИзБиллинга.JOURNALID,
	             |	СессииИзБиллинга.SESSIONID,
	             |	СессииИзБиллинга.SESSIONDATE";
	Запрос.УстановитьПараметр("Табл",ТЗ_Сессии.Скопировать());
	ТЗ_Сессии=Запрос.Выполнить().Выгрузить();
	Запрос.МенеджерВременныхТаблиц.Закрыть();
	Если ТЗ_Сессии.Количество()=0 Тогда
		Возврат;
	КонецЕсли;
	ЭтаФорма.Сессии.Загрузить(ТЗ_Сессии.Скопировать());
	Для каждого нСтр Из ЭтаФорма.Сессии Цикл
		нСтр.Актуальность=Истина;
		нСтр.ТекущийДокумент=Ложь;
		нСтр.Документ=Документы.ttk_ЗагрузкаНачисленийИзБиллинга.ПустаяСсылка();
	КонецЦикла;
	Запрос=Новый Запрос;
	Запрос.МенеджерВременныхТаблиц=Новый МенеджерВременныхТаблиц;
	Запрос.Текст="ВЫБРАТЬ
	             |	СессииИзБиллинга.JOURNALID,
	             |	СессииИзБиллинга.SESSIONID,
	             |	СессииИзБиллинга.SESSIONDATE КАК TRANSDATE,
	             |	СессииИзБиллинга.Документ,
	             |	СессииИзБиллинга.ТекущийДокумент,
	             |	СессииИзБиллинга.Актуальность,
	             |	СессииИзБиллинга.Индекс,
	             |	СессииИзБиллинга.NETNDS,
	             |	СессииИзБиллинга.NDS,
	             |	СессииИзБиллинга.SNDS,
	             |	СессииИзБиллинга.STROK,
	             |	СессииИзБиллинга.QTY
	             |ПОМЕСТИТЬ ВТ_СессииИзБиллинга
	             |ИЗ
	             |	&Табл КАК СессииИзБиллинга
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	ttk_ЗагруженныеСессииИзЗагрузкиНачислений.JOURNALID,
	             |	ttk_ЗагруженныеСессииИзЗагрузкиНачислений.SESSIONID,
	             |	ttk_ЗагруженныеСессииИзЗагрузкиНачислений.TRANSDATE,
	             |	ttk_ЗагруженныеСессииИзЗагрузкиНачислений.Документ,
	             |	1 КАК Флаг,
	             |	ttk_ЗагруженныеСессииИзЗагрузкиНачислений.Актуальность
	             |ПОМЕСТИТЬ ВТ_СессииВ1С
	             |ИЗ
	             |	РегистрСведений.ttk_ЗагруженныеСессииИзЗагрузкиНачислений КАК ttk_ЗагруженныеСессииИзЗагрузкиНачислений
	             |ГДЕ
	             |	ЕСТЬNULL(ttk_ЗагруженныеСессииИзЗагрузкиНачислений.MONT_F, 0) = &MONT_F
	             |	И ttk_ЗагруженныеСессииИзЗагрузкиНачислений.МестонахождениеБиллинга = &Местонахождение
	             |;
	             |
	             |////////////////////////////////////////////////////////////////////////////////
	             |ВЫБРАТЬ
	             |	СессииИзБиллинга.JOURNALID,
	             |	СессииИзБиллинга.SESSIONID,
	             |	ЕСТЬNULL(СессииВ1С.Документ, ЗНАЧЕНИЕ(Документ.ttk_ЗагрузкаНачисленийИзБиллинга.ПустаяСсылка)) КАК Документ,
	             |	ВЫБОР
	             |		КОГДА СессииВ1С.Документ = &Дока
	             |			ТОГДА ИСТИНА
	             |		ИНАЧЕ ЛОЖЬ
	             |	КОНЕЦ КАК ТекущийДокумент,
	             |	СессииВ1С.Флаг,
	             |	СессииИзБиллинга.TRANSDATE КАК SESSIONDATE,
	             |	ВЫБОР
	             |		КОГДА СессииВ1С.Документ = &Дока
	             |			ТОГДА ЛОЖЬ
	             |		ИНАЧЕ ЕСТЬNULL(СессииВ1С.Актуальность, СессииИзБиллинга.Актуальность)
	             |	КОНЕЦ КАК Актуальность,
	             |	СессииИзБиллинга.Индекс,
	             |	СессииИзБиллинга.NETNDS,
	             |	СессииИзБиллинга.NDS,
	             |	СессииИзБиллинга.SNDS,
	             |	СессииИзБиллинга.STROK,
	             |	СессииИзБиллинга.QTY
	             |ИЗ
	             |	ВТ_СессииИзБиллинга КАК СессииИзБиллинга
	             |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СессииВ1С КАК СессииВ1С
	             |		ПО ((ВЫРАЗИТЬ(СессииВ1С.JOURNALID КАК СТРОКА(10))) = (ВЫРАЗИТЬ(СессииИзБиллинга.JOURNALID КАК СТРОКА(10))))
	             |			И ((ВЫРАЗИТЬ(СессииИзБиллинга.SESSIONID КАК СТРОКА(10))) = (ВЫРАЗИТЬ(СессииВ1С.SESSIONID КАК СТРОКА(10))))
	             |			И СессииИзБиллинга.TRANSDATE = СессииВ1С.TRANSDATE";
	Запрос.УстановитьПараметр("Дока",Структ.ОбъектСсылка);
	Запрос.УстановитьПараметр("MONT_F",Структ.MONT_F);
	Запрос.УстановитьПараметр("Местонахождение",Структ.МестонахождениеБиллинга);
	Запрос.УстановитьПараметр("Табл",ЭтаФорма.Сессии.Выгрузить());
	ЭтаФорма.Сессии.Загрузить(Запрос.Выполнить().Выгрузить());
	Запрос.МенеджерВременныхТаблиц.Закрыть();
	Для каждого йСессия Из ЭтаФорма.Сессии Цикл
		Если йСессия.Флаг=0 Тогда
			НСессии=РегистрыСведений.ttk_ЗагруженныеСессииИзЗагрузкиНачислений.СоздатьНаборЗаписей();
			НСессии.Отбор.JOURNALID.Установить(йСессия.JOURNALID);
			НСессии.Отбор.SESSIONID.Установить(йСессия.SESSIONID);
			НСессии.Отбор.TRANSDATE.Установить(йСессия.SESSIONDATE);
			//НСессии.Отбор.MONT_F.Установить(Структ.MONT_F);
			НСессии.Отбор.МестонахождениеБиллинга.Установить(Структ.МестонахождениеБиллинга);
			НСессии.Прочитать();
			Если НСессии.Количество()=0 Тогда
				НСессия=НСессии.Добавить();
				НСессия.JOURNALID=йСессия.JOURNALID;
				НСессия.SESSIONID=йСессия.SESSIONID;
				НСессия.TRANSDATE=йСессия.SESSIONDATE;
				НСессия.MONT_F=Структ.MONT_F;
				НСессия.МестонахождениеБиллинга=Структ.МестонахождениеБиллинга;
				НСессия.Документ=Документы.ttk_ЗагрузкаНачисленийИзБиллинга.ПустаяСсылка();
				НСессия.Актуальность=Истина;
				НСессии.Записать();
				йСессия.Флаг=1;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	Возврат;
КонецПроцедуры

&НаКлиенте
Процедура СессииВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Если НЕ Элемент.ТекущиеДанные.Актуальность И НЕ Элемент.ТекущиеДанные.ТекущийДокумент Тогда
		Предупреждение("Неактуальную или ранее загруженную сессию загружать нельзя...");
		СтандартнаяОбработка=Ложь;
		Возврат;
	КонецЕсли;
	ЭтаФорма.ВладелецФормы.Объект.СессияID=Элемент.ТекущиеДанные.SESSIONID;
	ЭтаФорма.ВладелецФормы.Объект.ЖурналID=Элемент.ТекущиеДанные.JOURNALID;
	ЭтаФорма.ВладелецФормы.Объект.ДатаЗагрузкиВTPI=Элемент.ТекущиеДанные.SESSIONDATE;
	ЭтаФорма.ВладелецФормы.Объект.ИтогоСтрок=Элемент.ТекущиеДанные.STROK;
	ЭтаФорма.ВладелецФормы.Объект.ИтогоКоличество=Элемент.ТекущиеДанные.QTY;
	ЭтаФорма.ВладелецФормы.Объект.ИтогоБезНДС=Элемент.ТекущиеДанные.NETNDS;
	ЭтаФорма.ВладелецФормы.Объект.ИтогоНДС=Элемент.ТекущиеДанные.NDS;
	ЭтаФорма.ВладелецФормы.Объект.ИтогоСНДС=Элемент.ТекущиеДанные.SNDS;
	ЭтаФорма.ВладелецФормы.Объект.СессияTPI=" "+ЭтаФорма.ВладелецФормы.Объект.МесяцУчёта+" ("+
											Элемент.ТекущиеДанные.SESSIONID+")("+
											Элемент.ТекущиеДанные.JOURNALID+")("+
											Элемент.ТекущиеДанные.SESSIONDATE+")";
	Закрыть();
КонецПроцедуры

&НаКлиенте
Процедура йПоменятьАктуальность(Команда)
	Если ЭтаФорма.Элементы.Сессии.ТекущиеДанные=Неопределено Тогда
		Возврат;
	КонецЕсли;
	Если ЗначениеЗаполнено(ЭтаФорма.Элементы.Сессии.ТекущиеДанные.Документ) Тогда
		Возврат;
	КонецЕсли;
	ТекДанные=ЭтаФорма.Элементы.Сессии.ТекущиеДанные;
	ТекДанные.Актуальность=НЕ ТекДанные.Актуальность;
	НСессии=РегистрыСведений.ttk_ЗагруженныеСессииИзЗагрузкиНачислений.СоздатьНаборЗаписей();
	НСессии.Отбор.JOURNALID.Установить(ТекДанные.JOURNALID);
	НСессии.Отбор.SESSIONID.Установить(ТекДанные.SESSIONID);
	НСессии.Отбор.TRANSDATE.Установить(ТекДанные.SESSIONDATE);
	//НСессии.Отбор.MONT_F.Установить(ЭтаФорма.ВладелецФормы.Объект.MONT_F);
	НСессии.Отбор.МестонахождениеБиллинга.Установить(ЭтаФорма.ВладелецФормы.Объект.МестонахождениеБиллинга);
	НСессии.Прочитать();
	НСессии.Очистить();
	НСессия=НСессии.Добавить();
	НСессия.JOURNALID=ТекДанные.JOURNALID;
	НСессия.SESSIONID=ТекДанные.SESSIONID;
	НСессия.TRANSDATE=ТекДанные.SESSIONDATE;
	НСессия.MONT_F=ЭтаФорма.ВладелецФормы.Объект.MONT_F;
	НСессия.МестонахождениеБиллинга=ЭтаФорма.ВладелецФормы.Объект.МестонахождениеБиллинга;
	НСессия.Документ=Документы.ttk_ЗагрузкаНачисленийИзБиллинга.ПустаяСсылка();
	НСессия.Актуальность=ТекДанные.Актуальность;
	НСессии.Записать();
КонецПроцедуры
