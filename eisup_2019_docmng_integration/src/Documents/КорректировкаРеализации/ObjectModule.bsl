Перем мУдалятьДвижения Экспорт;

Перем мВалютаРегламентированногоУчета Экспорт;
Перем мИспользоватьРасширеннуюАналитику Экспорт;
Перем мДатаНачалаИспользованияРасширеннойАналитики Экспорт;

Перем мПараметрыПартионногоУчета;
Перем мСтруктураПараметровВзаиморасчетов Экспорт;

Перем мПараметрыСвязиСтрокТЧ Экспорт;

Перем мДокументРеализацииСсылка Экспорт;

Перем мУказаниеСкладовВТЧ Экспорт;

////////////////////////////////////////////////////////////////////////////////
// ЭКСПОРТНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ ДОКУМЕНТА

Процедура ЗаполнитьСвойстваШапки(ЗаполнятьРедактируемыеРеквизиты = Истина) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ДокументРеализации) Тогда
		Возврат;
	КонецЕсли;
	
	// Перед заполнением сохраним реквизиты шапки документа, не заполняемые из основания
	НезаполняемыеРеквизиты =
		"ПометкаУдаления, Проведен, Дата, Номер, ВидОперации,
		|ДокументРеализации, КорректироватьБУиНУ, Ответственный, Комментарий,абс_СтатусДокумента,абс_Контрагент,абс_ДоговорКонтрагента,
		|абс_ПериодОтражения, абс_ПериодОтражения91, ПризнаватьЗачитыватьАванс, абс_ОпределенияПризнакаДопЛистаДляКниги, абс_ЗаписьДополнительногоЛиста, абс_КорректируемыйПериод,
		|ОтражатьВБухгалтерскомУчете, ОтражатьВНалоговомУчете, ОтражатьВУправленческомУчете
// +++ввв 15.03.2017 г.
		|, ttk_ТипБиллинга
// ---ввв 15.03.2017 г.
//+++ Григорьев Д.В.
		|, ДатаЗагрузкиИзАСР
		|, ЛогЗагрузкиИзАСР
//+++ Григорьев Д.В.
// +++ввв 09.12.2016 г.
		|, Склад";
// ---ввв 09.12.2016 г.
		
	// АБС ВСТАВКА Фролов 20120807
	НезаполняемыеРеквизиты = НезаполняемыеРеквизиты + ", абс_КорректировкаБиллинга,абс_ПричинаИзмененияСтатуса,
		|абс_ДокументРеализацииБиллингСторно,абс_ДокументРеализацииБиллингИсправленная,абс_ОтветственныйБухгалтер, Подразделение";
	// АБС ВСТАВКА Фролов 20120807 КОНЕЦ
		
	Если НЕ ЗаполнятьРедактируемыеРеквизиты Тогда
		НезаполняемыеРеквизиты = НезаполняемыеРеквизиты
			+ ", ОтчетностьПодписана, СтатьяПрочихДоходовИРасходов, АдресДоставки, ДополнениеКАдресуДоставки,
			    |БанковскийСчетОрганизации, Грузоотправитель, Грузополучатель";
	КонецЕсли;
	
	СтруктураНезаполняемыеРеквизиты = Новый Структура(НезаполняемыеРеквизиты);
	ЗаполнитьЗначенияСвойств(СтруктураНезаполняемыеРеквизиты, ЭтотОбъект);
	
	// Очистим реквизиты шапки документа
	СтароеУчитыватьНДС=ЭтотОбъект.УчитыватьНДС;
	СтароеСуммаВключаетНДС=ЭтотОбъект.СуммаВключаетНДС;
	Для Каждого Реквизит из ЭтотОбъект.Метаданные().Реквизиты Цикл
		Если НЕ СтруктураНезаполняемыеРеквизиты.Свойство(Реквизит.Имя) Тогда
			ЭтотОбъект[Реквизит.Имя] = Неопределено;
		КонецЕсли;
	КонецЦикла;
	
	мДокументРеализацииСсылка = УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Истина);
	
	Если ЗначениеЗаполнено(мДокументРеализацииСсылка) Тогда
		
		// Заполненим основные реквизиты шапки по первичному документу
		ЗаполнениеДокументов.ЗаполнитьШапкуДокументаПоОснованию(ЭтотОбъект, мДокументРеализацииСсылка);
		
		Если Не ЗначениеЗаполнено(КурсВзаиморасчетов) ИЛИ Не ЗначениеЗаполнено(КратностьВзаиморасчетов) Тогда
			СтруктураКурсаВзаиморасчетов = МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаДокумента, Дата);
			КурсВзаиморасчетов 			 = СтруктураКурсаВзаиморасчетов.Курс;
			КратностьВзаиморасчетов 	 = СтруктураКурсаВзаиморасчетов.Кратность;
		КонецЕсли;
		
		// Заполним реквизиты учета НДС в случае, если таких реквизитов нет в первичном документе
// +++ввв заявка 34518 11.11.2015 г.
		Если ТипЗнч(мДокументРеализацииСсылка)=Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом") Тогда
			СуммаВключаетНДС = СтароеСуммаВключаетНДС;
			УчитыватьНДС = СтароеУчитыватьНДС;
		Иначе
			МетаданныеДокументаОснования = мДокументРеализацииСсылка.Метаданные();
			Если МетаданныеДокументаОснования.Реквизиты.Найти("СуммаВключаетНДС") = Неопределено Тогда
				СуммаВключаетНДС = Истина;
			КонецЕсли;
			Если МетаданныеДокументаОснования.Реквизиты.Найти("УчитыватьНДС") = Неопределено Тогда
				УчитыватьНДС = Истина;
			КонецЕсли;
		КонецЕсли;
// ---ввв
		
	КонецЕсли;
	
	Если КорректироватьБУиНУ Тогда
		// Перезаполним шапку по документу основания 
		ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДокументРеализации);
	КонецЕсли;
	
	// Восстановим незаполняемые реквизиты
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, СтруктураНезаполняемыеРеквизиты);
	
	Если ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение Тогда
		ИсправляемыйДокументРеализации = мДокументРеализацииСсылка;
	Иначе
		ИсправляемыйДокументРеализации = УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Ложь);
	КонецЕсли;
	
	// Установим значение Неопределено для незаполненных реквизитов составного типа
	Если НЕ ЗначениеЗаполнено(Сделка) И Сделка <> Неопределено Тогда
		Сделка = Неопределено;
	КонецЕсли;
	
	// Цены в документе всегда указываем вручную
	ТипЦен = Неопределено;
	
КонецПроцедуры

Процедура ЗаполнитьПоДокументу() Экспорт
	
	Если ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
	 ИЛИ ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		
		ЗаполнитьПоРеализации();
		
	ИначеЕсли ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.АктОбОказанииПроизводственныхУслуг") Тогда
		
		ЗаполнитьПоАктуОказанияПроизводственныхУслуг();
		
	КонецЕсли;
	
КонецПроцедуры

Функция ДоступнаКорректировкаБУиНУ() Экспорт
	
	// Корректировка по учетам доступна только для некоторых видов документов
	Возврат
		((ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
			И ДокументРеализации.ВидОперации = Перечисления.ВидыОперацийРеализацияТоваров.ПродажаКомиссия
			И ЗначениеЗаполнено(ДокументРеализации.ДоговорКонтрагента)
			И ДокументРеализации.ДоговорКонтрагента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем)
		ИЛИ ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.АктОбОказанииПроизводственныхУслуг")
		ИЛИ (ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.КорректировкаРеализации")
			 И ДокументРеализации.КорректироватьБУиНУ)
		ИЛИ ТипЗнч(ДокументРеализации) = Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом"));
				 
КонецФункции

//АБС+ Тупиков 13209
Функция ДоступноПризнаватьЗачитыватьАванс() Экспорт
	
	// Возможность признавать или зачитывать аванс недоступна 
	// для договоров с ведением взаиморасчетов по расчетным документам с контрагентами
	Если ЗначениеЗаполнено(ДоговорКонтрагента) Тогда
		Возврат НЕ ДоговорКонтрагента.ВестиПоДокументамРасчетовСКонтрагентом;
	Иначе
		Возврат Ложь;
	КонецЕсли;
			
КонецФункции
//АБС- Тупиков

Функция ПолучитьПоследнийКорректирующийДокумент(ДокументСсылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", 	  ДокументСсылка);
	Запрос.УстановитьПараметр("ЭтотДокумент", Ссылка);
	
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	КорректировкаРеализации.Ссылка
	|ИЗ
	|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
	|ГДЕ
	|	КорректировкаРеализации.ИсправляемыйДокументРеализации = &Ссылка
	|	И КорректировкаРеализации.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение)
	|	И КорректировкаРеализации.Ссылка <> &ЭтотДокумент
	|	И КорректировкаРеализации.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	КорректировкаРеализации.Дата УБЫВ";
	
	Результат = Запрос.Выполнить().Выбрать();
	
	Если Результат.Следующий() Тогда
		Возврат Результат.Ссылка;
	КонецЕсли;
	
	Возврат ДокументСсылка;
	
КонецФункции

Функция ЭтоКорректировкаРТиУ() Экспорт
	
	//Возврат (ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.РеализацияТоваровУслуг"));
	Если ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		Возврат Истина;
	ИначеЕсли ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом") И ТипЗнч(мДокументРеализацииСсылка.абс_ДокументОснование) = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
		Возврат Истина;
// +++ввв 14.11.23016 г.
	ИначеЕсли ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом") И ТипЗнч(мДокументРеализацииСсылка.абс_ДокументОснование) = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
		Возврат Истина;
// ---ввв 14.11.2016 г.
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция ЭтоКорректировкаАкта() Экспорт
	
	Возврат (ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.АктОбОказанииПроизводственныхУслуг"));
	
КонецФункции

Функция ВозможнаКорректировкаУслуг() Экспорт
	
	Если НЕ ЗначениеЗаполнено(мДокументРеализацииСсылка)
	 ИЛИ ДоговорКонтрагента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.СчетФактураВыданный")
	 ИЛИ ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом")
	 ИЛИ ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ОтражениеРеализацииТоваровИУслугНДС") Тогда
		Возврат Истина;
 	КонецЕсли;
 	
	Возврат ОбщегоНазначения.НаличиеТабличнойЧастиУДокумента(мДокументРеализацииСсылка.Метаданные().Имя, "Услуги");
	
КонецФункции

Функция ПолучитьОписаниеТипаНоменклатурыПоОснованию() Экспорт
	
	Если ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ПередачаОС") Тогда
		
		ОписаниеТипаНоменклатуры = Новый ОписаниеТипов("СправочникСсылка.ОсновныеСредства");
		
	ИначеЕсли ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ПередачаНМА") Тогда
		
		ОписаниеТипаНоменклатуры = Новый ОписаниеТипов("СправочникСсылка.НематериальныеАктивы");
		
	ИначеЕсли ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.РеализацияОтгруженныхТоваров")
	 И ТипЗнч(мДокументРеализацииСсылка.ДокументОтгрузки) = Тип("ДокументСсылка.ПередачаОС") Тогда
	 
		ОписаниеТипаНоменклатуры = Новый ОписаниеТипов("СправочникСсылка.ОсновныеСредства");
		
	ИначеЕсли ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.СчетФактураВыданный")
	 ИЛИ ТипЗнч(мДокументРеализацииСсылка) = Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом") Тогда
	 
		ОписаниеТипаНоменклатуры = Новый ОписаниеТипов("СправочникСсылка.Номенклатура, СправочникСсылка.ОсновныеСредства, СправочникСсылка.НематериальныеАктивы");
		
	Иначе
		
		ОписаниеТипаНоменклатуры = Новый ОписаниеТипов("СправочникСсылка.Номенклатура");
		
	КонецЕсли;
	
	Возврат ОписаниеТипаНоменклатуры;
	
КонецФункции

Функция ПолучитьСвойстваСкладаВТабличнойЧасти() Экспорт
	
	СвойстваСклада = Новый Структура;
	
	СвойстваСклада.Вставить("ВидимостьСклада", 				КорректироватьБУиНУ И ЭтоКорректировкаРТиУ());
	СвойстваСклада.Вставить("ОбязательноеЗаполнениеСклада", СвойстваСклада.ВидимостьСклада);
	
	Возврат СвойстваСклада;
	
КонецФункции

Функция ПолучитьСвойстваЗаказаВТабличнойЧасти() Экспорт
	
	ВедениеВзаиморасчетов = ДоговорКонтрагента.ВедениеВзаиморасчетов;
	СвойстваЗаказа 		  = Новый Структура;
	
	// Заказ в ТЧ виден, если взаиморасчеты по договору ведутся по заказам или по договору в целом (не ведутся по счетам)
	// Заполнение заказа обязательно, если если взаиморасчеты по договору ведутся по заказам
	СвойстваЗаказа.Вставить("ВидимостьЗаказа",
		ВедениеВзаиморасчетов <> Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоСчетам
		И КорректироватьБУиНУ
		И ЭтоКорректировкаРТиУ());
	СвойстваЗаказа.Вставить("ОбязательноеЗаполнениеЗаказа",
		СвойстваЗаказа.ВидимостьЗаказа
		И ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоЗаказам);
	СвойстваЗаказа.Вставить("ВидимостьСпособаСписания",
		СвойстваЗаказа.ВидимостьЗаказа);
	СвойстваЗаказа.Вставить("ОбязательноеЗаполнениеСпособаСписания",
		СвойстваЗаказа.ВидимостьСпособаСписания
		И ЗначениеЗаполнено(Сделка));
	
	Возврат СвойстваЗаказа;
	
КонецФункции
	
//Выполняет заполнение счетов учета в переданной строке табличной части
//
Процедура ЗаполнитьСчетаУчетаВСтрокеТабЧастиРегл(СтрокаТЧ, ИмяТабЧасти, ЗаполнятьБУ, ЗаполнятьНУ) Экспорт
	
	ЗаполнитьСчетаУчетаВТабЧасти(СтрокаТЧ, ИмяТабЧасти, ЗаполнятьБУ, ЗаполнятьНУ);
	
КонецПроцедуры // ЗаполнитьСчетаУчетаВСтрокеТабЧасти()

// Заполняет счета БУ и НУ в табличной части документа
//
Процедура ЗаполнитьСчетаУчетаВТабЧасти(ТабличнаяЧасть, ИмяТабЧасти, ЗаполнятьБУ, ЗаполнятьНУ) Экспорт
	
	СчетаУчетаВДокументах.ЗаполнитьСчетаУчетаТабличнойЧасти(ИмяТабЧасти, ТабличнаяЧасть, ЭтотОбъект, ЗаполнятьБУ, ЗаполнятьНУ);
	
КонецПроцедуры // обЗаполнитьСчетаУчетаВТабЧасти()

// Возвращает структуру со значениями по-умолчанию счетов учета шапки (кроме счетов учета номенклатуры и затрат).
//
Функция ЗаполнитьСтруктуруСчетовУчетаШапки(ЗаполнятьБУ = Истина, ЗаполнятьНУ = Истина) Экспорт
 
	СтруктураСчетов = Новый Структура;
	
	Если ЗаполнятьБУ и ОтражатьВБухгалтерскомУчете Тогда
		
		СчетаУчета = БухгалтерскийУчетРасчетовСКонтрагентами.ПолучитьСчетаРасчетовСКонтрагентом(Организация, Контрагент, ДоговорКонтрагента);
		СтруктураСчетов.Вставить("СчетУчетаРасчетовСКонтрагентом", СчетаУчета.СчетРасчетовПокупателя);
		СтруктураСчетов.Вставить("СчетУчетаРасчетовПоАвансам",	   СчетаУчета.СчетАвансовПокупателя);
		
	КонецЕсли;
	
	Возврат СтруктураСчетов;

КонецФункции

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ПЕЧАТИ

#Если Клиент Тогда

// Процедура осуществляет печать документа. Можно направить печать на 
// экран или принтер, а также распечатать необходимое количество копий.
//
//  Название макета печати передается в качестве параметра,
// по переданному названию находим имя макета в соответствии.
//
// Параметры:
//  НазваниеМакета - строка, название макета.
//
Процедура Печать(ИмяМакета, КоличествоЭкземпляров = 1, НаПринтер = Ложь) Экспорт
	
	Если ЭтоНовый() Тогда
		Предупреждение(НСтр("ru = 'Документ можно распечатать только после его записи'"));
		Возврат;
	ИначеЕсли Не УправлениеДопПравамиПользователей.РазрешитьПечатьНепроведенныхДокументов(Проведен) Тогда
		Предупреждение(НСтр("ru = Недостаточно полномочий для печати непроведенного документа!'"));
		Возврат;
	КонецЕсли;
	
	Если НЕ РаботаСДиалогами.ПроверитьМодифицированность(ЭтотОбъект) Тогда
		Возврат;
	КонецЕсли;
	
	// Получить экземпляр документа на печать
	Если ИмяМакета = "СерийныеНомера" Тогда
		
		ТабДокумент = УчетСерийныхНомеров.ПечатьСерийныхНомеров(Ссылка, "Товары");
		
	ИначеЕсли ТипЗнч(ИмяМакета) = Тип("ДвоичныеДанные") Тогда
		
		ТабДокумент = УниверсальныеМеханизмы.НапечататьВнешнююФорму(Ссылка, ИмяМакета);
		
		Если ТабДокумент = Неопределено Тогда
			Возврат;
		КонецЕсли; 
		
	КонецЕсли;
	
	УниверсальныеМеханизмы.НапечататьДокумент(ТабДокумент, КоличествоЭкземпляров, НаПринтер, ttk_ОбщегоНазначения.СформироватьЗаголовокДокумента(ЭтотОбъект), Ссылка);
	
КонецПроцедуры // Печать

// Возвращает доступные варианты печати документа
//
// Возвращаемое значение:
//  Структура, каждая строка которой соответствует одному из вариантов печати
//  
Функция ПолучитьСтруктуруПечатныхФорм() Экспорт
	
	СтруктПечатныхФорм = Новый Структура;
	СтруктПечатныхФорм.Вставить("СерийныеНомера", "Список серийных номеров");
	
	Возврат СтруктПечатныхФорм;
	
КонецФункции // ПолучитьСтруктуруПечатныхФорм()

#КонецЕсли


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ЗАПОЛНЕНИЯ ДОКУМЕНТА

Процедура ЗаполнитьПоРеализации()
	
	Если НЕ ЗначениеЗаполнено(ДокументРеализации) Тогда
		Возврат;
	КонецЕсли;
	
	Товары.Очистить();
	Услуги.Очистить();
	СерийныеНомера.Очистить();
	СоставНабора.Очистить();
	СерийныеНомераСоставНабора.Очистить();
	
	ИмяВидаДокумента = ДокументРеализации.Метаданные().Имя;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументРеализации);
	
	Текст =
	"ВЫБРАТЬ
	|	КорректировкаРеализацииТовары.НомерСтроки КАК НомерСтрокиОснования,
	|	КорректировкаРеализацииТовары.Количество,
	|	КорректировкаРеализацииТовары.Количество КАК КоличествоДоИзменения,
	|	КорректировкаРеализацииТовары.Цена,
	|	КорректировкаРеализацииТовары.Цена КАК ЦенаДоИзменения,
	|	КорректировкаРеализацииТовары.Сумма,
	|	КорректировкаРеализацииТовары.Сумма КАК СуммаДоИзменения,
	|	КорректировкаРеализацииТовары.СтавкаНДС,
	|	КорректировкаРеализацииТовары.СтавкаНДС КАК СтавкаНДСДоИзменения,
	|	КорректировкаРеализацииТовары.СуммаНДС,
	|	КорректировкаРеализацииТовары.СуммаНДС КАК СуммаНДСДоИзменения,
	|	""Товары"" КАК ТЧ,";
	
	Если ИмяВидаДокумента = "КорректировкаРеализации" Тогда
		Текст = Текст + "
		|	КорректировкаРеализацииТовары.КоличествоДоКорректировки,
		|	КорректировкаРеализацииТовары.ЦенаДоКорректировки,
		|	КорректировкаРеализацииТовары.СуммаДоКорректировки,
		|	КорректировкаРеализацииТовары.СуммаНДСДоКорректировки,";
	Иначе
		Текст = Текст + "
		|	0 КАК КоличествоДоКорректировки,
		|	0 КАК ЦенаДоКорректировки,
		|	0 КАК СуммаДоКорректировки,
		|	0 КАК СуммаНДСДоКорректировки,";
	КонецЕсли;
	
	Текст = Текст + "
	|	ИСТИНА КАК ЕстьВДокументеРеализации,
	|	NULL КАК Содержание,
	|	NULL КАК СодержаниеДоИзменения
	|ИЗ
	|	Документ."+ИмяВидаДокумента+".Товары КАК КорректировкаРеализацииТовары
	|ГДЕ
	|	КорректировкаРеализацииТовары.Ссылка = &Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииУслуги.НомерСтроки,
	|	КорректировкаРеализацииУслуги.Количество,
	|	КорректировкаРеализацииУслуги.Количество,
	|	КорректировкаРеализацииУслуги.Цена,
	|	КорректировкаРеализацииУслуги.Цена,
	|	КорректировкаРеализацииУслуги.Сумма,
	|	КорректировкаРеализацииУслуги.Сумма,
	|	КорректировкаРеализацииУслуги.СтавкаНДС,
	|	КорректировкаРеализацииУслуги.СтавкаНДС,
	|	КорректировкаРеализацииУслуги.СуммаНДС,
	|	КорректировкаРеализацииУслуги.СуммаНДС,
	|	""Услуги"",";
	
	Если ИмяВидаДокумента = "КорректировкаРеализации" Тогда
		Текст = Текст + "
		|	КорректировкаРеализацииУслуги.КоличествоДоКорректировки,
		|	КорректировкаРеализацииУслуги.ЦенаДоКорректировки,
		|	КорректировкаРеализацииУслуги.СуммаДоКорректировки,
		|	КорректировкаРеализацииУслуги.СуммаНДСДоКорректировки,";
	Иначе
		Текст = Текст + "
		|	0,
		|	0,
		|	0,
		|	0,";
	КонецЕсли;
	
	Текст = Текст + "
	|	ИСТИНА,
	|	КорректировкаРеализацииУслуги.Содержание,
	|	КорректировкаРеализацииУслуги.Содержание
	|ИЗ
	|	Документ."+ИмяВидаДокумента+".Услуги КАК КорректировкаРеализацииУслуги
	|ГДЕ
	|	КорректировкаРеализацииУслуги.Ссылка = &Ссылка";
	
	Запрос.Текст = Текст;
	Результат = Запрос.Выполнить().Выбрать();
	
	ДокументРеализацииТовары = ДокументРеализации.Товары;
	ДокументРеализацииУслуги = ДокументРеализации.Услуги;
	
	Пока Результат.Следующий() Цикл
		
		Если Результат.ТЧ = "Товары" Тогда
			СтрокаТоваров = Товары.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТоваров, ДокументРеализацииТовары[Результат.НомерСтрокиОснования - 1]);
			ЗаполнитьЗначенияСвойств(СтрокаТоваров, Результат);
		Иначе // услуги
			СтрокаУслуг = Услуги.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаУслуг, ДокументРеализацииУслуги[Результат.НомерСтрокиОснования - 1]);
			ЗаполнитьЗначенияСвойств(СтрокаУслуг, Результат);
		КонецЕсли;
		
	КонецЦикла;
	
	// Загрузим табличную часть СерийныеНомера
	СерийныеНомера.Загрузить(ДокументРеализации.СерийныеНомера.Выгрузить());
// +++ввв 12.01.2017 г.
	ЭтотОбъект.Склад = ДокументРеализации.Склад;
// ---ввв 12.01.2017 г.
	
КонецПроцедуры

Процедура ЗаполнитьПоАктуОказанияПроизводственныхУслуг()
	
	Товары.Очистить();
	Услуги.Очистить();
	СерийныеНомера.Очистить();
	СоставНабора.Очистить();
	СерийныеНомераСоставНабора.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", ДокументРеализации);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КорректировкаРеализацииУслуги.НомерСтроки КАК НомерСтрокиОснования,
	|	КорректировкаРеализацииУслуги.Количество,
	|	КорректировкаРеализацииУслуги.Количество КАК КоличествоДоИзменения,
	|	КорректировкаРеализацииУслуги.Цена,
	|	КорректировкаРеализацииУслуги.Цена КАК ЦенаДоИзменения,
	|	КорректировкаРеализацииУслуги.Сумма,
	|	КорректировкаРеализацииУслуги.Сумма КАК СуммаДоИзменения,
	|	КорректировкаРеализацииУслуги.СтавкаНДС,
	|	КорректировкаРеализацииУслуги.СтавкаНДС КАК СтавкаНДСДоИзменения,
	|	КорректировкаРеализацииУслуги.СуммаНДС,
	|	КорректировкаРеализацииУслуги.СуммаНДС КАК СуммаНДСДоИзменения,
	|	ИСТИНА КАК ЕстьВДокументеРеализации
	|ИЗ
	|	Документ.АктОбОказанииПроизводственныхУслуг.Услуги КАК КорректировкаРеализацииУслуги
	|ГДЕ
	|	КорректировкаРеализацииУслуги.Ссылка = &Ссылка";
	
	Результат = Запрос.Выполнить().Выбрать();
	
	ДокументРеализацииУслуги = ДокументРеализации.Услуги;
	
	Пока Результат.Следующий() Цикл
		СтрокаУслуг = Услуги.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаУслуг, ДокументРеализацииУслуги[Результат.НомерСтрокиОснования - 1]);
		ЗаполнитьЗначенияСвойств(СтрокаУслуг, Результат);		
	КонецЦикла;
	
КонецПроцедуры
    
Процедура ЗаполнитьЗаказыВТЧ()
	
	Если НЕ ПолучитьСвойстваЗаказаВТабличнойЧасти().ВидимостьЗаказа Тогда
		Возврат;
	КонецЕсли;	
	
	// В табличной части может быть только заказ покупателя, а в шапке реквизит заказ имеет составной тип
	ЗаказИзШапки = ?(ТипЗнч(Сделка) = Тип("ДокументСсылка.ЗаказПокупателя"), Сделка, Документы.ЗаказПокупателя.ПустаяСсылка());
	
	// Если заказ в табличной части не выбран, то заполним его заказом из шапки
	Для Каждого СтрокаТЧ Из Товары Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаТЧ.ЗаказПокупателя) И СтрокаТЧ.ЗаказПокупателя <> ЗаказИзШапки Тогда
			СтрокаТЧ.ЗаказПокупателя = ЗаказИзШапки;
		КонецЕсли;
	КонецЦикла;
	Для Каждого СтрокаТЧ Из Услуги Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаТЧ.ЗаказПокупателя) И СтрокаТЧ.ЗаказПокупателя <> ЗаказИзШапки Тогда
			СтрокаТЧ.ЗаказПокупателя = ЗаказИзШапки;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры //ЗаполнитьЗаказыВТЧ()

Процедура ЗаполнитьСкладыВТЧ()
	
	Если НЕ ПолучитьСвойстваСкладаВТабличнойЧасти().ВидимостьСклада Тогда
		Возврат;
	КонецЕсли;
	
	// Получим соответствие заказов из табличной части Товары и складов, указанных в этих заказах
	СоответствиеЗаказовИСкладов = Новый Соответствие;
	
	Если ПолучитьСвойстваЗаказаВТабличнойЧасти().ВидимостьЗаказа Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ЗаказПокупателя.Ссылка КАК Заказ,
		|	ЗаказПокупателя.СкладГруппа КАК Склад
		|ИЗ
		|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
		|ГДЕ
		|	ЗаказПокупателя.Ссылка В(&Заказы)";
		
		ТаблицаЗаказы = Товары.Выгрузить(, "ЗаказПокупателя");
		ТаблицаЗаказы.Свернуть("ЗаказПокупателя", "");
		
		Запрос.УстановитьПараметр("Заказы", ТаблицаЗаказы.ВыгрузитьКолонку("ЗаказПокупателя"));
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			СоответствиеЗаказовИСкладов.Вставить(Выборка.Заказ, Выборка.Склад);
		КонецЦикла;
		
	КонецЕсли;
	
	// Заполним реквизит склад в табличной части "Товары"
	Для Каждого СтрокаТЧ из Товары Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаТЧ.Склад) Тогда
			
			СкладИзЗаказа = СоответствиеЗаказовИСкладов.Получить(СтрокаТЧ.ЗаказПокупателя);
			
			Если ЗначениеЗаполнено(СкладИзЗаказа) Тогда
				СтрокаТЧ.Склад = СкладИзЗаказа;
			Иначе
				СтрокаТЧ.Склад = Склад;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры //ЗаполнитьСкладыВТЧ()

Процедура ОбработатьСуммыДоКорректировки()
	
	ИсправлениеКорректировки =
		ЗначениеЗаполнено(ИсправляемыйДокументРеализации)
		И ТипЗнч(ИсправляемыйДокументРеализации) = Тип("ДокументСсылка.КорректировкаРеализации")
		И ИсправляемыйДокументРеализации.ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение;

	Если ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение Тогда
		
		Товары.ЗагрузитьКолонку(Товары.ВыгрузитьКолонку("КоличествоДоИзменения"), 	"КоличествоДоКорректировки");
		Товары.ЗагрузитьКолонку(Товары.ВыгрузитьКолонку("ЦенаДоИзменения"), 		"ЦенаДоКорректировки");
		Товары.ЗагрузитьКолонку(Товары.ВыгрузитьКолонку("СуммаДоИзменения"), 		"СуммаДоКорректировки");
		Товары.ЗагрузитьКолонку(Товары.ВыгрузитьКолонку("СуммаНДСДоИзменения"), 	"СуммаНДСДоКорректировки");
		
		Услуги.ЗагрузитьКолонку(Услуги.ВыгрузитьКолонку("КоличествоДоИзменения"), 	"КоличествоДоКорректировки");
		Услуги.ЗагрузитьКолонку(Услуги.ВыгрузитьКолонку("ЦенаДоИзменения"), 		"ЦенаДоКорректировки");
		Услуги.ЗагрузитьКолонку(Услуги.ВыгрузитьКолонку("СуммаДоИзменения"), 		"СуммаДоКорректировки");
		Услуги.ЗагрузитьКолонку(Услуги.ВыгрузитьКолонку("СуммаНДСДоИзменения"), 	"СуммаНДСДоКорректировки");
		
	ИначеЕсли НЕ ИсправлениеКорректировки Тогда
		
		Для Каждого СтрокаТЧ Из Товары Цикл
			СтрокаТЧ.КоличествоДоКорректировки 	= 0;
			СтрокаТЧ.ЦенаДоКорректировки 		= 0;
			СтрокаТЧ.СуммаДоКорректировки 		= 0;
			СтрокаТЧ.СуммаНДСДоКорректировки 	= 0;
		КонецЦикла;
		
		Для Каждого СтрокаТЧ Из Услуги Цикл
			СтрокаТЧ.КоличествоДоКорректировки 	= 0;
			СтрокаТЧ.ЦенаДоКорректировки 		= 0;
			СтрокаТЧ.СуммаДоКорректировки 		= 0;
			СтрокаТЧ.СуммаНДСДоКорректировки 	= 0;			
		КонецЦикла;
		
	КонецЕсли;		
	
	Если НЕ КорректироватьБУиНУ Тогда
		
		Отбор = Новый Структура("ЕстьВДокументеРеализации", Истина);
		
		СтрокиТовары = Товары.НайтиСтроки(Отбор);
		СтрокиУслуги = Услуги.НайтиСтроки(Отбор);
		
		Для Каждого СтрокаТЧ Из СтрокиТовары Цикл
			СтрокаТЧ.ЕстьВДокументеРеализации = Ложь;
		КонецЦикла;
		
		Для Каждого СтрокаТЧ Из СтрокиУслуги Цикл
			СтрокаТЧ.ЕстьВДокументеРеализации = Ложь;
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБРАБОТКИ ШАПКИ ДОКУМЕНТА ДЛЯ ПРОВЕДЕНИЯ

// Процедура формирует структуру шапки документа и дополнительных полей.
//
Процедура ПодготовитьСтруктуруШапкиДокумента(Заголовок, СтруктураШапкиДокумента, РежимПроведения = Неопределено,Отказ = Ложь) Экспорт
	
	// Дерево значений, содержащее имена необходимых полей в запросе по шапке.
	Перем ДеревоПолейЗапросаПоШапке;
	
	Если РежимПроведения = Неопределено Тогда
		РежимПроведения = РежимПроведенияДокумента.Неоперативный;
	КонецЕсли;
	
	СтруктураШапкиДокумента = ОбщегоНазначения.СформироватьСтруктуруШапкиДокумента(ЭтотОбъект);
	
	ОбщегоНазначенияКлиентСервер.ДобавитьВСтруктуруШапкиСведенияОСчетахРасчетов(ЭтотОбъект, СтруктураШапкиДокумента);
	
	СтруктураШапкиДокумента.Вставить("СкладВТабличнойЧасти", 				 ПолучитьСвойстваСкладаВТабличнойЧасти().ВидимостьСклада);
	СтруктураШапкиДокумента.Вставить("ЗаказВТабличнойЧасти", 				 ПолучитьСвойстваЗаказаВТабличнойЧасти().ВидимостьЗаказа);
	СтруктураШапкиДокумента.Вставить("ОтгрузкаБезПереходаПравСобственности", Ложь);
	
	// Настоящие значения следуюшщих свойств запишутся в структуру при подготовке параметров учетной политики
	СтруктураШапкиДокумента.Вставить("НачислятьНДСПоОтгрузке",				 Ложь);
    СтруктураШапкиДокумента.Вставить("МоментОпределенияНалоговойБазыНДС", 	 Перечисления.МоментыОпределенияНалоговойБазыНДС.ПоОтгрузке);
	
    СтруктураШапкиДокумента.Вставить("мДокументРеализацииСсылка", 	 		 мДокументРеализацииСсылка);
	
	// Заполним по шапке документа дерево параметров, нужных при проведении.
	ДеревоПолейЗапросаПоШапке      = УправлениеЗапасами.СформироватьДеревоПолейЗапросаПоШапке();
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "ВедениеВзаиморасчетов"                      , "ВедениеВзаиморасчетов");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "РасчетыВУсловныхЕдиницах"                   , "РасчетыВУсловныхЕдиницах");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "ВалютаВзаиморасчетов"                       , "ВалютаВзаиморасчетов");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "Организация"                                , "ДоговорОрганизация");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "ВидДоговора"                                , "ВидДоговора");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "ВестиПоДокументамРасчетовСКонтрагентом"     , "ВестиПоДокументамРасчетовСКонтрагентом");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Организация"		 , "ОтражатьВРегламентированномУчете"           , "ОтражатьВРегламентированномУчете");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Склад"               , "ВидСклада"                                  , "ВидСклада");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "УчетнаяПолитика"     , "ВестиПартионныйУчетПоСкладам"               , "ВестиПартионныйУчетПоСкладам");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "УчетнаяПолитика"     , "ВедениеУчетаПоПроектам"                     , "ВедениеУчетаПоПроектам");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "ДоговорКонтрагента"  , "ОбособленныйУчетТоваровПоЗаказамПокупателей", "ОбособленныйУчетТоваровПоЗаказамПокупателей");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "УчетнаяПолитика"     , "ВестиУчетТоваровОрганизацийВРазрезеСкладов" , "ВестиУчетТоваровОрганизацийВРазрезеСкладов");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Константы"			 , "ВалютаУправленческогоУчета"                 , "ВалютаУправленческогоУчета");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Константы"			 , "КурсВалютыУправленческогоУчета"             , "КурсВалютыУправленческогоУчета");
	УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "НастройкаСпособовВеденияУправленческогоПартионногоУчета"			, "СпособВеденияПартионногоУчетаПоОрганизации", "СпособВеденияПартионногоУчетаПоОрганизации");
	
	// Если сделка - Заказ покупателя, то надо цену для проведения пересчитать в валюту заказа.
	Если ЗначениеЗаполнено(Сделка) И ТипЗнч(Сделка) <> Тип("ДокументСсылка.СчетНаОплатуПокупателю") Тогда
		УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Сделка"          , "ВалютаДокумента"                            , "ВалютаЗаказа");
		УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Сделка"          , "КурсВзаиморасчетов"                         , "КурсВзаиморасчетовЗаказа");
		УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Сделка"          , "КратностьВзаиморасчетов"                    , "КратностьВзаиморасчетовЗаказа");
		УправлениеЗапасами.ДобавитьСтрокуВДеревоПолейЗапросаПоШапке(ДеревоПолейЗапросаПоШапке, "Сделка"          , "ВидОперации"                                , "СделкаВидОперации");
	КонецЕсли;
	
	УправлениеВзаиморасчетами.ДополнитьДеревоПолейЗапросаПоШапкеДляКонтроляВзаиморасчетовУпр(ДеревоПолейЗапросаПоШапке, РежимПроведения);
	
	// Сформируем запрос на дополнительные параметры, нужные при проведении, по данным шапки документа
	СтруктураШапкиДокумента = УправлениеЗапасами.СформироватьЗапросПоДеревуПолей(ЭтотОбъект, ДеревоПолейЗапросаПоШапке, СтруктураШапкиДокумента, мВалютаРегламентированногоУчета);
	
	// Если надо пересчитывать цену в валюту заказа. то в структуре должна быть заполнена валюта заказа.
	ВалютаЗаказа = Неопределено;
	НужнаЦенаЗаказа = Ложь;
	Если СтруктураШапкиДокумента.Свойство("ВалютаЗаказа", ВалютаЗаказа) Тогда
		НужнаЦенаЗаказа = Истина;
		Если ВалютаЗаказа = мВалютаРегламентированногоУчета Тогда
			КурсЗаказа      = 1;
			КратностьЗаказа = 1;
		Иначе //ВалютаЗаказа = ВалютаВзаиморасчетов
			КурсЗаказа      = СтруктураШапкиДокумента.КурсВзаиморасчетовЗаказа;
			КратностьЗаказа = СтруктураШапкиДокумента.КратностьВзаиморасчетовЗаказа;
		КонецЕсли;
		СтруктураШапкиДокумента.Вставить("КурсЗаказа"     , КурсЗаказа);
		СтруктураШапкиДокумента.Вставить("КратностьЗаказа", КратностьЗаказа);
	КонецЕсли;
	
	СтруктураШапкиДокумента.Вставить("НужнаЦенаЗаказа", НужнаЦенаЗаказа);
	СтруктураШапкиДокумента.Вставить("РежимПроведения", РежимПроведения);
	
	// Дополним шапку исходным исправляемым документом реализации
	СтруктураШапкиДокумента.Вставить("ИсходныйИсправляемыйДокументРеализации", УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Истина));
	
	мСтруктураПараметровВзаиморасчетов.Вставить("ПроводитьПоВзаиморасчетам", СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
	
	////////////////////////////////////////////////////////////////////
	// Сведения о корректируемом документе
	ДокументРеализацииСсылка = УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Истина);
	СтруктураШапкиДокумента.Вставить("ДокументРеализацииДата", 	?(ЗначениеЗаполнено(ДокументРеализацииСсылка),ДокументРеализацииСсылка.Дата, Дата));
	СтруктураШапкиДокумента.Вставить("ДокументРеализацииСсылка", 	ДокументРеализацииСсылка);
    СтруктураШапкиДокумента.Вставить("ДокументОснование",	 		ДокументРеализации);
	СтруктураШапкиДокумента.Вставить("ДокументОснованиеДата",	 	?(ЗначениеЗаполнено(ДокументРеализации), ДокументРеализации.Дата, Дата));
	СтруктураШапкиДокумента.Вставить("абс_СубконтоБУ2",абс_ПериодОтражения);
	СтруктураШапкиДокумента.Вставить("абс_ПериодОтражения",абс_ПериодОтражения);
	//АБС ВСТАВКА №38359 НАЧАЛО «17 февраля 2014 г.», Пополитов 	
	СтруктураШапкиДокумента.Вставить("абс_ПериодОтражения91",абс_ПериодОтражения91);
	//\\АБС ВСТАВКА №38359 КОНЕЦ
	// Заявка 18833
	врСуммаДокумента = УчетНДС.ПолучитьСуммуДокументаСНДС(ЭтотОбъект, "Товары")+УчетНДС.ПолучитьСуммуДокументаСНДС(ЭтотОбъект, "Услуги");
	врДокументРеализации = УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Истина);
	врСуммаИспровляемогоДокумента = ?(врДокументРеализации.Метаданные().ТабличныеЧасти.Найти("Товары") <> Неопределено, УчетНДС.ПолучитьСуммуДокументаСНДС(врДокументРеализации, "Товары"),0)
								+?(врДокументРеализации.Метаданные().ТабличныеЧасти.Найти("Услуги") <> Неопределено,УчетНДС.ПолучитьСуммуДокументаСНДС(врДокументРеализации, "Услуги"),0)
								+?(врДокументРеализации.Метаданные().ТабличныеЧасти.Найти("ТоварыИУслуги") <> Неопределено, УчетНДС.ПолучитьСуммуДокументаСНДС(врДокументРеализации, "ТоварыИУслуги"),0); 
	СтруктураШапкиДокумента.Вставить("абс_ОтражатьВТекущемПериоде", врСуммаДокумента - врСуммаИспровляемогоДокумента >= 0);
	//
	//АБС ВСТАВКА №37870 НАЧАЛО «27 января 2014 г.», Пополитов  				
	СтруктураШапкиДокумента.Вставить("абс_ОпределенияПризнакаДопЛистаДляКниги",абс_ОпределенияПризнакаДопЛистаДляКниги);	
	СтруктураШапкиДокумента.Вставить("абс_ЗаписьДополнительногоЛиста",абс_ЗаписьДополнительногоЛиста);
	СтруктураШапкиДокумента.Вставить("абс_КорректируемыйПериод",абс_КорректируемыйПериод);
	//\\АБС ВСТАВКА №37870 КОНЕЦ	
	
КонецПроцедуры // ПодготовитьСтруктуруШапкиДокумента()

// Процедура определяет параметры учетной политики
//
Процедура ПодготовитьПараметрыУчетнойПолитики(СтруктураШапкиДокумента, Отказ)
	
	мПараметрыПартионногоУчета = глЗначениеПеременной("ПараметрыПартионногоУчета");
	
	// упр.
	УчетнаяПолитикаУпр = ttk_ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиУпр(Дата);
    Если НЕ ЗначениеЗаполнено(УчетнаяПолитикаУпр) Тогда
		Отказ = Истина;
	КонецЕсли;
	
	// регл.
	Если СтруктураШапкиДокумента.ОтражатьВРегламентированномУчете
	 И (СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете ИЛИ СтруктураШапкиДокумента.ОтражатьВНалоговомУчете) Тогда
	 
		мУчетнаяПолитикаРегл = ttk_ОбщегоНазначения.ПолучитьПараметрыУчетнойПолитикиРегл(Дата, Организация);
    	Если НЕ ЗначениеЗаполнено(мУчетнаяПолитикаРегл) Тогда
			Отказ = Истина;
		Иначе
			СтруктураШапкиДокумента.Вставить("НачислятьНДСПоОтгрузке", 			  мУчетнаяПолитикаРегл.НачислятьНДСПоОтгрузке);
			СтруктураШапкиДокумента.Вставить("МоментОпределенияНалоговойБазыНДС", мУчетнаяПолитикаРегл.МоментОпределенияНалоговойБазыНДС);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ПодготовитьПараметрыУчетнойПолитики()

// Проверяет правильность заполнения шапки документа.
// Если какой-то из реквизитов шапки, влияющий на проведение, не заполнен или
// заполнен не корректно, то выставляется флаг отказа в проведении.
// Проверяется также правильность заполнения реквизитов ссылочных полей документа.
// Проверка выполняется по объекту и по выборке из результата запроса по шапке.
//
// Параметры: 
//  СтруктураШапкиДокумента - выборка из результата запроса по шапке документа,
//  Отказ                   - флаг отказа в проведении,
//  Заголовок               - строка, заголовок сообщения об ошибке проведения.
//
Процедура ПроверитьЗаполнениеШапки(СтруктураШапкиДокумента, Заголовок, Отказ)
	
	// Укажем, что надо проверить:
	СтруктураОбязательныхПолей = Новый Структура("Организация, ДокументРеализации");
	
	// Теперь вызовем общую процедуру проверки.
	ЗаполнениеДокументов.ПроверитьЗаполнениеШапкиДокумента(ЭтотОбъект, СтруктураОбязательныхПолей, Отказ, Заголовок);
	
	//Организация в документе должна совпадать с организацией, указанной в договоре взаиморасчетов.
	УправлениеВзаиморасчетами.ПроверитьСоответствиеОрганизацииДоговоруВзаиморасчетов(Организация, ДоговорКонтрагента, СтруктураШапкиДокумента.ДоговорОрганизация, Отказ, Заголовок);
	
	// Проверка шапки упр.
	Если СтруктураШапкиДокумента.ВидСклада = Перечисления.ВидыСкладов.НТТ Тогда
		ttk_ОбщегоНазначения.СообщитьОбОшибке("Документ не может осуществлять реализацию с неавтоматизированной торговой точки!", Отказ, Заголовок);
	КонецЕсли;
	
	// Проверка шапки регл.
	Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		
		СтруктураОбязательныхПолей = Новый Структура;
		Если НЕ СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
			СтруктураОбязательныхПолей.Вставить("СчетУчетаРасчетовСКонтрагентом");
		КонецЕсли;
	
		ОбщегоНазначенияКлиентСервер.ПроверитьЗаполнениеВычисляемыхРеквизитовШапки(ЭтотОбъект, СтруктураОбязательныхПолей, СтруктураШапкиДокумента, Отказ, Заголовок);
		
	КонецЕсли;
	
КонецПроцедуры // ПроверитьЗаполнениеШапки()


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ПРОВЕРКИ ТАБЛИЧНЫХ ЧАСТЕЙ ДОКУМЕНТА

// Проверяет правильность заполнения строк табличной части "Товары".
//
// Параметры:
// Параметры: 
//  ТаблицаПоТоварам        - таблица значений, содержащая данные для проведения и проверки ТЧ Товары
//  СтруктураШапкиДокумента - выборка из результата запроса по шапке документа,
//  Отказ                   - флаг отказа в проведении.
//  Заголовок               - строка, заголовок сообщения об ошибке проведения.
//
Процедура ПроверитьЗаполнениеТабличнойЧастиТовары(ТаблицаПоТоварам, СтруктураШапкиДокумента, Заголовок, Отказ)
	
	// Укажем, что надо проверить
	СтруктураОбязательныхПолей = Новый Структура;
	
	Если ПолучитьСвойстваСкладаВТабличнойЧасти().ОбязательноеЗаполнениеСклада Тогда
		СтруктураОбязательныхПолей.Вставить("Склад");
	КонецЕсли;
	Если ПолучитьСвойстваЗаказаВТабличнойЧасти().ОбязательноеЗаполнениеЗаказа Тогда
		СтруктураОбязательныхПолей.Вставить("ЗаказПокупателя");
	КонецЕсли;
	Если ПолучитьСвойстваЗаказаВТабличнойЧасти().ОбязательноеЗаполнениеСпособаСписания Тогда
		СтруктураОбязательныхПолей.Вставить("СпособСписанияОстаткаТоваров");
	КонецЕсли;
	
	// Теперь вызовем общую процедуру проверки.
	ЗаполнениеДокументов.ПроверитьЗаполнениеТабличнойЧасти(ЭтотОбъект, "Товары", СтруктураОбязательныхПолей, Отказ, Заголовок);

	УправлениеЗапасами.ПроверитьЧтоСкладНеНТТ(	 ЭтотОбъект, "Товары", ТаблицаПоТоварам, Отказ, Заголовок, "ВидСклада");
	УправлениеЗапасами.ПроверитьЧтоНетУслуг(	 ЭтотОбъект, "Товары", ТаблицаПоТоварам, Отказ, Заголовок);
	УправлениеЗапасами.ПроверитьЧтоНетНаборов(	 ЭтотОбъект, "Товары", ТаблицаПоТоварам, Отказ, Заголовок);
	УправлениеЗапасами.ПроверитьЧтоНетКомплектов(ЭтотОбъект, "Товары", ТаблицаПоТоварам, Отказ, Заголовок);
	
	// Реквизиты Заказов "Организация", "Контрагент", "Договор контрагента" должны совпадать с реквизитами из шапки.
	УправлениеЗаказами.ПроверитьРеквизитыЗаказов(ЭтотОбъект, "Товары", "ЗаказПокупателя", Отказ, Заголовок);
	
	УчетСерийныхНомеров.ПроверитьКоличествоСерийныхНомеровВДокументе(ЭтотОбъект, "Товары", Заголовок);
	
КонецПроцедуры // ПроверитьЗаполнениеТабличнойЧастиТовары()

// Проверяет правильность заполнения строк табличной части "Товары".
//
// Параметры:
// Параметры: 
//  ТаблицаПоТоварам        - таблица значений, содержащая данные для проведения и проверки ТЧ Товары
//  СтруктураШапкиДокумента - выборка из результата запроса по шапке документа,
//  Отказ                   - флаг отказа в проведении.
//  Заголовок               - строка, заголовок сообщения об ошибке проведения.
//
Процедура ПроверитьЗаполнениеТабличнойЧастиУслуги(ТаблицаПоУслугам, СтруктураШапкиДокумента, Заголовок, Отказ)
	
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомитентом Тогда
		Если ТаблицаПоУслугам.Количество() > 0 Тогда
			Сообщить("Документ передачи на комиссию не может содержать услуг!");
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	// Укажем, что надо проверить
	СтруктураОбязательныхПолей = Новый Структура;
	//СтруктураОбязательныхПолей.Вставить("Сумма");
	
	Если ПолучитьСвойстваЗаказаВТабличнойЧасти().ОбязательноеЗаполнениеЗаказа Тогда
		СтруктураОбязательныхПолей.Вставить("ЗаказПокупателя");
	КонецЕсли;
	
	УправлениеЗапасами.КорректировкаСтруктурыОбязательныхПолей(СтруктураОбязательныхПолей, СтруктураШапкиДокумента.ВидСклада);
	
	// Теперь вызовем общую процедуру проверки.
	ЗаполнениеДокументов.ПроверитьЗаполнениеТабличнойЧасти(ЭтотОбъект, "Услуги", СтруктураОбязательныхПолей, Отказ, Заголовок);
	
	УправлениеЗапасами.ПроверитьЧтоНетТоваров(	 ЭтотОбъект, "Услуги", ТаблицаПоУслугам, Отказ, Заголовок);
	УправлениеЗапасами.ПроверитьЧтоНетНаборов(	 ЭтотОбъект, "Услуги", ТаблицаПоУслугам, Отказ, Заголовок);
	УправлениеЗапасами.ПроверитьЧтоНетКомплектов(ЭтотОбъект, "Услуги", ТаблицаПоУслугам, Отказ, Заголовок);
	
	// Реквизиты Заказов "Организация", "Контрагент", "Договор контрагента" должны совпадать с реквизитами из шапки.
	УправлениеЗаказами.ПроверитьРеквизитыЗаказов(ЭтотОбъект, "Услуги", "ЗаказПокупателя", Отказ, Заголовок);
	
КонецПроцедуры // ПроверитьЗаполнениеТабличнойЧастиУслуги()

// Выполняет проверки,которые нужны только для регл. учета
//
Процедура ПроверитьЗаполнениеТабличнойЧастиТоварыРегл(ТаблицаПоТоварам, СтруктураШапкиДокумента, Заголовок, Отказ)
	
	Если НЕ СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете
	 ИЛИ СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		Возврат;
	КонецЕсли;
	
	КэшПоСчетам 	= Новый Соответствие;
	СтрокаСообщения = "Указанные счета доходов и расходов относятся к разным видам деятельности!";
	
	Для Каждого СтрокаТЧ Из ТаблицаПоТоварам Цикл
		
		Если ЗначениеЗаполнено(СтрокаТЧ.СчетДоходовБУ) И ЗначениеЗаполнено(СтрокаТЧ.СчетРасходовБУ) Тогда
			
			СчетДоходовБУОтноситсяКДеятельностиЕНВД = КэшПоСчетам[СтрокаТЧ.СчетДоходовБУ];
			Если СчетДоходовБУОтноситсяКДеятельностиЕНВД = Неопределено Тогда
				СчетДоходовБУОтноситсяКДеятельностиЕНВД = НалоговыйУчетУСН.ОтноситсяКДеятельностиЕНВД(СтрокаТЧ.СчетДоходовБУ);
				КэшПоСчетам.Вставить(СтрокаТЧ.СчетДоходовБУ, СчетДоходовБУОтноситсяКДеятельностиЕНВД);
			КонецЕсли;
			
			СчетРасходовБУОтноситсяКДеятельностиЕНВД = КэшПоСчетам[СтрокаТЧ.СчетРасходовБУ];
			Если СчетРасходовБУОтноситсяКДеятельностиЕНВД = Неопределено Тогда
				СчетРасходовБУОтноситсяКДеятельностиЕНВД = НалоговыйУчетУСН.ОтноситсяКДеятельностиЕНВД(СтрокаТЧ.СчетРасходовБУ);
				КэшПоСчетам.Вставить(СтрокаТЧ.СчетРасходовБУ, СчетРасходовБУОтноситсяКДеятельностиЕНВД);
			КонецЕсли;					
			
			Если СчетДоходовБУОтноситсяКДеятельностиЕНВД <> СчетРасходовБУОтноситсяКДеятельностиЕНВД Тогда
				ttk_ОбщегоНазначения.СообщитьОбОшибке(
					"В строке номер """+ СокрЛП(СтрокаТЧ.НомерСтроки) + """ табличной части ""Товары"": " + СтрокаСообщения,
					Отказ,
					Заголовок);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ПОДГОТОВКИ ТАБЛИЦ ДОКУМЕНТА ДЛЯ ПРОВЕДЕНИЯ

// Процедура формирует таблицы документа.
//
Процедура ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам) Экспорт
	
	// Получим необходимые данные для проведения и проверки заполнения данные по табличной части "Товары".
	СтруктураПолей = Новый Структура; 
	//АБС ВСТАВКА НАЧАЛО
	СтруктураПолей.Вставить("Контрагент"                          , "Ссылка.Контрагент");
	СтруктураПолей.Вставить("абс_Контрагент"                      , "Ссылка.абс_Контрагент");
	СтруктураПолей.Вставить("ДоговорКонтрагента"                  , "Ссылка.ДоговорКонтрагента");
	СтруктураПолей.Вставить("абс_ДоговорКонтрагента"              , "Ссылка.абс_ДоговорКонтрагента");
	СтруктураПолей.Вставить("ЦенаДоИзменения"                     , "ЦенаДоИзменения");
	СтруктураПолей.Вставить("СуммаДоИзменения"                    , "СуммаДоИзменения");
	СтруктураПолей.Вставить("СуммаНДСДоИзменения"                 , "СуммаНДСДоИзменения");
	СтруктураПолей.Вставить("СтавкаНДСДоИзменения"                , "СтавкаНДСДоИзменения");
	СтруктураПолей.Вставить("абс_СубконтоБУ2"	                  , "абс_СубконтоБУ2");
	//\\АБС ВСТАВКА КОНЕЦ
	СтруктураПолей.Вставить("Номенклатура"                        , "Номенклатура");
	СтруктураПолей.Вставить("ТипНоменклатуры"                     , "Номенклатура.ВидНоменклатуры.ТипНоменклатуры");
	СтруктураПолей.Вставить("ХарактеристикаНоменклатуры"          , "ХарактеристикаНоменклатуры");
	СтруктураПолей.Вставить("СерияНоменклатуры"                   , "СерияНоменклатуры");
	СтруктураПолей.Вставить("Качество"                            , "Качество");
	СтруктураПолей.Вставить("ЕдиницаИзмерения"                    , "ЕдиницаИзмерения");
	СтруктураПолей.Вставить("Цена"                                , "Цена");
	СтруктураПолей.Вставить("Услуга"                              , "Номенклатура.Услуга");
	СтруктураПолей.Вставить("Набор"                               , "Номенклатура.Набор");
	СтруктураПолей.Вставить("Комплект"                            , "Номенклатура.Комплект");
	СтруктураПолей.Вставить("СтавкаНДС"                           , "СтавкаНДС");
	СтруктураПолей.Вставить("Склад"                               , "Склад");
	СтруктураПолей.Вставить("ВидСклада"                           , "Склад.ВидСклада");
	СтруктураПолей.Вставить("ЗаказПокупателя"                     , "ЗаказПокупателя");
	СтруктураПолей.Вставить("ПринадлежностьНоменклатуры"     	  , "ПринадлежностьНоменклатуры");
	СтруктураПолей.Вставить("СпособСписанияОстаткаТоваров"		  , "СпособСписанияОстаткаТоваров");
	СтруктураПолей.Вставить("КлючСтроки"                          , "КлючСтроки");
	
	// Дополним полями, нужными для регл. учета
	СтруктураПолей.Вставить("НоменклатурнаяГруппа"				  , "Номенклатура.НоменклатурнаяГруппа");
	СтруктураПолей.Вставить("СчетУчетаБУ"        				  , "СчетУчетаБУ");
	СтруктураПолей.Вставить("ПринятыеСчетУчетаБУ"				  , "ПринятыеСчетУчетаБУ");
	СтруктураПолей.Вставить("ПринятыеСчетУчетаНУ"				  , "ПринятыеСчетУчетаНУ");
	СтруктураПолей.Вставить("СчетУчетаНУ"        				  , "СчетУчетаНУ");
	СтруктураПолей.Вставить("СчетДоходовБУ"      				  , "СчетДоходовБУ");
	СтруктураПолей.Вставить("СубконтоБУ"         				  , "СубконтоБУ");
	СтруктураПолей.Вставить("СчетДоходовНУ"      				  , "СчетДоходовНУ");
	СтруктураПолей.Вставить("СубконтоНУ"         				  , "СубконтоНУ");
	СтруктураПолей.Вставить("СчетРасходовБУ"     				  , "СчетРасходовБУ");
	СтруктураПолей.Вставить("СчетРасходовНУ"     				  , "СчетРасходовНУ");
	СтруктураПолей.Вставить("ПереданныеПринятыеБУ"   			  , "ПереданныеПринятыеБУ");
	СтруктураПолей.Вставить("ПереданныеПринятыеНУ"   			  , "ПереданныеПринятыеНУ");
	СтруктураПолей.Вставить("ПереданныеСобственныеБУ"			  , "ПереданныеСобственныеБУ");
	СтруктураПолей.Вставить("ПереданныеСобственныеНУ"			  , "ПереданныеСобственныеНУ");
	
	СтруктураПолей.Вставить("НДСИтоговый"						  , "СуммаНДС");
	СтруктураПолей.Вставить("НДСДоИзм"					  		  , "СуммаНДСДоИзменения");
	СтруктураПолей.Вставить("НДСДоКорр"					  		  , "СуммаНДСДоКорректировки");
// +++ввв 20.03.2017 г.
	СтруктураПолей.Вставить("абс_ЛьготаПоНДС"                     , "абс_ЛьготаПоНДС");
// ---ввв 20.03.2017 г.
		
	// Сформируем структуру сложных полей
	СтруктураСложныхПолей = Новый Структура;
	СтруктураСложныхПолей.Вставить("Количество"					  , "(Количество - КоличествоДоИзменения) * Коэффициент / Номенклатура.ЕдиницаХраненияОстатков.Коэффициент");
	СтруктураСложныхПолей.Вставить("КоличествоДоИзменения"        , "КоличествоДоИзменения * Коэффициент / Номенклатура.ЕдиницаХраненияОстатков.Коэффициент");
	СтруктураСложныхПолей.Вставить("КоличествоДок"                , "Количество - КоличествоДоИзменения");
	СтруктураСложныхПолей.Вставить("КоличествоВЕдиницахДокумента" , "Количество - КоличествоДоИзменения");
	СтруктураСложныхПолей.Вставить("Сумма"						  , "Сумма - СуммаДоИзменения");
	СтруктураСложныхПолей.Вставить("СуммаДок"					  , "Сумма - СуммаДоИзменения");
	СтруктураСложныхПолей.Вставить("НДС"						  , "СуммаНДС - СуммаНДСДоИзменения");
	СтруктураСложныхПолей.Вставить("НДСДок"						  , "СуммаНДС - СуммаНДСДоИзменения");
	
	Если СтруктураШапкиДокумента.ВедениеУчетаПоПроектам И НЕ ЗначениеЗаполнено(Проект) Тогда
		СтруктураСложныхПолей.Вставить("Проект"					  , "ПроектыНоменклатуры.Проект");
	КонецЕсли;
	
	// Подготовим таблицу товаров для проведения.
	РезультатЗапросаПоТоварам = УправлениеЗапасами.СформироватьЗапросПоТабличнойЧасти(ЭтотОбъект, "Товары", СтруктураПолей, СтруктураСложныхПолей);
	ТаблицаПоТоварам 		  = ПодготовитьТаблицуТоваров(РезультатЗапросаПоТоварам, СтруктураШапкиДокумента);
	
	// Получим необходимые данные для проведения и проверки заполнения данные по табличной части "Услуги".
	СтруктураПолей = Новый Структура;
	//АБС ВСТАВКА НАЧАЛО
	СтруктураПолей.Вставить("Контрагент"           , "Ссылка.Контрагент");
	СтруктураПолей.Вставить("абс_Контрагент"       , "Ссылка.абс_Контрагент");
	СтруктураПолей.Вставить("ДоговорКонтрагента"   , "Ссылка.ДоговорКонтрагента");
	СтруктураПолей.Вставить("абс_ДоговорКонтрагента", "Ссылка.абс_ДоговорКонтрагента");
	СтруктураПолей.Вставить("ЦенаДоИзменения"      , "ЦенаДоИзменения");
	СтруктураПолей.Вставить("СуммаДоИзменения"     , "СуммаДоИзменения");
	СтруктураПолей.Вставить("КоличествоДоИзменения", "КоличествоДоИзменения");
	СтруктураПолей.Вставить("СуммаНДСДоИзменения"  , "СуммаНДСДоИзменения");
	СтруктураПолей.Вставить("СтавкаНДСДоИзменения" , "СтавкаНДСДоИзменения");
	СтруктураПолей.Вставить("абс_СубконтоБУ2"	   , "абс_СубконтоБУ2");
	//\\АБС ВСТАВКА КОНЕЦ	
	СтруктураПолей.Вставить("Номенклатура"        , "Номенклатура");
	СтруктураПолей.Вставить("НоменклатурнаяГруппа", "Номенклатура.НоменклатурнаяГруппа");
	СтруктураПолей.Вставить("Цена"                , "Цена");
	СтруктураПолей.Вставить("Услуга"              , "Номенклатура.Услуга");
	СтруктураПолей.Вставить("Набор"               , "Номенклатура.Набор");
	СтруктураПолей.Вставить("Комплект"            , "Номенклатура.Комплект");
	СтруктураПолей.Вставить("СтавкаНДС"           , "СтавкаНДС");
	СтруктураПолей.Вставить("СчетДоходовБУ"       , "СчетДоходовБУ");
	СтруктураПолей.Вставить("СубконтоБУ"          , "СубконтоБУ");
	СтруктураПолей.Вставить("СчетДоходовНУ"       , "СчетДоходовНУ");
	СтруктураПолей.Вставить("СубконтоНУ"          , "СубконтоНУ");
	СтруктураПолей.Вставить("СчетРасходовБУ"      , "СчетРасходовБУ");
	СтруктураПолей.Вставить("СчетРасходовНУ"      , "СчетРасходовНУ");
	СтруктураПолей.Вставить("ЗаказПокупателя"     , "ЗаказПокупателя");
	СтруктураПолей.Вставить("Содержание"          , "Содержание");
	
	СтруктураПолей.Вставить("НДСИтоговый"		  , "СуммаНДС");
	СтруктураПолей.Вставить("НДСДоИзм"			  , "СуммаНДСДоИзменения");
	СтруктураПолей.Вставить("НДСДоКорр"			  , "СуммаНДСДоКорректировки");	
// +++ввв 20.03.2017 г.
	СтруктураПолей.Вставить("абс_ЛьготаПоНДС"	  , "абс_ЛьготаПоНДС");
// ---ввв 20.03.2017 г.
	
	// Сформируем структуру сложных полей
	СтруктураСложныхПолей = Новый Структура;
	СтруктураСложныхПолей.Вставить("Количество"   , "Количество - КоличествоДоИзменения");
	СтруктураСложныхПолей.Вставить("Сумма"		  , "Сумма - СуммаДоИзменения");
	СтруктураСложныхПолей.Вставить("НДС"		  , "СуммаНДС - СуммаНДСДоИзменения");
	
	Если СтруктураШапкиДокумента.ВедениеУчетаПоПроектам И НЕ ЗначениеЗаполнено(Проект) Тогда
		СтруктураСложныхПолей.Вставить("Проект"	  , "ПроектыНоменклатуры.Проект");
	КонецЕсли;
	
	// Подготовим таблицу услуг для проведения.
	РезультатЗапросаПоУслугам = УправлениеЗапасами.СформироватьЗапросПоТабличнойЧасти(ЭтотОбъект, "Услуги", СтруктураПолей, СтруктураСложныхПолей);
	ТаблицаПоУслугам 		  = ПодготовитьТаблицуУслуг(РезультатЗапросаПоУслугам, СтруктураШапкиДокумента);
	
	//Заполним счета учета
	СчетаУчетаВДокументах.ЗаполнитьПриПроведенииСчетаУчетаТабличнойЧасти("Товары", ТаблицаПоТоварам, СтруктураШапкиДокумента);
	СчетаУчетаВДокументах.ЗаполнитьПриПроведенииСчетаУчетаТабличнойЧасти("Услуги", ТаблицаПоУслугам, СтруктураШапкиДокумента);
	
	БухгалтерскийУчетРасчетовСКонтрагентами.ПодготовкаТаблицыЗначенийДляЦелейПриобретенияИРеализации(ТаблицаПоТоварам, СтруктураШапкиДокумента, Истина);
	БухгалтерскийУчетРасчетовСКонтрагентами.ПодготовкаТаблицыЗначенийДляЦелейПриобретенияИРеализации(ТаблицаПоУслугам, СтруктураШапкиДокумента, Истина);
	
	//Алгоритм еще не дописан!!!!
	//Для Каждого Строка Из ТаблицаПоУслугам Цикл
	//	
	//	Строка.абс_Контрагент = ?(ЗначениеЗаполнено(Строка.абс_Контрагент),Строка.абс_Контрагент,Строка.Контрагент);
	//	Строка.абс_ДоговорКонтрагента = ?(ЗначениеЗаполнено(Строка.абс_ДоговорКонтрагента),Строка.абс_ДоговорКонтрагента,Строка.ДоговорКонтрагента);
	//	
	//КонецЦикла;	
	//Для Каждого Строка Из ТаблицаПоТоварам Цикл
	//	
	//	Строка.абс_Контрагент = ?(ЗначениеЗаполнено(Строка.абс_Контрагент),Строка.абс_Контрагент,Строка.Контрагент);
	//	Строка.абс_ДоговорКонтрагента = ?(ЗначениеЗаполнено(Строка.абс_ДоговорКонтрагента),Строка.абс_ДоговорКонтрагента,Строка.ДоговорКонтрагента);
	//	
	//КонецЦикла;	
	           	
КонецПроцедуры // СформироватьТаблицыДокумента()


// Выгружает результат запроса в табличную часть, добавляет ей необходимые колонки для проведения.
//
// Параметры: 
//  РезультатЗапросаПоТоварам - результат запроса по табличной части "Товары",
//  СтруктураШапкиДокумента   - выборка по результату запроса по шапке документа.
//
// Возвращаемое значение:
//  Сформированная таблица значений.
//
Функция ПодготовитьТаблицуТоваров(РезультатЗапросаПоТоварам, СтруктураШапкиДокумента)
	
	ТаблицаТоваров = РезультатЗапросаПоТоварам.Выгрузить();
	
	ТаблицаТоваров.Колонки.Добавить("СуммаБезНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
// +++ввв 15.09.2016 г.	
	Если Найти(Строка(ТипЗнч(мДокументРеализацииСсылка)),"Документ расчетов с контрагентом (ручной учет)")=0 Тогда
		ТаблицаТоваров.Колонки.Добавить("ДокументПартии", Новый ОписаниеТипов("ДокументСсылка.РеализацияТоваровУслуг"));
	Иначе
		ТаблицаТоваров.Колонки.Добавить("ДокументПартии", Новый ОписаниеТипов("ДокументСсылка.ДокументРасчетовСКонтрагентом"));
	КонецЕсли;
// ---ввв 15.09.2016 г.	
	Для Каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		СтрокаТаблицы.СуммаБезНДС = СтрокаТаблицы.Сумма - ?(УчитыватьНДС И СуммаВключаетНДС, СтрокаТаблицы.НДС, 0);
		СтрокаТаблицы.ДокументПартии = мДокументРеализацииСсылка;
	КонецЦикла;
	
	// Вызываем отдельные процедуры подготовки для регл. и упр. учета
	ПодготовитьТаблицуТоваровРегл(ТаблицаТоваров, СтруктураШапкиДокумента);
	ПодготовитьТаблицуТоваровУпр(ТаблицаТоваров,  СтруктураШапкиДокумента);
	
	Возврат ТаблицаТоваров;
	
КонецФункции // ПодготовитьТаблицуТоваров()

Процедура ПодготовитьТаблицуТоваровУпр(ТаблицаТоваров, СтруктураШапкиДокумента)
	
	ТаблицаТоваров.Колонки.Добавить("СуммаПродажная", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	
	ЕстьРозничныйСклад = УправлениеРозничнойТорговлей.ОпределитьНаличиеРозничногоСклада(ТаблицаТоваров, "Склад", "ВидСклада");
	
	Если ЕстьРозничныйСклад Тогда
		
		ТаблицаПоЦенам = УправлениеРозничнойТорговлей.СформироватьЗапросПоПродажнымЦенам(
			Дата,
			ТаблицаТоваров.ВыгрузитьКолонку("Склад"),
			ТаблицаТоваров.ВыгрузитьКолонку("Номенклатура")).Выгрузить();
		
		УправлениеРозничнойТорговлей.ЗаполнитьКолонкуСуммаПродажная(ТаблицаТоваров, ТаблицаПоЦенам, "ВидСклада");
		
	КонецЕсли;
	
	// Надо добавить колонки "СуммаБезНДС".
	ТаблицаТоваров.Колонки.Добавить("ЦенаВВалютеЗаказа"  , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаВзаиморасчетов", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТаблицаТоваров.Колонки.Добавить("Стоимость"          , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаУпр"           , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТаблицаТоваров.Колонки.Добавить("СтоимостьБезСкидок" , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТаблицаТоваров.Колонки.Добавить("СуммаСНДСДок"       , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	ТаблицаТоваров.Колонки.Добавить("НДСУпр"             , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	
	
	// Надо заполнить новые колонки.
	Для Каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		
		СтрокаТаблицы.СуммаБезНДС = СтрокаТаблицы.Сумма - ?(УчитыватьНДС И СуммаВключаетНДС, СтрокаТаблицы.НДС, 0);
		
		// Считаем, что реализация выписывается с теми же флагами учета НДС, что и Заказ.
		Если СтруктураШапкиДокумента.НужнаЦенаЗаказа Тогда
			СтрокаТаблицы.ЦенаВВалютеЗаказа = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СтрокаТаблицы.Цена, 
				ВалютаДокумента, СтруктураШапкиДокумента.ВалютаЗаказа,
				СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсЗаказа,
				СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьЗаказа);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.Количество) Тогда
			СтрокаТаблицы.Количество = 0;
		КонецЕсли;
		
		СтрокаТаблицы.СтоимостьБезСкидок = СтрокаТаблицы.Цена * СтрокаТаблицы.КоличествоДок;
		
		Если УчитыватьНДС И НЕ СуммаВключаетНДС Тогда
			СтрокаТаблицы.СтоимостьБезСкидок = 
				СтрокаТаблицы.СтоимостьБезСкидок 
				+ УчетНДС.РассчитатьСуммуНДС(
					СтрокаТаблицы.СтоимостьБезСкидок, 
					УчитыватьНДС,
					СуммаВключаетНДС,
					УчетНДС.ПолучитьСтавкуНДС(СтрокаТаблицы.СтавкаНДС));
		КонецЕсли;
		
		СтрокаТаблицы.Стоимость 		  = СтрокаТаблицы.СуммаБезНДС + СтрокаТаблицы.НДС;
		СтрокаТаблицы.СуммаВзаиморасчетов = СтрокаТаблицы.СуммаБезНДС + СтрокаТаблицы.НДС;
		
		СтрокаТаблицы.СуммаУпр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаВзаиморасчетов, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		
		СтрокаТаблицы.СтоимостьБезСкидок = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СтоимостьБезСкидок, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		
		СтрокаТаблицы.СуммаВзаиморасчетов = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаВзаиморасчетов, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаВзаиморасчетов,
			СтруктураШапкиДокумента.КурсДокумента, КурсВзаиморасчетов,
			СтруктураШапкиДокумента.КратностьДокумента, КратностьВзаиморасчетов);
		
		СтрокаТаблицы.Стоимость    = СтрокаТаблицы.СуммаУпр;
		СтрокаТаблицы.СуммаСНДСДок = СтрокаТаблицы.СуммаДок + ?(УчитыватьНДС И НЕ СуммаВключаетНДС, СтрокаТаблицы.НДС, 0);
		
		// Суммы пересчитаем в валюту упр. учета
		СтрокаТаблицы.СуммаБезНДС = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаБезНДС, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		
		СтрокаТаблицы.НДСУпр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.НДС, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		
	КонецЦикла;
	
КонецПроцедуры // ПодготовитьТаблицуТоваровУпр()

Процедура ПодготовитьТаблицуТоваровРегл(ТаблицаТоваров, СтруктураШапкиДокумента)
	
	ТаблицаТоваров.Колонки.Добавить("СуммаРегл",        Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаТоваров.Колонки.Добавить("ПроводкаСумма",    Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаТоваров.Колонки.Добавить("ПроводкаСуммаНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	
	ВалютаРег = мВалютаРегламентированногоУчета;
	Данные    = МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаРег, Дата);
	
	// Надо заполнить новые колонки.
	Для каждого СтрокаТаблицы Из ТаблицаТоваров Цикл
		
		НДС   = СтрокаТаблицы.НДС;
		Сумма = СтрокаТаблицы.СуммаБезНДС;
		
		// Суммы пересчитаем в валюту упр. учета
		Если СтруктураШапкиДокумента.ВалютаДокумента = ВалютаРег Тогда
			СтрокаТаблицы.ПроводкаСумма    = Сумма;
			СтрокаТаблицы.ПроводкаСуммаНДС = НДС;
			СтрокаТаблицы.СуммаРегл        = Сумма + НДС;
		Иначе
			
			СуммаДок = СтрокаТаблицы.Сумма + ?(СуммаВключаетНДС, 0, СтрокаТаблицы.НДС);
			
			СтрокаТаблицы.СуммаРегл = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СуммаДок, 
				СтруктураШапкиДокумента.ВалютаДокумента, ВалютаРег,
				СтруктураШапкиДокумента.КурсДокумента, Данные.Курс,
				СтруктураШапкиДокумента.КратностьДокумента, Данные.Кратность);
			
			НДС   = УчетНДС.РассчитатьСуммуНДС(СтрокаТаблицы.СуммаРегл, 
						УчитыватьНДС, СуммаВключаетНДС,
						УчетНДС.ПолучитьСтавкуНДС(СтрокаТаблицы.СтавкаНДС));
			Сумма = СтрокаТаблицы.СуммаРегл - НДС;
			
			СтрокаТаблицы.ПроводкаСумма    = Сумма;
			СтрокаТаблицы.ПроводкаСуммаНДС = НДС;
			
			СтрокаТаблицы.НДСИтоговый = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СтрокаТаблицы.НДСИтоговый, 
				СтруктураШапкиДокумента.ВалютаДокумента, ВалютаРег,
				СтруктураШапкиДокумента.КурсДокумента, Данные.Курс,
				СтруктураШапкиДокумента.КратностьДокумента, Данные.Кратность);
			СтрокаТаблицы.НДСДоИзм = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СтрокаТаблицы.НДСДоИзм, 
				СтруктураШапкиДокумента.ВалютаДокумента, ВалютаРег,
				СтруктураШапкиДокумента.КурсДокумента, Данные.Курс,
				СтруктураШапкиДокумента.КратностьДокумента, Данные.Кратность);
			СтрокаТаблицы.НДСДоКорр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СтрокаТаблицы.НДСДоКорр, 
				СтруктураШапкиДокумента.ВалютаДокумента, ВалютаРег,
				СтруктураШапкиДокумента.КурсДокумента, Данные.Курс,
				СтруктураШапкиДокумента.КратностьДокумента, Данные.Кратность);
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // ПодготовитьТаблицуТоваровРегл()


// Выгружает результат запроса в табличную часть, добавляет ей необходимые колонки для проведения.
//
// Параметры: 
//  РезультатЗапросаПоТоварам - результат запроса по табличной части "Товары",
//  СтруктураШапкиДокумента   - выборка по результату запроса по шапке документа.
//
// Возвращаемое значение:
//  Сформированная таблица значений.
//
Функция ПодготовитьТаблицуУслуг(РезультатЗапросаПоУслугам, СтруктураШапкиДокумента)
	
	ТаблицаУслуг = РезультатЗапросаПоУслугам.Выгрузить();
	
	ТаблицаУслуг.Колонки.Добавить("СуммаБезНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	//АБС ВСТАВКА НАЧАЛО
	ТаблицаУслуг.Колонки.Добавить("врСуммаБезНДС", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	//\\АБС ВСТАВКА КОНЕЦ

	Для Каждого СтрокаТаблицы Из ТаблицаУслуг Цикл
		СтрокаТаблицы.СуммаБезНДС = СтрокаТаблицы.Сумма - ?(УчитыватьНДС И СуммаВключаетНДС, СтрокаТаблицы.НДС, 0);
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСуммаБезНДС = СтрокаТаблицы.СуммаДоИзменения - ?(УчитыватьНДС И СуммаВключаетНДС, СтрокаТаблицы.СуммаНДСДоИзменения, 0);
		//\\АБС ВСТАВКА КОНЕЦ   
	КонецЦикла;
	
	// Вызываем отдельные процедуры подготовки для регл. и упр. учета
	ПодготовитьТаблицуУслугРегл(ТаблицаУслуг, СтруктураШапкиДокумента);
	ПодготовитьТаблицуУслугУпр(ТаблицаУслуг, СтруктураШапкиДокумента);
	
	Возврат ТаблицаУслуг;
	
КонецФункции // ПодготовитьТаблицуУслуг()

Процедура ПодготовитьТаблицуУслугУпр(ТаблицаУслуг, СтруктураШапкиДокумента)
	
	// Надо добавить нужные при проведении колонки.
	ТаблицаУслуг.Колонки.Добавить("ЦенаВВалютеЗаказа"   , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("СуммаВзаиморасчетов" , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("Стоимость"           , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("СуммаУпр"            , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("СтоимостьБезСкидок"  , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("НДСУпр"              , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	
	//АБС ВСТАВКА НАЧАЛО
	ТаблицаУслуг.Колонки.Добавить("врЦенаВВалютеЗаказа"   , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("врСуммаВзаиморасчетов" , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("врСтоимость"           , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("врСуммаУпр"            , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("врСтоимостьБезСкидок"  , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаУслуг.Колонки.Добавить("врНДСУпр"              , Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	//\\АБС ВСТАВКА КОНЕЦ
	
	// Надо заполнить новые колонки.
	Для Каждого СтрокаТаблицы Из ТаблицаУслуг Цикл
		
		// Счиатем, что реализация выписывается с теми же флагами учета НДС, что и Заказ.
		Если СтруктураШапкиДокумента.НужнаЦенаЗаказа Тогда
			СтрокаТаблицы.ЦенаВВалютеЗаказа = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СтрокаТаблицы.Цена, 
				ВалютаДокумента, СтруктураШапкиДокумента.ВалютаЗаказа,
				СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсЗаказа,
				СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьЗаказа);
			//АБС ВСТАВКА НАЧАЛО	
			СтрокаТаблицы.врЦенаВВалютеЗаказа = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СтрокаТаблицы.ЦенаДоИзменения, 
				ВалютаДокумента, СтруктураШапкиДокумента.ВалютаЗаказа,
				СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсЗаказа,
				СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьЗаказа);
			//\\АБС ВСТАВКА КОНЕЦ	
		КонецЕсли;
		
		СтрокаТаблицы.СтоимостьБезСкидок = СтрокаТаблицы.Цена * СтрокаТаблицы.Количество;
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСтоимостьБезСкидок = СтрокаТаблицы.ЦенаДоИзменения * СтрокаТаблицы.КоличествоДоИзменения;
		//\\АБС ВСТАВКА КОНЕЦ
		
		Если УчитыватьНДС И НЕ СуммаВключаетНДС Тогда
			СтрокаТаблицы.СтоимостьБезСкидок =
				СтрокаТаблицы.СтоимостьБезСкидок 
				+ УчетНДС.РассчитатьСуммуНДС(
					СтрокаТаблицы.СтоимостьБезСкидок,
					УчитыватьНДС,
					СуммаВключаетНДС,
					УчетНДС.ПолучитьСтавкуНДС(СтрокаТаблицы.СтавкаНДС));
			//АБС ВСТАВКА НАЧАЛО
			СтрокаТаблицы.врСтоимостьБезСкидок =
				СтрокаТаблицы.врСтоимостьБезСкидок 
				+ УчетНДС.РассчитатьСуммуНДС(
					СтрокаТаблицы.врСтоимостьБезСкидок,
					УчитыватьНДС,
					СуммаВключаетНДС,
					УчетНДС.ПолучитьСтавкуНДС(СтрокаТаблицы.СтавкаНДСДоИзменения));
			//\\АБС ВСТАВКА КОНЕЦ
		КонецЕсли;
		
		СтрокаТаблицы.Стоимость = СтрокаТаблицы.СуммаБезНДС + СтрокаТаблицы.НДС;
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСтоимость = СтрокаТаблицы.врСуммаБезНДС + СтрокаТаблицы.СуммаНДСДоИзменения;
		//\\АБС ВСТАВКА КОНЕЦ
		
		СтрокаТаблицы.СтоимостьБезСкидок = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СтоимостьБезСкидок, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
			
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСтоимостьБезСкидок = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.врСтоимостьБезСкидок, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//\\АБС ВСТАВКА КОНЕЦ

		СтрокаТаблицы.СуммаВзаиморасчетов = СтрокаТаблицы.СуммаБезНДС + СтрокаТаблицы.НДС;
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСуммаВзаиморасчетов = СтрокаТаблицы.врСуммаБезНДС + СтрокаТаблицы.СуммаНДСДоИзменения;
		//\\АБС ВСТАВКА КОНЕЦ

		СтрокаТаблицы.СуммаУпр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаВзаиморасчетов, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСуммаУпр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.врСуммаВзаиморасчетов, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//\\АБС ВСТАВКА КОНЕЦ
		
		СтрокаТаблицы.СуммаВзаиморасчетов = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаВзаиморасчетов, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаВзаиморасчетов,
			СтруктураШапкиДокумента.КурсДокумента, КурсВзаиморасчетов,
			СтруктураШапкиДокумента.КратностьДокумента, КратностьВзаиморасчетов);
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСуммаВзаиморасчетов = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.врСуммаВзаиморасчетов, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаВзаиморасчетов,
			СтруктураШапкиДокумента.КурсДокумента, КурсВзаиморасчетов,
			СтруктураШапкиДокумента.КратностьДокумента, КратностьВзаиморасчетов);
		//\\АБС ВСТАВКА КОНЕЦ
		
		// Суммы пересчитаем в валюту упр. учета
		СтрокаТаблицы.СуммаБезНДС = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаБезНДС, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСуммаБезНДС = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.врСуммаБезНДС, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//\\АБС ВСТАВКА КОНЕЦ
		
		СтрокаТаблицы.НДСУпр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.НДС, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врНДСУпр = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.СуммаНДСДоИзменения, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//\\АБС ВСТАВКА КОНЕЦ
		
		СтрокаТаблицы.Стоимость = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.Стоимость, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//АБС ВСТАВКА НАЧАЛО
		СтрокаТаблицы.врСтоимость = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
			СтрокаТаблицы.врСтоимость, 
			ВалютаДокумента, СтруктураШапкиДокумента.ВалютаУправленческогоУчета, 
			СтруктураШапкиДокумента.КурсДокумента, СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета, 
			СтруктураШапкиДокумента.КратностьДокумента, СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
		//\\АБС ВСТАВКА КОНЕЦ
		
	КонецЦикла;
	
КонецПроцедуры // ПодготовитьТаблицуУслугУпр()

Процедура ПодготовитьТаблицуУслугРегл(ТаблицаУслуг, СтруктураШапкиДокумента)
	
	ТаблицаУслуг.Колонки.Добавить("СуммаРегл", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	//АБС ВСТАВКА НАЧАЛО
	ТаблицаУслуг.Колонки.Добавить("врСуммаРегл", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	//\\АБС ВСТАВКА КОНЕЦ
	ВалютаРег = мВалютаРегламентированногоУчета;
	Данные    = МодульВалютногоУчета.ПолучитьКурсВалюты(ВалютаРег, Дата);
	
	// Надо заполнить новые колонки.
	Для Каждого СтрокаТаблицы Из ТаблицаУслуг Цикл
		
		НДС   = СтрокаТаблицы.НДС;
		Сумма = СтрокаТаблицы.СуммаБезНДС;
		
		// Суммы пересчитаем в валюту упр. учета
		Если СтруктураШапкиДокумента.ВалютаДокумента = ВалютаРег Тогда
			
			СтрокаТаблицы.СуммаРегл  = Сумма + НДС;
			//АБС ВСТАВКА НАЧАЛО
			СтрокаТаблицы.врСуммаРегл  = СтрокаТаблицы.врСуммаБезНДС + СтрокаТаблицы.СуммаНДСДоИзменения;
			//\\АБС ВСТАВКА КОНЕЦ
			
		Иначе
			
			СуммаДок = СтрокаТаблицы.Сумма + ?(СуммаВключаетНДС, 0, СтрокаТаблицы.НДС);
			
			СтрокаТаблицы.СуммаРегл = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				СуммаДок, 
				СтруктураШапкиДокумента.ВалютаДокумента, ВалютаРег,
				СтруктураШапкиДокумента.КурсДокумента, Данные.Курс,
				СтруктураШапкиДокумента.КратностьДокумента,Данные.Кратность);
			//АБС ВСТАВКА НАЧАЛО	
			врСуммаДок = СтрокаТаблицы.врСуммаБезНДС + ?(СуммаВключаетНДС, 0, СтрокаТаблицы.СуммаНДСДоИзменения);  			
			СтрокаТаблицы.врСуммаРегл = МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(
				врСуммаДок, 
				СтруктураШапкиДокумента.ВалютаДокумента, ВалютаРег,
				СтруктураШапкиДокумента.КурсДокумента, Данные.Курс,
				СтруктураШапкиДокумента.КратностьДокумента,Данные.Кратность);				
			//\\АБС ВСТАВКА КОНЕЦ
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // ПодготовитьТаблицуУслугРегл()


// Функция возвращает таблицу значений, содержащую строки, 
// в которых заполнено значение хотя бы в одной из проверяемых колонок
// 
// Параметры:
// 	ИсходнаяТаблица - ТаблицаЗначений -  таблица, из которой необходимо отобрать строки
// 	СписокКолонокДляПроверки - Строка - Список колонок для проверки заполнения значений
// 
// Возвращаемое значение:
// 	Результат - ТаблицаЗначений - результат отбора
//
Функция ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ИсходнаяТаблица, СписокКолонокДляПроверки)
	
	Результат = ИсходнаяТаблица.СкопироватьКолонки();
	
	КолонкиДляПроверки = Новый Структура(СписокКолонокДляПроверки);
	
	Для Каждого СтрокаТаблицы Из ИсходнаяТаблица Цикл
		
		Для Каждого Колонка Из КолонкиДляПроверки Цикл
			
			Если ИсходнаяТаблица.Колонки.Найти(Колонка.Ключ) <> Неопределено 
			 И ЗначениеЗаполнено(СтрокаТаблицы[Колонка.Ключ]) Тогда
				
				// Значение в колонке заполнено. Копируем строку в таблицу Результат
				НоваяСтрока = Результат.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТаблицы);
				  
				Прервать;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции


////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ ОБЕСПЕЧЕНИЯ ПРОВЕДЕНИЯ ДОКУМЕНТА

// По результату запроса по шапке документа формируем движения по регистрам.
//
// Параметры: 
//  РежимПроведения           - режим проведения документа (оперативный или неоперативный),
//  СтруктураШапкиДокумента   - выборка из результата запроса по шапке документа,
//  ТаблицаПоТоварам          - таблица значений, содержащая данные для проведения и проверки ТЧ Товары,
//  ТаблицаПоУслугам          - таблица значений, содержащая данные для проведения и проверки ТЧ "Услуги",
//  Отказ                     - флаг отказа в проведении,
//  Заголовок                 - строка, заголовок сообщения об ошибке проведения.
//
Процедура ДвиженияПоРегистрам(РежимПроведения, СтруктураШапкиДокумента, 
				ТаблицаПоТоварам, ТаблицаПоУслугам, ТаблицаПоВзаиморасчетам, ТаблицаПоРасчетам, ТаблицаТоваровДляУчетаЗатрат, Заголовок, Отказ)
				
	//АБС ВСТАВКА Фролов
	// Не делаем движения в статусах обработки инициатором
	Если абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.Подготовка ИЛИ
		 абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.СогласованиеОФК ИЛИ
		 абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.УточнениеБухгалтерией ИЛИ
		 абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.УточнениеОФК ИЛИ 
		 абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.Отказ ИЛИ
		 абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.Отмена ИЛИ
		 абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.ОбработкаБухгалтером Тогда
		 
		Возврат;
	КонецЕсли;	
	//АБС ВСТАВКА Фролов КОНЕЦ					
				
	ТаблицаПоКомплектам = УправлениеЗапасами.СформироватьТаблицуКомплектующих(ТаблицаПоТоварам, ЭтотОбъект);
	СчетаУчетаВДокументах.ЗаполнитьИПроверитьЗаполнениеСчетовУчетаТабличнойЧасти("СоставНабора", ТаблицаПоКомплектам, СтруктураШапкиДокумента, Отказ, Заголовок);
	
	ДвиженияПоРегистрамУпр(РежимПроведения, СтруктураШапкиДокумента,
		ТаблицаПоТоварам, ТаблицаПоКомплектам, ТаблицаПоУслугам, ТаблицаПоВзаиморасчетам, ТаблицаПоРасчетам, Отказ, Заголовок);
	
	ДвиженияПоРегиструТоварыОрганизаций(РежимПроведения, СтруктураШапкиДокумента, ТаблицаПоКомплектам, ТаблицаПоУслугам, Отказ, Заголовок);
	
	ДвиженияПоРегистрамОперативныхВзаиморасчетов(РежимПроведения, ТаблицаПоВзаиморасчетам, Отказ, Заголовок, СтруктураШапкиДокумента);
	
	ДвиженияПоРегиструСписанныеТовары(СтруктураШапкиДокумента, ТаблицаПоКомплектам, Отказ, Заголовок);
	
	Если ТаблицаПоКомплектам.Количество() > 0
	 И (НЕ мИспользоватьРасширеннуюАналитику
	 	ИЛИ мДатаНачалаИспользованияРасширеннойАналитики > СтруктураШапкиДокумента.Дата) Тогда
		УправлениеЗапасами.ЗарегистрироватьДокументВПоследовательностяхПартионногоУчета(ЭтотОбъект, Дата, СтруктураШапкиДокумента.Организация,ОтражатьВУправленческомУчете,СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете,СтруктураШапкиДокумента.ОтражатьВНалоговомУчете,СтруктураШапкиДокумента.СпособВеденияПартионногоУчетаПоОрганизации);
	КонецЕсли;
	
	// Проводки формируются и в модуле документа, и при списании партий
	Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете
	 И мПараметрыПартионногоУчета.СписыватьПартииПриПроведенииДокументовБух Тогда
		Движения.Хозрасчетный.Записать();
	КонецЕсли;
	Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете
	 И мПараметрыПартионногоУчета.СписыватьПартииПриПроведенииДокументовНал Тогда
		Движения.Налоговый.Записать();
	КонецЕсли;
	
	УправлениеЗапасамиПартионныйУчет.ДвижениеПартийТоваров(Ссылка, Движения.СписанныеТовары.Выгрузить());
	
	ДвиженияПоРегистрамРегл(РежимПроведения, СтруктураШапкиДокумента, 
		ТаблицаПоТоварам, ТаблицаПоУслугам, ТаблицаПоВзаиморасчетам, ТаблицаТоваровДляУчетаЗатрат, Отказ, Заголовок);
	
	Если ТаблицаПоКомплектам.Найти(Перечисления.ТипыНоменклатуры.Комплект, "ТипНоменклатуры") <> Неопределено Тогда
		ДополнительныеСвойства.СтруктураТабличныхЧастей.Вставить("ТаблицаПоКомплектам", ТаблицаПоКомплектам);
	КонецЕсли;	
// +++ввв 20.03.2017 г.
	ПодчиненныйСФ = УчетНДС.НайтиПодчиненныйСчетФактуру(Ссылка, "СчетФактураВыданный");
	
	//АБС+ Тупиков 13953
	ТаблицаДвижений = Движения.Хозрасчетный;
	ТаблицаДвижений.Прочитать();
	ТЗ = ТаблицаДвижений.Выгрузить();
	//АБС- Тупиков 13953
	
	Для Каждого СтрокаУслуга Из ТаблицаПоУслугам Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаУслуга.абс_ЛьготаПоНДС) Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		ДвижениеЛьготы = Движения.абс_ЛьготаПоНДС.Добавить();		
		
		ДвижениеЛьготы.Период 				= СтруктураШапкиДокумента.Дата;
		ДвижениеЛьготы.Регистратор 			= СтруктураШапкиДокумента.Ссылка;
		
		ДвижениеЛьготы.Организация			= СтруктураШапкиДокумента.Организация;
		ДвижениеЛьготы.Номенклатура 		= СтрокаУслуга.Номенклатура;
		ДвижениеЛьготы.Контрагент 			= СтруктураШапкиДокумента.Контрагент;
		ДвижениеЛьготы.ДоговорКонтрагента 	= СтруктураШапкиДокумента.ДоговорКонтрагента;
		ДвижениеЛьготы.ВидНДС				= Перечисления.абс_ВидыНДС.НДСПродажи;
		ДвижениеЛьготы.ЛьготаПоНДС			= СтрокаУслуга.абс_ЛьготаПоНДС;
		
		ДвижениеЛьготы.СуммаБезНДС			= СтрокаУслуга.СуммаБУБезНДС;
		ДвижениеЛьготы.НДС					= СтрокаУслуга.СуммаБУ - СтрокаУслуга.СуммаБУБезНДС;
		
		ДвижениеЛьготы.СчетФактура			= ПодчиненныйСФ;
		//++ Задача № 9662 Логинчев А.С.
		ДвижениеЛьготы.СтавкаНДС			= СтрокаУслуга.СтавкаНДС;
		//-- Задача № 9662 Логинчев А.С.
		
		//АБС+ Тупиков 13953
		//Корректировка выручки
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Содержание","Корректировка выручки по расчетам в валюте");
		ПараметрыОтбора.Вставить("СубконтоКт2", СтрокаУслуга.СубконтоБУ);
		МассивСтрок = ТЗ.НайтиСтроки(ПараметрыОтбора);
		Для х = 0 По МассивСтрок.Количество()-1 Цикл
			СтрокаМассива = МассивСтрок[х];
			ДвижениеЛьготы = Движения.абс_ЛьготаПоНДС.Добавить();	
			
			ДвижениеЛьготы.Период 				= СтруктураШапкиДокумента.Дата;
			ДвижениеЛьготы.Регистратор 			= СтруктураШапкиДокумента.Ссылка;
			
			ДвижениеЛьготы.Организация			= СтруктураШапкиДокумента.Организация;
			ДвижениеЛьготы.Номенклатура 		= СтрокаУслуга.Номенклатура;
			ДвижениеЛьготы.Контрагент 			= СтруктураШапкиДокумента.Контрагент;
			ДвижениеЛьготы.ДоговорКонтрагента 	= СтруктураШапкиДокумента.ДоговорКонтрагента;
			ДвижениеЛьготы.ВидНДС				= Перечисления.абс_ВидыНДС.НДСПродажи;
			ДвижениеЛьготы.ЛьготаПоНДС			= СтрокаУслуга.абс_ЛьготаПоНДС;
			
			ДвижениеЛьготы.СуммаБезНДС			= СтрокаМассива.Сумма;
			
			ДвижениеЛьготы.СчетФактура			= ПодчиненныйСФ;
			
			ДвижениеЛьготы.СтавкаНДС			= СтрокаУслуга.СтавкаНДС;
		КонецЦикла;
        //АБС- Тупиков
		
	КонецЦикла;
	
	Для Каждого СтрокаТовар Из ТаблицаПоТоварам Цикл
		
		Если НЕ ЗначениеЗаполнено(СтрокаТовар.абс_ЛьготаПоНДС) Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		ДвижениеЛьготы = Движения.абс_ЛьготаПоНДС.Добавить();		
		
		ДвижениеЛьготы.Период 				= СтруктураШапкиДокумента.Дата;
		ДвижениеЛьготы.Регистратор 			= СтруктураШапкиДокумента.Ссылка;
		
		ДвижениеЛьготы.Организация			= СтруктураШапкиДокумента.Организация;
		ДвижениеЛьготы.Номенклатура 		= СтрокаТовар.Номенклатура;
		ДвижениеЛьготы.Контрагент 			= СтруктураШапкиДокумента.Контрагент;
		ДвижениеЛьготы.ДоговорКонтрагента 	= СтруктураШапкиДокумента.ДоговорКонтрагента;
		ДвижениеЛьготы.ВидНДС				= Перечисления.абс_ВидыНДС.НДСПродажи;
		ДвижениеЛьготы.ЛьготаПоНДС			= СтрокаТовар.абс_ЛьготаПоНДС;
		
		ДвижениеЛьготы.СуммаБезНДС			= СтрокаТовар.ПроводкаСумма;
		ДвижениеЛьготы.НДС					= СтрокаТовар.ПроводкаСуммаНДС;
		
		ДвижениеЛьготы.СчетФактура			= ПодчиненныйСФ;	
		
		//АБС+ Тупиков 13953
		//Корректировка выручки
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("Содержание","Корректировка выручки по расчетам в валюте");
		ПараметрыОтбора.Вставить("СубконтоКт2", СтрокаТовар.СубконтоБУ);
		МассивСтрок = ТЗ.НайтиСтроки(ПараметрыОтбора);
		Для х = 0 По МассивСтрок.Количество()-1 Цикл
			СтрокаМассива = МассивСтрок[х];
			ДвижениеЛьготы = Движения.абс_ЛьготаПоНДС.Добавить();		
			
			ДвижениеЛьготы.Период 				= СтруктураШапкиДокумента.Дата;
			ДвижениеЛьготы.Регистратор 			= СтруктураШапкиДокумента.Ссылка;
			
			ДвижениеЛьготы.Организация			= СтруктураШапкиДокумента.Организация;
			ДвижениеЛьготы.Номенклатура 		= СтрокаТовар.Номенклатура;
			ДвижениеЛьготы.Контрагент 			= СтруктураШапкиДокумента.Контрагент;
			ДвижениеЛьготы.ДоговорКонтрагента 	= СтруктураШапкиДокумента.ДоговорКонтрагента;
			ДвижениеЛьготы.ВидНДС				= Перечисления.абс_ВидыНДС.НДСПродажи;
			ДвижениеЛьготы.ЛьготаПоНДС			= СтрокаТовар.абс_ЛьготаПоНДС;
			
			ДвижениеЛьготы.СуммаБезНДС			= СтрокаМассива.Сумма;
			
			ДвижениеЛьготы.СчетФактура			= ПодчиненныйСФ;
			
			ДвижениеЛьготы.СтавкаНДС			= СтрокаТовар.СтавкаНДС;
		КонецЦикла;
        //АБС- Тупиков
				
	КонецЦикла;
	
	Если Движения.абс_ЛьготаПоНДС.Количество() > 0 И НЕ ЗначениеЗаполнено(ПодчиненныйСФ) Тогда
		
		ttk_ОбщегоНазначения.СообщитьОбОшибке("Введите сч.фактуру и перепроведите документ. В противном случае Отчет ""Льготы по НДС"" покажет некорректные данные");
		
	КонецЕсли;
// ---ввв 20.03.2017 г.
	
КонецПроцедуры // ДвиженияПоРегистрам()

// ДВИЖЕНИЯ ПО РЕГИСТРАМ УПР. УЧЕТА

//АБС ВСТАВКА НАЧАЛО
Процедура ВыполнитьДвиженияПоРегистрамУпрВзаиморасчетов(ДокументОбъект, СтруктураШапкиДокумента, 
	                                                    СтруктураПараметров, ТаблицаПоВзаиморасчетам, ТаблицаПоРасчетам, 
	                                                    ВидДвижения, Отказ, Заголовок) Экспорт
													  
	// По регистру ВзаиморасчетыСКонтрагентами
	врТаблица  = ТаблицаПоВзаиморасчетам.Скопировать();
	врТаблица2 = ТаблицаПоВзаиморасчетам.Скопировать();

	ТабИменУслуги = Неопределено;
	Если врТаблица.Колонки.Найти("СуммаВзаиморасчетов") <> Неопределено Тогда
		врТаблица.Колонки.Удалить("СуммаВзаиморасчетов");
	КонецЕсли;	 
	Если врТаблица.Колонки.Найти("СуммаРегл") <> Неопределено Тогда
		врТаблица.Колонки.Удалить("СуммаРегл");
	КонецЕсли;
	Если врТаблица.Колонки.Найти("СуммаУпр") <> Неопределено Тогда
		врТаблица.Колонки.Удалить("СуммаУпр");
	КонецЕсли; 
	ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(врТаблица, ТабИменУслуги, "врСуммаВзаиморасчетов", "СуммаВзаиморасчетов");
	ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(врТаблица, ТабИменУслуги, "врСуммаРегл", "СуммаРегл");
	ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(врТаблица, ТабИменУслуги, "врСуммаУпр", "СуммаУпр");
		
	Если ТаблицаПоВзаиморасчетам.Количество() > 0 Тогда
		
		НаборДвиженийВзаиморасчеты = ДокументОбъект.Движения.ВзаиморасчетыСКонтрагентами;
		
		ТаблицаДвижений  = НаборДвиженийВзаиморасчеты.Выгрузить();
		ТаблицаДвижений2 = НаборДвиженийВзаиморасчеты.Выгрузить();
		
		Для каждого Строка Из врТаблица Цикл
			Строка.СуммаВзаиморасчетов = -Строка.СуммаВзаиморасчетов; 
			Строка.СуммаУпр            = -Строка.СуммаУпр;
			Строка.СуммаРегл           = -Строка.СуммаРегл;
		КонецЦикла;	
		
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(врТаблица, ТаблицаДвижений);
		
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.Контрагент, "Контрагент");
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.ДоговорКонтрагента, "ДоговорКонтрагента"); 
	    		
		НаборДвиженийВзаиморасчеты.мПериод          = СтруктураШапкиДокумента.Дата;
		НаборДвиженийВзаиморасчеты.мТаблицаДвижений = ТаблицаДвижений;
		
		// Проверка остатков
		ОтключитьКонтрольВзаиморасчетов = СтруктураШапкиДокумента.Свойство("ОтключитьКонтрольВзаиморасчетов") 
		                                И СтруктураШапкиДокумента.ОтключитьКонтрольВзаиморасчетов;
		Если НЕ ОтключитьКонтрольВзаиморасчетов Тогда
			НаборДвиженийВзаиморасчеты.КонтрольОстатков(ДокументОбъект, "ДокументыРасчетовСКонтрагентом", СтруктураШапкиДокумента, СтруктураПараметров, Отказ, Заголовок, СтруктураШапкиДокумента.РежимПроведения, "СуммаВзаиморасчетов");
		КонецЕсли;
		
		Если Не Отказ Тогда
			ttk_ОбщегоНазначения.ВыполнитьДвижениеПоРегистру(НаборДвиженийВзаиморасчеты, ВидДвижения);
		КонецЕсли;
		
		//===================		
		Для каждого Строка Из врТаблица2 Цикл
			Строка.СуммаВзаиморасчетов = Строка.СуммаВзаиморасчетов + Строка.врСуммаВзаиморасчетов; 
			Строка.СуммаУпр            = Строка.СуммаУпр  + Строка.врСуммаУпр;
			Строка.СуммаРегл           = Строка.СуммаРегл + Строка.врСуммаРегл;
		КонецЦикла;	
		
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(врТаблица2, ТаблицаДвижений2);             		
		ТаблицаДвижений2.ЗаполнитьЗначения(СтруктураШапкиДокумента.Организация, "Организация");
		ТаблицаДвижений2.ЗаполнитьЗначения(?(ЗначениеЗаполнено(СтруктураШапкиДокумента.абс_Контрагент),СтруктураШапкиДокумента.абс_Контрагент,СтруктураШапкиДокумента.Контрагент), "Контрагент");
		ТаблицаДвижений2.ЗаполнитьЗначения(?(ЗначениеЗаполнено(СтруктураШапкиДокумента.абс_ДоговорКонтрагента),СтруктураШапкиДокумента.абс_ДоговорКонтрагента,СтруктураШапкиДокумента.ДоговорКонтрагента), "ДоговорКонтрагента");
				
		НаборДвиженийВзаиморасчеты.мПериод          = СтруктураШапкиДокумента.Дата;
		НаборДвиженийВзаиморасчеты.мТаблицаДвижений = ТаблицаДвижений2;
		
		// Проверка остатков
		ОтключитьКонтрольВзаиморасчетов = СтруктураШапкиДокумента.Свойство("ОтключитьКонтрольВзаиморасчетов") 
		                                И СтруктураШапкиДокумента.ОтключитьКонтрольВзаиморасчетов;
		Если НЕ ОтключитьКонтрольВзаиморасчетов Тогда
			НаборДвиженийВзаиморасчеты.КонтрольОстатков(ДокументОбъект, "ДокументыРасчетовСКонтрагентом", СтруктураШапкиДокумента, СтруктураПараметров, Отказ, Заголовок, СтруктураШапкиДокумента.РежимПроведения, "СуммаВзаиморасчетов");
		КонецЕсли;
		
		Если Не Отказ Тогда			
			ttk_ОбщегоНазначения.ВыполнитьДвижениеПоРегистру(НаборДвиженийВзаиморасчеты, ВидДвижения);
		КонецЕсли;
		//-----------------
		
	КонецЕсли;
	
	// По регистру РасчетыСКонтрагентами
	врТаблица  = ТаблицаПоРасчетам.Скопировать();
	врТаблица2 = ТаблицаПоРасчетам.Скопировать();
	ТабИменУслуги = Неопределено;
	Если врТаблица.Колонки.Найти("СуммаВзаиморасчетов") <> Неопределено Тогда
		врТаблица.Колонки.Удалить("СуммаВзаиморасчетов");
	КонецЕсли;	 
	Если врТаблица.Колонки.Найти("СуммаРегл") <> Неопределено Тогда
		врТаблица.Колонки.Удалить("СуммаРегл");
	КонецЕсли;
	Если врТаблица.Колонки.Найти("СуммаУпр") <> Неопределено Тогда
		врТаблица.Колонки.Удалить("СуммаУпр");
	КонецЕсли; 
	ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(врТаблица, ТабИменУслуги, "врСуммаВзаиморасчетов", "СуммаВзаиморасчетов");
	ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(врТаблица, ТабИменУслуги, "врСуммаРегл", "СуммаРегл");
	ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(врТаблица, ТабИменУслуги, "врСуммаУпр", "СуммаУпр");
	 
	Если ТаблицаПоРасчетам.Количество() > 0 Тогда
		
		НаборДвиженийРасчеты = ДокументОбъект.Движения.РасчетыСКонтрагентами; 		
		ТаблицаДвижений  = НаборДвиженийРасчеты.Выгрузить();
		ТаблицаДвижений2 = НаборДвиженийРасчеты.Выгрузить();
		
		Для каждого Строка Из врТаблица Цикл
			Строка.СуммаВзаиморасчетов = -Строка.СуммаВзаиморасчетов; 
			Строка.СуммаУпр            = -Строка.СуммаУпр;
			Строка.СуммаРегл           = -Строка.СуммаРегл;
		КонецЦикла;		
		
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(врТаблица, ТаблицаДвижений);
		
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.Организация, "Организация");
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.Контрагент, "Контрагент");
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.ДоговорКонтрагента, "ДоговорКонтрагента");
		
		Если СтруктураПараметров.Свойство("ЭтоВозврат") И СтруктураПараметров.ЭтоВозврат Тогда
			ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.РасчетыВозврат.Возврат, "РасчетыВозврат");
		Иначе
			ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.РасчетыВозврат.Расчеты, "РасчетыВозврат");
		КонецЕсли;
		
		НаборДвиженийРасчеты.мПериод          = СтруктураШапкиДокумента.Дата;
		НаборДвиженийРасчеты.мТаблицаДвижений = ТаблицаДвижений;
		
		Если Не Отказ Тогда
			ttk_ОбщегоНазначения.ВыполнитьДвижениеПоРегистру(НаборДвиженийРасчеты, ВидДвижения);
		КонецЕсли;
		
		//==============		
		Для каждого Строка Из врТаблица2 Цикл
			Строка.СуммаВзаиморасчетов = Строка.СуммаВзаиморасчетов + Строка.врСуммаВзаиморасчетов; 
			Строка.СуммаУпр            = Строка.СуммаУпр  + Строка.врСуммаУпр;
			Строка.СуммаРегл           = Строка.СуммаРегл + Строка.врСуммаРегл;
		КонецЦикла;	
		
		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(врТаблица2, ТаблицаДвижений2);
		
		ТаблицаДвижений2.ЗаполнитьЗначения(СтруктураШапкиДокумента.Организация, "Организация");
		ТаблицаДвижений2.ЗаполнитьЗначения(?(ЗначениеЗаполнено(СтруктураШапкиДокумента.абс_Контрагент),СтруктураШапкиДокумента.абс_Контрагент,СтруктураШапкиДокумента.Контрагент), "Контрагент");
		ТаблицаДвижений2.ЗаполнитьЗначения(?(ЗначениеЗаполнено(СтруктураШапкиДокумента.абс_ДоговорКонтрагента),СтруктураШапкиДокумента.абс_ДоговорКонтрагента,СтруктураШапкиДокумента.ДоговорКонтрагента), "ДоговорКонтрагента");
		
		Если СтруктураПараметров.Свойство("ЭтоВозврат") И СтруктураПараметров.ЭтоВозврат Тогда
			ТаблицаДвижений2.ЗаполнитьЗначения(Перечисления.РасчетыВозврат.Возврат, "РасчетыВозврат");
		Иначе
			ТаблицаДвижений2.ЗаполнитьЗначения(Перечисления.РасчетыВозврат.Расчеты, "РасчетыВозврат");
		КонецЕсли;
		
		НаборДвиженийРасчеты.мПериод          = СтруктураШапкиДокумента.Дата;
		НаборДвиженийРасчеты.мТаблицаДвижений = ТаблицаДвижений2;
		
		Если Не Отказ Тогда
			ttk_ОбщегоНазначения.ВыполнитьДвижениеПоРегистру(НаборДвиженийРасчеты, ВидДвижения);
		КонецЕсли;		
		
	КонецЕсли;
	
КонецПроцедуры

// Движения документов поступления и реализации по регистру оперативных расчетов по документам
//
// Параметры
//  СтруктураШапкиДокумента		- <Структура> – Структура шапки документа
//  БазоваяТаблицаЗадолженности	– <ТаблицаЗначений> –  Таблица значений с информацией о задолженности по документу
//  ТаблицаРасчетовПоДокументам	– <ТаблицаЗначений> –  Таблица значений с информацией о зачитываемых авансах
//  ВидРасчетовПоОперации		- <ПеречислениеСсылка.ВидыРасчетовСКонтрагентами>
//  ВидДвиженияРасчетов			- <ПеречислениеСсылка.ВидыДвиженийБухгалтерии>
//	ДоговорКонтрагента			- <СправочникСсылка.ДоговорыКонтрагентов> - необязательный параметр. 
//									Для документов, отражающих движения по нескольким договорам
//  Движения 					- <Коллекция движений или структура с соответствующими свойствами>
//								– Движения документа по регистрам (в т.ч. по регистру оперативных взаиморасчетов)
//  Отказ						- <Булево> – признак ошибки при проведения для остановки проведения документа
//  Заголовок					- <Строка> – Представление заголовка документа для использования при формировании сообщения об ошибках
//
Процедура ОтражениеЗадолженностиВРегистреОперативныхРасчетовПоДокументам(СтруктураШапкиДокумента, ТаблицаВзаиморасчетов, ВидРасчетовСКонтрагентом, ВидДвижения, Движения, Отказ, Заголовок) Экспорт
	
	ВестиПоДокументамРасчетовСКонтрагентом = СтруктураШапкиДокумента.ВестиПоДокументамРасчетовСКонтрагентом;
	Если (НЕ ВестиПоДокументамРасчетовСКонтрагентом)
		ИЛИ (ТаблицаВзаиморасчетов.Количество() = 0)
		Тогда
		Возврат;
	КонецЕсли;
	
	ДатаДвижений       = СтруктураШапкиДокумента.Дата;
	//Признак отражения в УУ берем из ссылки, т.к. в СтруктураШапкиДокумента при отложенном проведении этот признак равен ЛОЖЬ
	УпрУчет            = ОтражатьВУправленческомУчете;
	ЗнакОстатка        = ?(ВидДвижения = ВидДвиженияНакопления.Приход, -1, 1);
	
	ЭтоВозврат = СтруктураШапкиДокумента.Свойство("ЭтоВозврат") И СтруктураШапкиДокумента.ЭтоВозврат;
	Множитель = ?(ЭтоВозврат, -1, 1);
	ЗнакОстатка = ЗнакОстатка * Множитель;
	
	НетСделкиВТаблице = ТаблицаВзаиморасчетов.Колонки.Найти("Сделка") = Неопределено;
	Если НетСделкиВТаблице Тогда
		ТаблицаВзаиморасчетов.Колонки.Добавить("Сделка", Новый ОписаниеТипов("ДокументСсылка.СчетНаОплатуПоставщика, ДокументСсылка.ЗаказПоставщику, ДокументСсылка.ЗаказПокупателя, 
		|ДокументСсылка.ЗаявкаНаРасходованиеСредств, ДокументСсылка.ПоступлениеТоваровУслуг, ДокументСсылка.СчетНаОплатуПокупателю,
		|ДокументСсылка.абс_СчетНаОплату, ДокументСсылка.ПлатежноеПоручениеИсходящее , Неопределено"), "Сделка");   			
	КонецЕсли;
	
	Для каждого СтрокаВзаиморасчетов Из ТаблицаВзаиморасчетов Цикл
		
		Если СтруктураШапкиДокумента.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоДоговоруВЦелом Тогда
			СтрокаВзаиморасчетов.Сделка = Неопределено;
		ИначеЕсли СтруктураШапкиДокумента.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоСчетам ИЛИ НетСделкиВТаблице Тогда
			СтрокаВзаиморасчетов.Сделка = СтруктураШапкиДокумента.Сделка;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(СтрокаВзаиморасчетов.ДокументРасчетовСКонтрагентом) Тогда
			СтрокаВзаиморасчетов.ДокументРасчетовСКонтрагентом = Ссылка;
		КонецЕсли;
		
	КонецЦикла;
	
	// Определение состояния расчетов по документам
	
	Запрос = Новый Запрос;
	МенеджерВремТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.МенеджерВременныхТаблиц = МенеджерВремТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Таб.Сделка,
	|	Таб.ДокументРасчетовСКонтрагентом
	|ПОМЕСТИТЬ ТаблицаВзаиморасчетов
	|ИЗ
	|	&ТаблицаВзаиморасчетов КАК Таб
	|ГДЕ 
	|	НЕ (Таб.ДокументРасчетовСКонтрагентом = &Ссылка)";
	
	Запрос.УстановитьПараметр("ТаблицаВзаиморасчетов", ТаблицаВзаиморасчетов);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.Выполнить();
	
	Если глЗначениеПеременной("ИспользоватьБлокировкуДанных") Тогда
						
		СтруктураПараметровБлокировки = Новый Структура(
			"ИмяТаблицы, ИсточникДанных, ИмяВременнойТаблицы", 
			"ВзаиморасчетыСКонтрагентамиПоДокументамРасчетов", МенеджерВремТаблиц, "ТаблицаВзаиморасчетов");
		СтруктураЗначенийБлокировки   = Новый Структура(
			"ВидРасчетовСКонтрагентом, Организация, ДоговорКонтрагента, УпрУчет", 
			ВидРасчетовСКонтрагентом, СтруктураШапкиДокумента.Организация, СтруктураШапкиДокумента.ДоговорКонтрагента, СтруктураШапкиДокумента.ОтражатьВУправленческомУчете);
		СтруктураИсточникаДанных      = Новый Структура(
			"Сделка, ДокументРасчетовСКонтрагентом", 
			"Сделка", "ДокументРасчетовСКонтрагентом");
		ОбщегоНазначения.УстановитьУправляемуюБлокировку(СтруктураПараметровБлокировки, СтруктураЗначенийБлокировки, СтруктураИсточникаДанных, Отказ, Заголовок);
		
	КонецЕсли;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ВзаиморасчетыПоДокументамОстатки.Организация,
	|	ВзаиморасчетыПоДокументамОстатки.Контрагент,
	|	ВзаиморасчетыПоДокументамОстатки.ДоговорКонтрагента,
	|	ВзаиморасчетыПоДокументамОстатки.Сделка,
	|	ВзаиморасчетыПоДокументамОстатки.ДокументРасчетовСКонтрагентом,
	|	ВзаиморасчетыПоДокументамОстатки.ВидРасчетовСКонтрагентом,
	|	ВзаиморасчетыПоДокументамОстатки.УпрУчет,
	|	ВзаиморасчетыПоДокументамОстатки.СуммаВзаиморасчетовОстаток * &ЗнакОстатка КАК СуммаВзаиморасчетов,
	|	ВзаиморасчетыПоДокументамОстатки.СуммаРеглОстаток * &ЗнакОстатка КАК СуммаРегл
	|ИЗ
	|	РегистрНакопления.ВзаиморасчетыСКонтрагентамиПоДокументамРасчетов.Остатки(
	|		, 
	|		Организация = &Организация
	|			И Контрагент = &Контрагент
	|			И ДоговорКонтрагента = &ДоговорКонтрагента
	|			И ВидРасчетовСКонтрагентом = &ВидРасчетовСКонтрагентом
	|			И УпрУчет = &УпрУчет
	|			И (Сделка, ДокументРасчетовСКонтрагентом) В (ВЫБРАТЬ Сделка, ДокументРасчетовСКонтрагентом ИЗ ТаблицаВзаиморасчетов)) КАК ВзаиморасчетыПоДокументамОстатки
	|ГДЕ
	|	ВзаиморасчетыПоДокументамОстатки.СуммаВзаиморасчетовОстаток * &ЗнакОстатка > 0
	|
	|ДЛЯ ИЗМЕНЕНИЯ
	|	РегистрНакопления.ВзаиморасчетыСКонтрагентамиПоДокументамРасчетов.Остатки";
	
	Запрос.Текст = ТекстЗапроса;
		
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("ДоговорКонтрагента", ДоговорКонтрагента);
	Запрос.УстановитьПараметр("ВидРасчетовСКонтрагентом", ВидРасчетовСКонтрагентом);
	Запрос.УстановитьПараметр("УпрУчет", УпрУчет);
	Запрос.УстановитьПараметр("ЗнакОстатка",ЗнакОстатка);
		
	ОстаткиПоРасчетам = Запрос.Выполнить().Выгрузить();
	
	НаборЗаписейВзаиморасчетыПоДокументам = Движения.ВзаиморасчетыСКонтрагентамиПоДокументамРасчетов;
	ТаблицаДвижений = НаборЗаписейВзаиморасчетыПоДокументам.Выгрузить();
	ТаблицаДвижений.Очистить();
	
	Если СтруктураШапкиДокумента.Свойство("РежимПроведения") Тогда
		РежимПроведения = СтруктураШапкиДокумента.РежимПроведения;
	Иначе
		РежимПроведения = РежимПроведенияДокумента.Неоперативный;
	КонецЕсли;
	
	ЗапрещатьПревышениеОстатков   = РежимПроведения = РежимПроведенияДокумента.Оперативный;
	ВзаиморасчетыВВалютеРеглУчета = СтруктураШапкиДокумента.ВалютаВзаиморасчетов = СтруктураШапкиДокумента.ВалютаРегламентированногоУчета;
	ДелатьДвиженияПоСуммеРегл     = СтруктураШапкиДокумента.ОтражатьВРегламентированномУчете И НЕ ВзаиморасчетыВВалютеРеглУчета;

	Для каждого СтрокаВзаиморасчетов Из ТаблицаВзаиморасчетов Цикл
		
		ЭтоПогашениеКредДокумента = СтрокаВзаиморасчетов.ДокументРасчетовСКонтрагентом <> Ссылка;
		
		Если ЭтоПогашениеКредДокумента Тогда
			
			ОтборПоОстаткам = Новый Структура("Организация, Контрагент, ДоговорКонтрагента, Сделка, 
			| ДокументРасчетовСКонтрагентом, ВидРасчетовСКонтрагентом, УпрУчет", 
			Организация, Контрагент, ДоговорКонтрагента, СтрокаВзаиморасчетов.Сделка, 
			СтрокаВзаиморасчетов.ДокументРасчетовСКонтрагентом, ВидРасчетовСКонтрагентом, УпрУчет);
			
			СтрокиОстатка = ОстаткиПоРасчетам.НайтиСтроки(ОтборПоОстаткам);
			
			ОстатокСуммыВзаиморасчетов = 0;
			Для каждого ОстатокЗадолженности из СтрокиОстатка Цикл
				ОстатокСуммыВзаиморасчетов = ОстатокСуммыВзаиморасчетов + ОстатокЗадолженности.СуммаВзаиморасчетов;
			КонецЦикла;
			
			Если ОстатокСуммыВзаиморасчетов < СтрокаВзаиморасчетов.СуммаВзаиморасчетов * Множитель Тогда
			
				ВалютаПредставление = Строка(ДоговорКонтрагента.ВалютаВзаиморасчетов);
				СделкаПредставление = ?(НЕ ЗначениеЗаполнено(СтрокаВзаиморасчетов.Сделка), "не указана", Строка(СтрокаВзаиморасчетов.Сделка));
				ТекстСообщения = "Указана сумма взаиморасчетов, превышающая непогашенный остаток по документу расчетов с контрагентом!
				               | Сделка: " + СделкаПредставление + ", документ расчетов: " + СтрокаВзаиморасчетов.ДокументРасчетовСКонтрагентом + "; 
				               | Остаток " + ОстатокСуммыВзаиморасчетов + " " + ВалютаПредставление + "; "
				               + " указана сумма " + (СтрокаВзаиморасчетов.СуммаВзаиморасчетов * Множитель) + " " + ВалютаПредставление + "; "
				               + " превышение " + (СтрокаВзаиморасчетов.СуммаВзаиморасчетов  * Множитель - ОстатокСуммыВзаиморасчетов) + " " + ВалютаПредставление;
			
				Если ЗапрещатьПревышениеОстатков Тогда
					ttk_ОбщегоНазначения.СообщитьОбОшибке(ТекстСообщения, Отказ, Заголовок);
					Возврат;
				Иначе
					ttk_ОбщегоНазначения.СообщитьОбОшибке(ТекстСообщения, , Заголовок);
				КонецЕсли; 
				
			КонецЕсли; 
		КонецЕсли; 
				
		Движение = ТаблицаДвижений.Добавить();
		
		Движение.Организация            	   = Организация;
		Движение.Контрагент            		   = Контрагент;
		Движение.ДоговорКонтрагента            = ДоговорКонтрагента;
		Движение.Сделка                        = СтрокаВзаиморасчетов.Сделка;
		Движение.ДокументРасчетовСКонтрагентом = СтрокаВзаиморасчетов.ДокументРасчетовСКонтрагентом;
		Движение.УпрУчет                       = УпрУчет;
		Движение.ВидРасчетовСКонтрагентом      = ВидРасчетовСКонтрагентом;
		
		Движение.СуммаВзаиморасчетов = СтрокаВзаиморасчетов.СуммаВзаиморасчетов;
		Если ДелатьДвиженияПоСуммеРегл Тогда
			Движение.СуммаРегл       = СтрокаВзаиморасчетов.СуммаРегл;
		КонецЕсли;
		
	КонецЦикла; 
	
	НаборЗаписейВзаиморасчетыПоДокументам.мТаблицаДвижений = ТаблицаДвижений;
	НаборЗаписейВзаиморасчетыПоДокументам.мПериод = ДатаДвижений;
	
	Если Не Отказ Тогда
		ttk_ОбщегоНазначения.ВыполнитьДвижениеПоРегистру(НаборЗаписейВзаиморасчетыПоДокументам, ВидДвижения);
	КонецЕсли;

КонецПроцедуры

Функция абс_ПроверитьДвижениеПоКонтрагенты(СтруктураШапкиДокумента)  
	
	Возврат (СтруктураШапкиДокумента.Контрагент <> СтруктураШапкиДокумента.абс_Контрагент
		     или СтруктураШапкиДокумента.ДоговорКонтрагента <> СтруктураШапкиДокумента.абс_ДоговорКонтрагента)
		     и ЗначениеЗаполнено(СтруктураШапкиДокумента.абс_ДоговорКонтрагента) 
			 и ЗначениеЗаполнено(СтруктураШапкиДокумента.абс_Контрагент); 
	
КонецФункции	
//\\АБС ВСТАВКА КОНЕЦ

// По результату запроса по шапке документа формируем движения по регистрам для целей упр. учета.
//
// Параметры: 
//  РежимПроведения           - режим проведения документа (оперативный или неоперативный),
//  СтруктураШапкиДокумента   - выборка из результата запроса по шапке документа,
//  ТаблицаПоТоварам          - таблица значений, содержащая данные для проведения и проверки ТЧ Товары,
//  ТаблицаПоУслугам          - таблица значений, содержащая данные для проведения и проверки ТЧ "Услуги",
//  Отказ                     - флаг отказа в проведении,
//  Заголовок                 - строка, заголовок сообщения об ошибке проведения.
//
Процедура ДвиженияПоРегистрамУпр(РежимПроведения, СтруктураШапкиДокумента, 
			ТаблицаПоТоварам, ТаблицаПоКомплектам, ТаблицаПоУслугам, 
			ТаблицаПоВзаиморасчетам, ТаблицаПоРасчетам, Отказ, Заголовок)
	
	Если НЕ СтруктураШапкиДокумента.ОтражатьВУправленческомУчете Тогда
		Возврат;
	КонецЕсли;
	
	//АБС ВСТАВКА НАЧАЛО
	Если абс_ПроверитьДвижениеПоКонтрагенты(СтруктураШапкиДокумента) Тогда
		
		ВыполнитьДвиженияПоРегистрамУпрВзаиморасчетов(
			ЭтотОбъект, СтруктураШапкиДокумента, мСтруктураПараметровВзаиморасчетов, 
			ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоВзаиморасчетам, "СуммаВзаиморасчетов,СуммаУпр"),
			ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоРасчетам, "СуммаВзаиморасчетов,СуммаУпр"), 
			ВидДвиженияНакопления.Приход, Отказ, Заголовок);
	
	Иначе	
		
		УправлениеВзаиморасчетами.ВыполнитьДвиженияПоРегистрамУпрВзаиморасчетов(
			ЭтотОбъект, СтруктураШапкиДокумента, мСтруктураПараметровВзаиморасчетов, 
			ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоВзаиморасчетам, "СуммаВзаиморасчетов,СуммаУпр"),
			ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоРасчетам, "СуммаВзаиморасчетов,СуммаУпр"), 
			ВидДвиженияНакопления.Приход, Отказ, Заголовок);
			
	КонецЕсли;	
	//\\АБС ВСТАВКА КОНЕЦ	
		
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
		
		// СУММА ПО РЕГИСТРУ ПродажиПоДисконтнымКартам.
		Если ЭтоКорректировкаРТиУ()
		 И СуммаДокумента - ДокументРеализации.СуммаДокумента <> 0
		 И ЗначениеЗаполнено(СтруктураШапкиДокумента.ДисконтнаяКарта) Тогда
			
			НаборДвижений 	= Движения.ПродажиПоДисконтнымКартам;
			ТаблицаДвижений = НаборДвижений.Выгрузить();
			
			// Заполним таблицу движений.
			СтрокаДвижений = ТаблицаДвижений.Добавить();
			СтрокаДвижений.ДисконтнаяКарта 			= СтруктураШапкиДокумента.ДисконтнаяКарта;
			СтрокаДвижений.ВладелецДисконтнойКарты 	= СтруктураШапкиДокумента.Контрагент;
			СтрокаДвижений.Сумма					=
				МодульВалютногоУчета.ПересчитатьИзВалютыВВалюту(СуммаДокумента - ДокументРеализации.СуммаДокумента, ВалютаДокумента,
					СтруктураШапкиДокумента.ВалютаУправленческогоУчета,
					СтруктураШапкиДокумента.КурсДокумента,
					СтруктураШапкиДокумента.КурсВалютыУправленческогоУчета,
					СтруктураШапкиДокумента.КратностьДокумента,
					СтруктураШапкиДокумента.КратностьВалютыУправленческогоУчета);
			
			НаборДвижений.мПериод          			= Дата;
			НаборДвижений.мТаблицаДвижений 			= ТаблицаДвижений;
			
			Если НЕ Отказ Тогда
				НаборДвижений.ВыполнитьДвижения();
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
		
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
		
		// ТОВАРЫ И УСЛУГИ ПО РЕГИСТРУ Продажи.
		КопияТовары = ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоТоварам, "Количество,Стоимость,НДС");
		КопияУслуги = ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоУслугам, "Количество,Стоимость,НДС");
		
		ТабИменТовары = Неопределено;
		ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(КопияТовары, ТабИменТовары, "НДС",    "НДСВрем");
		ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(КопияТовары, ТабИменТовары, "НДСУпр", "НДС");
		
		ТабИменУслуги = Неопределено;
		ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(КопияУслуги, ТабИменУслуги, "НДС",    "НДСВрем");
		ttk_ОбщегоНазначения.ПереименоватьКолонкуТаблицыЗначений(КопияУслуги, ТабИменУслуги, "НДСУпр", "НДС");
		
		Если СтруктураШапкиДокумента.ВедениеУчетаПоПроектам Тогда
			
			// В этом случае таблицы документа обрабатываются особым образом
			ТаблицаДвижений = Движения.Продажи.Выгрузить();
			ТаблицаДвижений.Очистить();
			
			ТаблицаДвиженийУслуги = ТаблицаДвижений.Скопировать();
			ТаблицаДвиженийТовары = ТаблицаДвижений.Скопировать();
			
			УправлениеПроектами.ОтразитьДвиженияПоПроектам(КопияУслуги, ТаблицаДвиженийУслуги, Проект, Дата, "Продажи");
			УправлениеПроектами.ОтразитьДвиженияПоПроектам(КопияТовары, ТаблицаДвиженийТовары, Проект, Дата, "Продажи");
			
			// Вставляем уже подготовленные таблицы движений
			ТаблицыДанныхДокумента = Новый Структура;
			ТаблицыДанныхДокумента.Вставить("ТаблицаПоТоварам", ТаблицаДвиженийТовары);
			ТаблицыДанныхДокумента.Вставить("ТаблицаПоУслугам", ТаблицаДвиженийУслуги);
			
		Иначе
			
			СтруктТаблицДокумента = Новый Структура;
			СтруктТаблицДокумента.Вставить("ТаблицаПоУслугам", КопияУслуги);
			СтруктТаблицДокумента.Вставить("ТаблицаПоТоварам", КопияТовары);
			
			ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(Движения.Продажи, СтруктТаблицДокумента);
			
		КонецЕсли;
		
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "ДоговорКонтрагента", ДоговорКонтрагента);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Организация",        Организация);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Контрагент",         Контрагент);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "ДокументПродажи",    ДокументРеализации);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Подразделение",      Подразделение);
		
		// Когда взаиморасчеты ведутся по счетам, поле заказ покупателя в таб.части будет пустое (нет типа Документ.СчетНаОплату)
		Если СтруктураШапкиДокумента.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоСчетам Тогда
			ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "ЗаказПокупателя", СтруктураШапкиДокумента.Сделка);
		КонецЕсли;
		
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.Продажи, Неопределено, ТаблицыДанныхДокумента, Дата);
		
	КонецЕсли;
	
	// ТОВАРЫ ПО РЕГИСТРУ ТоварыНаСкладах и ТоварыВРознице.
	КопияТаблицаПоКомплектам = ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоКомплектам, "Количество");
	КопияТаблицаПоКомплектам.Индексы.Добавить("ВидСклада");

	//Бобылев А.А. 21.05.2018 СППР00-00000088
	Попытка
		КопияТаблицаПоКомплектам.Колонки.Добавить("СчетУчета");
		Для каждого Элемент из КопияТаблицаПоКомплектам Цикл
			Элемент.СчетУчета = Элемент.СчетУчетаБУ;
		КонецЦикла; 
	Исключение
	КонецПопытки;
	//Бобылев А.А.--------------------------
	МассивКомплектыОпт = КопияТаблицаПоКомплектам.НайтиСтроки(Новый Структура("ВидСклада", Перечисления.ВидыСкладов.Оптовый));
	
	Если НЕ Отказ И МассивКомплектыОпт.Количество() <> 0 Тогда
			
		ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(
			Движения.ТоварыНаСкладах,
			Новый Структура("КомплектыОпт", МассивКомплектыОпт));
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ТоварыНаСкладах, ВидДвиженияНакопления.Расход, ТаблицыДанныхДокумента, Дата);
		
	КонецЕсли;
	
	МассивКомплектыРозн = КопияТаблицаПоКомплектам.НайтиСтроки(Новый Структура("ВидСклада", Перечисления.ВидыСкладов.Розничный));
	
	Если НЕ Отказ И МассивКомплектыРозн.Количество() <> 0 Тогда
		
		ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(
			Движения.ТоварыВРознице,
			Новый Структура("КомплектыРозн", МассивКомплектыРозн));
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ТоварыВРознице, ВидДвиженияНакопления.Расход, ТаблицыДанныхДокумента, Дата);
		
	КонецЕсли;
	
	// ТОВАРЫ ПО РЕГИСТРУ ТоварыПереданные
	Если НЕ Отказ Тогда
		
		СтруктТаблицДокумента = Новый Структура;
		
		Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		 
			КопияТовары = ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоТоварам, "Количество,СуммаВзаиморасчетов");
			КопияТовары.Колонки.ЗаказПокупателя.Имя = "Сделка";
			
			СтруктТаблицДокумента.Вставить("ТаблицаТовары", КопияТовары);
			
		КонецЕсли;

		ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(Движения.ТоварыПереданные, СтруктТаблицДокумента);

		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "ДоговорКонтрагента", ДоговорКонтрагента);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Контрагент",         Контрагент);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Организация",        Организация);
		
		Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
			ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "СтатусПередачи", Перечисления.СтатусыПолученияПередачиТоваров.НаКомиссию,     "ТаблицаТовары");
		КонецЕсли;

		Если ДоговорКонтрагента.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоСчетам Тогда
			Для Каждого ТаблицаДанных Из ТаблицыДанныхДокумента Цикл
				ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Сделка", Сделка, ТаблицаДанных.Ключ);
			КонецЦикла;
		КонецЕсли;
		
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ТоварыПереданные, ВидДвиженияНакопления.Приход, ТаблицыДанныхДокумента, Дата);

	КонецЕсли;

	// ТОВАР И УСЛУГИ ПО РЕГИСТРУ ЗаказыПокупателей.
	Если НЕ Отказ Тогда
		
		СтруктТаблицДокумента = Новый Структура(
			"ТаблицаПоТоварам, ТаблицаПоУслугам",
			ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоТоварам, "Количество,СуммаВзаиморасчетов,СуммаУпр"),
			ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоУслугам, "Количество,СуммаВзаиморасчетов,СуммаУпр"));
		
		ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(Движения.ЗаказыПокупателей, СтруктТаблицДокумента);
		ОбщегоНазначения.УдалитьСтрокиИзТаблицДокумента(ТаблицыДанныхДокумента, "ЗаказПокупателя");
		
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "ДоговорКонтрагента", ДоговорКонтрагента);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "СтатусПартии",       Перечисления.СтатусыПартийТоваров.Купленный, "ТаблицаПоТоварам,ТаблицаПоУслугам");
		
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ЗаказыПокупателей, ВидДвиженияНакопления.Расход, ТаблицыДанныхДокумента, Дата);
		
	КонецЕсли;
	
	// ТОВАР ПО РЕГИСТРУ ТоварыВРезервеНаСкладах.
	Если НЕ Отказ Тогда
		
		ТабРезервТовары = ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоКомплектам, "Количество");
		ТабРезервТовары.Колонки.ЗаказПокупателя.Имя = "ДокументРезерва";
		
		// Удалим записи таблицы в которых не надо списывать из резерва или не указан документ резерва.
		МассивНаУдаление = Новый Массив;
		Для Каждого СтрокаСписанияРезервов Из ТабРезервТовары Цикл
			Если СтрокаСписанияРезервов.СпособСписанияОстаткаТоваров <> Перечисления.СпособыСписанияОстаткаТоваров.ИзРезерва
			 ИЛИ НЕ ЗначениеЗаполнено(СтрокаСписанияРезервов.ДокументРезерва) Тогда
				МассивНаУдаление.Добавить(СтрокаСписанияРезервов);
			КонецЕсли;	
		КонецЦикла;	
		
		Для Каждого Элемент Из МассивНаУдаление Цикл
			ТабРезервТовары.Удалить(Элемент);
		КонецЦикла;	
		
		Если ТабРезервТовары.Количество() > 0 Тогда
			
			ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(
				Движения.ТоварыВРезервеНаСкладах,
				Новый Структура("ТаблицаПоТоварам", ТабРезервТовары));
			ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ТоварыВРезервеНаСкладах, ВидДвиженияНакопления.Расход, ТаблицыДанныхДокумента, Дата);
			
		КонецЕсли;	
		
	КонецЕсли;
	
КонецПроцедуры // ДвиженияПоРегистрамУпр()


Процедура ДвиженияПоРегиструТоварыОрганизаций(РежимПроведения, СтруктураШапкиДокумента, 
			ТаблицаПоТоварам, ТаблицаПоУслугам, Отказ, Заголовок)
	
	Если НЕ СтруктураШапкиДокумента.ОтражатьВРегламентированномУчете Тогда
		Возврат;
	КонецЕсли;
	
	// ТОВАРЫ ПО РЕГИСТРУ ТоварыОрганизаций.
	Если НЕ Отказ Тогда
		
		
		ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(
			Движения.ТоварыОрганизаций,
			Новый Структура("ТаблицаПоТоварам", ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоТоварам, "Количество")));
					
		// Недостающие поля (качество заполнили в "ПередЗаписью" документа).
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Организация", Организация);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Комиссионер", Неопределено);
		
		Если НЕ СтруктураШапкиДокумента.ВестиУчетТоваровОрганизацийВРазрезеСкладов Тогда
			ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Склад", Неопределено);
		КонецЕсли;
		
		//АБС ВСТАВКА НАЧАЛО
		Если абс_ПроверитьДвижениеПоКонтрагенты(СтруктураШапкиДокумента) Тогда
        	//нужен пример
		КонецЕсли;			
		//\\АБС ВСТАВКА КОНЕЦ			
		
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ТоварыОрганизаций, ВидДвиженияНакопления.Расход, ТаблицыДанныхДокумента, Дата);
		
	КонецЕсли;
	
	// Перенесем остатки по организации на комиссионера.
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		
		ТаблицыДанныхДокумента = ttk_ОбщегоНазначения.ЗагрузитьТаблицыДокументаВСтруктуру(
			Движения.ТоварыОрганизаций,
			Новый Структура("ТаблицаПоТоварам", ОтобратьСтрокиСЗаполненнымиЗначениямиВКолонках(ТаблицаПоТоварам, "Количество")));
		
		// Недостающие поля (качество заполнили в "ПередЗаписью" документа).
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Организация", Организация);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Комиссионер", Контрагент);
		ttk_ОбщегоНазначения.УстановитьЗначениеВТаблицыДокумента(ТаблицыДанныхДокумента, "Склад",       Неопределено);
		
		//АБС ВСТАВКА НАЧАЛО
		Если абс_ПроверитьДвижениеПоКонтрагенты(СтруктураШапкиДокумента) Тогда
        	//нужен пример
		КонецЕсли;			
		//\\АБС ВСТАВКА КОНЕЦ		
		
		ttk_ОбщегоНазначения.ЗаписатьТаблицыДокументаВРегистр(Движения.ТоварыОрганизаций, ВидДвиженияНакопления.Приход, ТаблицыДанныхДокумента, Дата);
		
	КонецЕсли;
	
КонецПроцедуры // ДвиженияПоРегиструТоварыОрганизаций()


// Формирует движения по регистру "Взаиморасчеты с контрагентами по документам расчетов",
// если по договору ведется учет в разрезе документов
//
Процедура ДвиженияПоРегистрамОперативныхВзаиморасчетов(РежимПроведения, ТаблицаПоВзаиморасчетам, Отказ, Заголовок, СтруктураШапкиДокумента)
	
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
                             		
		//АБС ВСТАВКА НАЧАЛО
		Если абс_ПроверитьДвижениеПоКонтрагенты(СтруктураШапкиДокумента) Тогда
			ОтражениеЗадолженностиВРегистреОперативныхРасчетовПоДокументам(
				СтруктураШапкиДокумента,
				ТаблицаПоВзаиморасчетам,
				Перечисления.ВидыРасчетовСКонтрагентами.ПоРеализации,
				ВидДвиженияНакопления.Приход,
				Движения,
				Отказ,
				Заголовок);
	
		Иначе	
				
			УправлениеВзаиморасчетами.ОтражениеЗадолженностиВРегистреОперативныхРасчетовПоДокументам(
				СтруктураШапкиДокумента,
				ТаблицаПоВзаиморасчетам,
				Перечисления.ВидыРасчетовСКонтрагентами.ПоРеализации,
				ВидДвиженияНакопления.Приход,
				Движения,
				Отказ,
				Заголовок);
		КонецЕсли;			
		//\\АБС ВСТАВКА КОНЕЦ		
                    		
 	КонецЕсли;
 	
КонецПроцедуры


// Формирование движений по регистру "Списанные товары".
//
Процедура ДвиженияПоРегиструСписанныеТовары(СтруктураШапкиДокумента, ТаблицаПоТоварам, Отказ, Заголовок);
	
	// ТОВАРЫ ПО РЕГИСТРУ СписанныеТовары.
	НаборДвижений 	= Движения.СписанныеТовары;
	
	ТаблицаДвижений = НаборДвижений.Выгрузить();
	ТаблицаДвижений.Очистить();
	
	КопияТаблицаПоТоварам = ТаблицаПоТоварам.Скопировать();
	
	ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(
		УправлениеЗапасами.ПолучитьТаблицуСобственныхТоваров(СтруктураШапкиДокумента, КопияТаблицаПоТоварам),
		ТаблицаДвижений,
		Истина);
	
	// Недостающие поля.
	Для Каждого Строка Из ТаблицаДвижений Цикл
		
		Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
			
			Строка.ДоговорКонтрагента 	= СтруктураШапкиДокумента.ДоговорКонтрагента;
			Строка.СтатусПередачи 		= Перечисления.СтатусыПолученияПередачиТоваров.НаКомиссию;
			Строка.ДокументПередачи 	= СтруктураШапкиДокумента.Ссылка;
			
			Строка.КодОперацииПартииТоваров = ?(Строка.Количество < 0, 
				Перечисления.КодыОперацийПартииТоваров.ВозвратОтКомиссионера, Перечисления.КодыОперацийПартииТоваров.ПередачаНаКомиссию);
			
		ИначеЕсли СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
			
			Строка.КодОперацииПартииТоваров = ?(Строка.Количество < 0,
				Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателя, Перечисления.КодыОперацийПартииТоваров.Реализация);
			
		КонецЕсли;
		
		// Корректировка на отрицательное количество в партионном учете будет обработана как возврат
		Если Строка.Количество < 0 Тогда
			Строка.Количество = -Строка.Количество;
		КонецЕсли;
		
	КонецЦикла;
	
	ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.ВидыТабличныхЧастей.Товары, 			"ВидТабличнойЧасти");
	ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.ВедениеУчетаПоПроектам,   "ВедениеУчетаПоПроектам");
	ТаблицаДвижений.ЗаполнитьЗначения(Дата,   											"Период");
	ТаблицаДвижений.ЗаполнитьЗначения(Ссылка, 											"Регистратор");
	ТаблицаДвижений.ЗаполнитьЗначения(Истина, 											"Активность");
	ТаблицаДвижений.ЗаполнитьЗначения(Справочники.Качество.Новый, 						"Качество");
	ТаблицаДвижений.ЗаполнитьЗначения(ДоговорКонтрагента, 								"ДоговорКонтрагента");
	
	ЗаполнитьКолонкиРегистраСписанныеТоварыПоТоварамУпр(ТаблицаДвижений, СтруктураШапкиДокумента, КопияТаблицаПоТоварам);
	ЗаполнитьКолонкиРегистраСписанныеТоварыПоТоварамРегл(ТаблицаДвижений, СтруктураШапкиДокумента, КопияТаблицаПоТоварам);
	
	НаборДвижений.мПериод          = Дата;
	НаборДвижений.мТаблицаДвижений = ТаблицаДвижений;
	
	Если НЕ Отказ Тогда
		Движения.СписанныеТовары.ВыполнитьДвижения();
	КонецЕсли;
	
	Движения.СписанныеТовары.Записать(Истина);
	
КонецПроцедуры // ДвиженияПоРегиструСписанныеТовары()

Процедура ЗаполнитьКолонкиРегистраСписанныеТоварыПоТоварамУпр(ТаблицаДвижений, СтруктураШапкиДокумента, ТаблицаПоТоварам)
	
	ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.СтатусыПартийТоваров.Купленный, 		"ДопустимыйСтатус1");
	ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.СтатусыПартийТоваров.Продукция, 		"ДопустимыйСтатус2");
	ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.СтатусыПартийТоваров.НаКомиссию,		"ДопустимыйСтатус3");
	ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.СтатусыПартийТоваров.ВозвратнаяТара,	"ДопустимыйСтатус4");
	ТаблицаДвижений.ЗаполнитьЗначения(Подразделение,									"Подразделение");
	ТаблицаДвижений.ЗаполнитьЗначения(ОтражатьВУправленческомУчете,						"ОтражатьВУправленческомУчете");
	
	// Данные для заполнения отчетов комитенту
	ТаблицаДвижений.ЗаполнитьЗначения(ВалютаДокумента, 									"ВалютаДокумента");
	ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.КурсДокумента,      		"КурсДокумента");
	ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.КратностьДокумента, 		"КратностьДокумента");
	
	Если СтруктураШапкиДокумента.ВедениеУчетаПоПроектам И ЗначениеЗаполнено(Проект) Тогда
		ТаблицаДвижений.ЗаполнитьЗначения(Проект, 										"Проект");
	КонецЕсли;
	
	Для Каждого Строка Из ТаблицаДвижений Цикл
		
		ЭтоВозврат = (Строка.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.ВозвратОтКомиссионера
						ИЛИ Строка.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателя);
		
		СтрокаТЧ = ТаблицаПоТоварам.Получить(Строка.НомерСтроки);
		
		Строка.СуммаЗадолженности = ?(ЭтоВозврат, -СтрокаТЧ.СуммаСНДСДок, СтрокаТЧ.СуммаСНДСДок);
		
		Если СтруктураШапкиДокумента.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоСчетам Тогда
			Строка.ЗаказСписания = СтруктураШапкиДокумента.Сделка;		
		Иначе
			Строка.ЗаказСписания = СтрокаТЧ.ЗаказПокупателя;
		КонецЕсли;	
		
		// Если резервирование под заказ - заказ партии
		Если СтруктураШапкиДокумента.ОбособленныйУчетТоваровПоЗаказамПокупателей Тогда
			Строка.ЗаказПартии = СтрокаТЧ.ЗаказПокупателя;
		КонецЕсли;
		
		// Запишем номер строки табличной части Товары в измерение НомерСтрокиДокумента регистра СписанныеТовары.
		// Так можно поступить потому, что документ не предназначен для корректировки наборов, иначе в наборе записей были бы строки с одинаковыми измерениями.
		// Номер строки необходим для формирования корректировочных проводок при традиционном режиме учета затрат.
		// В общем случае так делать не требуется - можно использовать функцию ОбщегоНазначения.ПронумероватьСтрокиТаблицыЗначений
		Строка.НомерСтрокиДокумента = СтрокаТЧ.НомерСтроки;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьКолонкиРегистраСписанныеТоварыПоТоварамРегл(ТаблицаДвижений, СтруктураШапкиДокумента, ТаблицаПоТоварам)
	
	Перем КэшПоСчетам;
	
	ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете, "ОтражатьВБухгалтерскомУчете");
	ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.ОтражатьВНалоговомУчете,     "ОтражатьВНалоговомУчете");
	ТаблицаДвижений.ЗаполнитьЗначения(СтруктураШапкиДокумента.Организация,                 "Организация");
	
	// Кор.Счет для начисления задолженности перед комитентом, если вдруг продадим комиссионный товар
	ТаблицаДвижений.ЗаполнитьЗначения(СчетУчетаРасчетовСКонтрагентом, 					   "КорСчетЗадолженностиБУ");
	
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
		
		ТаблицаДвижений.ЗаполнитьЗначения(ПланыСчетов.Налоговый.ПоступлениеИВыбытиеИмуществаРаботУслугПрав, "КорСчетНУ");
		ТаблицаДвижений.ЗаполнитьЗначения(Перечисления.УсловияПоступленияИВыбытияИмущества.ЗаПлату, 		"КорСубконтоНУ1");
		
		Если НЕ СтруктураШапкиДокумента.Свойство("КэшПоСчетам", КэшПоСчетам) Тогда
			КэшПоСчетам = Новый Соответствие;
		КонецЕсли;
		
		Для Каждого Строка Из ТаблицаДвижений Цикл
			
			ЭтоВозврат = (Строка.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.ВозвратОтКомиссионера)
				ИЛИ (Строка.КодОперацииПартииТоваров = Перечисления.КодыОперацийПартииТоваров.ВозвратОтПокупателя);
			
			СтрокаТЧ = ТаблицаПоТоварам.Получить(Строка.НомерСтроки);
			
			Строка.КорСчетБУ      = СтрокаТЧ.СчетРасходовБУ;
			Строка.КорСчетНУ      = СтрокаТЧ.СчетРасходовНУ;
			Строка.КорСубконтоБУ2 = СтрокаТЧ.СубконтоБУ;
			Строка.КорСубконтоНУ2 = СтрокаТЧ.СубконтоНУ;
			
			// Доход от продажи может облагаться ЕНВД (что определяется по бух. счету учета)
			Если ЗначениеЗаполнено(СтрокаТЧ.СчетДоходовБУ) Тогда
				
				СчетДоходовБУОтноситсяКДеятельностиЕНВД = КэшПоСчетам[СтрокаТЧ.СчетДоходовБУ];
				Если СчетДоходовБУОтноситсяКДеятельностиЕНВД = Неопределено Тогда
					СчетДоходовБУОтноситсяКДеятельностиЕНВД = НалоговыйУчетУСН.ОтноситсяКДеятельностиЕНВД(СтрокаТЧ.СчетДоходовБУ);
					КэшПоСчетам.Вставить(СтрокаТЧ.СчетДоходовБУ, СчетДоходовБУОтноситсяКДеятельностиЕНВД);
				КонецЕсли;
				
				Если СчетДоходовБУОтноситсяКДеятельностиЕНВД Тогда				
					// в этом случае товар списывается на счет расходов по ЕНВД
					Строка.КорСчетНУ = ПланыСчетов.Налоговый.РасходыПоДеятельностиЕНВД;
				КонецЕсли;
				
			КонецЕсли;
			
			// Принятые на комиссию товары не учитываются в налоговом учете:
			Если НЕ ЗначениеЗаполнено(СтрокаТЧ.СчетУчетаНУ) Тогда
				Строка.ОтражатьВНалоговомУчете = Ложь;
			Иначе
				Строка.ОтражатьВНалоговомУчете = СтруктураШапкиДокумента.ОтражатьВНалоговомУчете;
			КонецЕсли;
			
			Строка.ПринятыеКорСчетБУ		= СтрокаТЧ.ПринятыеСчетУчетаБУ;
			Строка.ПринятыеКорСчетНУ		= СтрокаТЧ.ПринятыеСчетУчетаНУ;
			
			Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчетеУСН Тогда
				Строка.ОтражатьВНалоговомУчете = Истина;
				Строка.СчетУчетаНУ 			   = СтрокаТЧ.СчетУчетаБУ;
				Строка.ПринятыеСчетУчетаНУ 	   = СтрокаТЧ.ПринятыеСчетУчетаБУ;
				Строка.ПринятыеКорСчетНУ   	   = Строка.ПринятыеКорСчетБУ;
			КонецЕсли;
			
			// Субконто кор.счета для начисления задолженности перед комитентом, если вдруг продадим комиссионный товар
			Строка.КорСубконтоЗадолженностиБУ1 = Контрагент;
			Строка.КорСубконтоЗадолженностиБУ2 = ДоговорКонтрагента;
			
			Строка.СчетДоходовБУ 			   = СтрокаТЧ.СчетДоходовБУ;
			Строка.СчетДоходовНУ 			   = СтрокаТЧ.СчетДоходовНУ;
			
			Строка.СуммаЗадолженностиБУ 	   = ?(ЭтоВозврат, -(СтрокаТЧ.СуммаБезНДС + СтрокаТЧ.НДС), СтрокаТЧ.СуммаБезНДС + СтрокаТЧ.НДС);
			Строка.СуммаНДС 				   = ?(ЭтоВозврат, -СтрокаТЧ.НДС, СтрокаТЧ.НДС);
			
			Если НЕ СтруктураШапкиДокумента.ВалютаВзаиморасчетов = СтруктураШапкиДокумента.ВалютаРегламентированногоУчета Тогда
				
				Строка.КорВалютаЗадолженностиБУ        = СтруктураШапкиДокумента.ВалютаВзаиморасчетов;
				Строка.КорВалютнаяСуммаЗадолженностиБУ = СтрокаТЧ.СуммаВал;
				
				Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете и СтруктураШапкиДокумента.УчитыватьНДС Тогда
					Строка.КорВалютнаяСуммаНДСЗадолженностиБУ = СтрокаТЧ.НДСВал;
				КонецЕсли; 
				
			КонецЕсли;
			
		КонецЦикла;
		
		ТаблицаДвижений.ЗаполнитьЗначения(ДоговорКонтрагента, "КорСубконтоБУ3");
		
	ИначеЕсли СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СКомиссионером Тогда
		
		Для Каждого Строка Из ТаблицаДвижений Цикл
			
			СтрокаТЧ = ТаблицаПоТоварам.Получить(Строка.НомерСтроки);
			
			Строка.КорСчетБУ      	 = СтрокаТЧ.ПереданныеСобственныеБУ;
			Строка.КорСчетНУ      	 = СтрокаТЧ.ПереданныеСобственныеНУ;
			
			Строка.ПринятыеКорСчетБУ = СтрокаТЧ.ПереданныеПринятыеБУ;
			Строка.ПринятыеКорСчетНУ = СтрокаТЧ.ПереданныеПринятыеНУ;
			
			Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчетеУСН Тогда
				Строка.ОтражатьВНалоговомУчете 	= Истина;
				Строка.СчетУчетаНУ 			   	= СтрокаТЧ.СчетУчетаБУ;
				Строка.КорСчетНУ   				= СтрокаТЧ.ПереданныеСобственныеБУ;
				Строка.ПринятыеСчетУчетаНУ 		= СтрокаТЧ.ПринятыеСчетУчетаБУ;
				Строка.ПринятыеКорСчетНУ 		= СтрокаТЧ.ПереданныеПринятыеБУ;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры 

// ДВИЖЕНИЯ ПО РЕГИСТРАМ РЕГЛ. УЧЕТА

Процедура ДвиженияПоРегистрамРегл(РежимПроведения, СтруктураШапкиДокумента, 
			ТаблицаПоТоварам, ТаблицаПоУслугам, ТаблицаПоВзаиморасчетам, ТаблицаТоваровДляУчетаЗатрат, Отказ, Заголовок)
	
	Если НЕ СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете Тогда
		Возврат;
	КонецЕсли;
	
	ПроводкиБУ = Движения.Хозрасчетный;
	ПроводкиНУ = Движения.Налоговый;
	ДатаДока   = Дата;
	ПрошлыйПериод = Год(СтруктураШапкиДокумента.ДокументРеализацииДата) < Год(СтруктураШапкиДокумента.Дата);
	
	//АБС ВСТАВКА №45134 НАЧАЛО «8 июля 2014 г.», Пополитов   	
		////АБС ВСТАВКА №44659 НАЧАЛО «9 июня 2014 г.», Пополитов 
		//Если ПрошлыйПериод и СтруктураШапкиДокумента.СуммаДокумента = 0 Тогда
		//	ПрошлыйПериод = Ложь;	
		//КонецЕсли;	
		// //\\АБС ВСТАВКА №44659 КОНЕЦ 
	//\\АБС ВСТАВКА №45134 КОНЕЦ
	
	Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
		
		// Формирование движений по регистру "Учет продаж и себестоимости"
		РасширеннаяАналитикаУчета.СформироватьДвиженияПоПродажам(
			СтруктураШапкиДокумента,
			ТаблицаПоТоварам);
		РасширеннаяАналитикаУчета.СформироватьДвиженияПоПродажам(
			СтруктураШапкиДокумента,
			ТаблицаПоУслугам);
			
		//Если мИспользоватьРасширеннуюАналитику И мДатаНачалаИспользованияРасширеннойАналитики < СтруктураШапкиДокумента.Дата Тогда
		//Формирование проводок
		Для Каждого СтрокаТЧ из ТаблицаПоТоварам Цикл
			ОтразитьВУчетеМПЗ 	= СтрокаТЧ.Количество <> 0;
			ТоварНаКомиссии 	= СтрокаТЧ.ПринадлежностьНоменклатуры = Перечисления.ПринадлежностьНоменклатуры.Принятый;
			
			БУ_Тек = (НЕ ПрошлыйПериод) ИЛИ (ПрошлыйПериод И СтруктураШапкиДокумента.ОтчетностьПодписана);
			НУ_Тек = (НЕ ПрошлыйПериод) ИЛИ СтрокаТЧ.СуммаБУ <= 0;
			
			Партия = Новый Структура("СуммаСписания, Количество", 0, СтрокаТЧ.Количество);
			
			Если (НЕ НУ_Тек) Тогда
				//Корректировка НУ прошлого периода с использованием счетов К
				Если НЕ ТоварНаКомиссии Тогда
					Если ОтразитьВУчетеМПЗ Тогда
						//Документы.КорректировкаРеализации.ПодготовитьСтрокуТаблицыПоТоваров(СтруктураШапкиДокумента, ТаблицаТоваровДляУчетаЗатрат, СтрокаТЧ, СтруктураШапкиДокумента.ДокументРеализацииДата, "НУ", Ложь);
						Документы.КорректировкаРеализации.ПодготовитьСтрокуТаблицыПоТоваров(СтруктураШапкиДокумента, ТаблицаТоваровДляУчетаЗатрат, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "НУ", Ложь);
					КонецЕсли;
					//АБС ВСТАВКА №40307 НАЧАЛО «4 апреля 2014 г.», Пополитов 	
					//Отключил по просьбе "Сигуа Теа Ревазовна" и "Мольковой С.", для прошлого года не должно быть проводок со счётом 99.01 и счётом 90.01.1   
						////Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.ДокументРеализацииДата, "НУ",  Ложь, Истина, Ложь);
						//Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "НУ",  Ложь, Истина, Ложь);
						//ФинРезультат = СтрокаТЧ.СуммаБУ - СтрокаТЧ.НДС;
						////Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("НУ", ПроводкиНУ, СтруктураШапкиДокумента.ДокументРеализацииДата, СтруктураШапкиДокумента.Организация, ФинРезультат);
						//Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("НУ", ПроводкиНУ, СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация, ФинРезультат);
					//\\АБС ВСТАВКА №40307 КОНЕЦ
				КонецЕсли;
				//Возврат корректировки со счета К
				Если НЕ ТоварНаКомиссии Тогда
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "НУ", Ложь, Ложь, Истина);
				КонецЕсли;
			КонецЕсли;
			Если (НЕ БУ_Тек) Тогда
				//Корректировка БУ прошлого периода с использованием счетов К
				Если НЕ ТоварНаКомиссии Тогда
					Если ОтразитьВУчетеМПЗ Тогда
						//Документы.КорректировкаРеализации.ПодготовитьСтрокуТаблицыПоТоваров(СтруктураШапкиДокумента, ТаблицаТоваровДляУчетаЗатрат, СтрокаТЧ, СтруктураШапкиДокумента.ДокументРеализацииДата, "БУ", Ложь);
						Документы.КорректировкаРеализации.ПодготовитьСтрокуТаблицыПоТоваров(СтруктураШапкиДокумента, ТаблицаТоваровДляУчетаЗатрат, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", Ложь);
					КонецЕсли;
					//Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), "БУ", Ложь, Истина, Ложь);
					//Документы.КорректировкаРеализации.СформироватьПроводкиПоНДС(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), Ложь);
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", Ложь, Истина, Ложь);
					Документы.КорректировкаРеализации.СформироватьПроводкиПоНДС(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, Ложь);					
					ФинРезультат = СтрокаТЧ.СуммаБУ - СтрокаТЧ.НДС;
					//Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("БУ", ПроводкиБУ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), СтруктураШапкиДокумента.Организация, ФинРезультат);
					Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("БУ", ПроводкиБУ, СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация, ФинРезультат);
				Иначе
					//Документы.КорректировкаРеализации.СформироватьПроводкиПоВыручкеКомитента(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), Истина, Ложь);
					Документы.КорректировкаРеализации.СформироватьПроводкиПоВыручкеКомитента(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, Истина, Ложь);
				КонецЕсли;
				//Возврат корректировки со счета К
				Если НЕ ТоварНаКомиссии Тогда
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", Ложь, Ложь, Истина);
				Иначе
					Документы.КорректировкаРеализации.СформироватьПроводкиПоВыручкеКомитента(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, Ложь, Истина);
				КонецЕсли;
			КонецЕсли;
			Если (НУ_Тек) Тогда
				//Коррктировка текущего периода
				Если НЕ ТоварНаКомиссии Тогда
					Если ОтразитьВУчетеМПЗ Тогда
						Документы.КорректировкаРеализации.ПодготовитьСтрокуТаблицыПоТоваров(СтруктураШапкиДокумента, ТаблицаТоваровДляУчетаЗатрат, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "НУ", ПрошлыйПериод, НЕ БУ_Тек);
					КонецЕсли;
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата,  "НУ", ПрошлыйПериод, Ложь, Ложь);
					Если НЕ БУ_Тек Тогда
						Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "ПР", ПрошлыйПериод, Ложь, Ложь);
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			Если (БУ_Тек) Тогда
				//Коррктировка текущего периода
				Если НЕ ТоварНаКомиссии Тогда
					Если ОтразитьВУчетеМПЗ Тогда
						Документы.КорректировкаРеализации.ПодготовитьСтрокуТаблицыПоТоваров(СтруктураШапкиДокумента, ТаблицаТоваровДляУчетаЗатрат, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", ПрошлыйПериод, НЕ НУ_Тек);
					КонецЕсли;
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", ПрошлыйПериод, Ложь, Ложь);
					Если НЕ НУ_Тек Тогда
						Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "ПР", ПрошлыйПериод, Ложь, Ложь);
					КонецЕсли;
					Документы.КорректировкаРеализации.СформироватьПроводкиПоНДС(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, ПрошлыйПериод);
				Иначе
					Документы.КорректировкаРеализации.СформироватьПроводкиПоВыручкеКомитента(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, Ложь, Ложь);
				КонецЕсли;
			КонецЕсли;
			
		КонецЦикла;
		//КонецЕсли;
		
		Для Каждого СтрокаТЧ из ТаблицаПоУслугам Цикл
			
			БУ_Тек = (НЕ ПрошлыйПериод) ИЛИ (ПрошлыйПериод И СтруктураШапкиДокумента.ОтчетностьПодписана);
			НУ_Тек = (НЕ ПрошлыйПериод) ИЛИ СтрокаТЧ.СуммаБУ <= 0;
			
			Если (НЕ НУ_Тек) Тогда 				
				//АБС ВСТАВКА №40307 НАЧАЛО «4 апреля 2014 г.», Пополитов 	
				//Отключил по просьбе "Сигуа Теа Ревазовна" и "Мольковой С.", для прошлого года не должно быть проводок со счётом 99.01 и счётом 90.01.1   
					////Корректировка НУ прошлого периода с использованием счетов К
					////Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.ДокументРеализацииДата, "НУ",  Ложь, Истина, Ложь);
					//Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "НУ",  Ложь, Истина, Ложь); 				
					//ФинРезультат = СтрокаТЧ.СуммаБУ - СтрокаТЧ.НДС;
					//Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("НУ", ПроводкиНУ, СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация, ФинРезультат);
				//\\АБС ВСТАВКА №40307 КОНЕЦ
				//Возврат корректировки со счета К
				Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "НУ", Ложь, Ложь, Истина);
			КонецЕсли;
			Если (НЕ БУ_Тек) Тогда
				//Корректировка БУ прошлого периода с использованием счетов К
				//Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), "БУ", Ложь, Истина, Ложь);
				//Документы.КорректировкаРеализации.СформироватьПроводкиПоНДС(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), Истина);
				Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", Ложь, Истина, Ложь);
				Документы.КорректировкаРеализации.СформироватьПроводкиПоНДС(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, Истина);				
				ФинРезультат = СтрокаТЧ.СуммаБУ - СтрокаТЧ.НДС;
				//Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("БУ", ПроводкиБУ, КонецГода(СтруктураШапкиДокумента.ДокументРеализацииДата), СтруктураШапкиДокумента.Организация, ФинРезультат);
				Документы.КорректировкаРеализации.СформироватьФинансовыйРезультат("БУ", ПроводкиБУ, СтруктураШапкиДокумента.Дата, СтруктураШапкиДокумента.Организация, ФинРезультат);
				//Возврат корректировки со счета К
				Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", Ложь, Ложь, Истина);				
			КонецЕсли;
			Если (НУ_Тек) Тогда
				//Коррктировка текущего периода
				Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата,  "НУ", ПрошлыйПериод, Ложь, Ложь);
				Если НЕ БУ_Тек Тогда
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "ПР", ПрошлыйПериод, Ложь, Ложь);
				КонецЕсли;
			КонецЕсли;
			Если (БУ_Тек) Тогда
				//Коррктировка текущего периода
				Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "БУ", ПрошлыйПериод, Ложь, Ложь);
				Если НЕ НУ_Тек Тогда
					Документы.КорректировкаРеализации.СформироватьПроводкиПоСобственнойВыручке(СтруктураШапкиДокумента, ПроводкиНУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, "ПР", ПрошлыйПериод, Ложь, Ложь);
				КонецЕсли;
				Документы.КорректировкаРеализации.СформироватьПроводкиПоНДС(СтруктураШапкиДокумента, ПроводкиБУ, СтрокаТЧ, СтруктураШапкиДокумента.Дата, ПрошлыйПериод);				
			КонецЕсли;
			
		КонецЦикла;
				
		/////////////////////////////////////////////////////////////////////
		//Проведение по взаиморасчетам      
		//
		// Движения по взаиморасчетам
		
		СтруктураПараметровЗачетАванса = БухгалтерскийУчетРасчетовСКонтрагентами.ПодготовкаСтруктурыПараметровДляЗачетаАванса(Ссылка, мВалютаРегламентированногоУчета, Заголовок, , ТаблицаПоВзаиморасчетам, СтруктураШапкиДокумента);
		
		//АБС+ Тупиков 13209
		Если НЕ ПризнаватьЗачитыватьАванс Тогда										
			//Что бы аванс не зачитывался автоматически очистим счет учета авнсов										
			СтруктураПараметровЗачетАванса.СчетУчетаРасчетовПоАвансам = ПланыСчетов.Хозрасчетный.ПустаяСсылка();
		КонецЕсли;
		//АБС- Тупиков
		
		Если СтруктураПараметровЗачетАванса = Ложь тогда
			//Отказ       = Истина;
			СуммаАванса = 0;
		Иначе
			ДвиженияДляРегистраРасчетовПоРеализации =
				ПодготовитьТаблицуДвиженийДляРегистраРасчетовПоРеализации(
					СтруктураПараметровЗачетАванса,
					СтруктураШапкиДокумента,
					ТаблицаПоТоварам,
					ТаблицаПоУслугам);
			СуммаАванса =
				БухгалтерскийУчетРасчетовСКонтрагентами.ЗачетАванса(
					СтруктураПараметровЗачетАванса,
					ПроводкиБУ,
					мВалютаРегламентированногоУчета,
					РежимПроведения,
					ЭтотОбъект,
					ДвиженияДляРегистраРасчетовПоРеализации);
		КонецЕсли;
		
	КонецЕсли; //Если СтруктураШапкиДокумента.ВидДоговора = Перечисления.ВидыДоговоровКонтрагентов.СПокупателем Тогда
	
	//АБС ВСТАВКА 17481 НАЧАЛО
	Если ПрошлыйПериод Тогда
		Для каждого Строка Из ПроводкиБУ Цикл
			Если Строка.ВалютнаяСуммаДт < 0 и Строка.Сумма > 0 Тогда
				Строка.ВалютнаяСуммаДт = -Строка.ВалютнаяСуммаДт;
			КонецЕсли;	
			Если Строка.ВалютнаяСуммаКт < 0 и Строка.Сумма > 0 Тогда
				Строка.ВалютнаяСуммаКт = -Строка.ВалютнаяСуммаКт;
			КонецЕсли;	
		КонецЦикла;		
		
		// {{ТТК Сладков А. Заявка № 15.07.2016 начало
		Если НЕ СтруктураШапкиДокумента.ВидОперации = перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение  Тогда
		// }}ТТК Сладков А. Заявка № 15.07.2016 окончание
		
			Для каждого Строка Из ПроводкиНУ Цикл
				Если Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
					Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				КонецЕсли;	
				Если Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
					Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				КонецЕсли;
				// Start КТТК Ермолов Е.Л.  17.05.2016 7722270
				Попытка
					Если Не СтруктураШапкиДокумента.СтатьяПрочихДоходовИРасходов.ПринятиеКналоговомуУчету Тогда 
						Если Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
							Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ПР;
						КонецЕсли;	
						Если Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
							Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ПР;
						КонецЕсли;
					КонецЕсли;
				Исключение
				КонецПопытки;
				// Stop КТТК Ермолов Е.Л.  17.05.2016
			
			КонецЦикла;	
			
		// {{ТТК Сладков А. Заявка № 15.07.2016 начало
		КонецЕсли;
		// }}ТТК Сладков А. Заявка № 15.07.2016 окончание

	КонецЕсли;
	//АБС ВСТАВКА 17481 КОНЕЦ
	
	ПроводкиБУ.Записать(Ложь);
	ПроводкиНУ.Записать(Ложь);
	//++ТТК Готовцев  15.06.2018
	Если ПроверкаЗачетаАванса() ТОгда
		//--ТТК Готовцев  15.06.2018
		
		Если НЕ (СтруктураПараметровЗачетАванса = Ложь ИЛИ НЕ ЗначениеЗаполнено(СтруктураПараметровЗачетАванса)) Тогда
			
			Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете тогда
				СтруктураПараметровЗачетАванса.Вставить("ПроводкиНУ", Движения.Налоговый);
			Конецесли;
			
			БухгалтерскийУчетРасчетовСКонтрагентами.РасчетыВУсловныхЕдиницахПриобретениеРеализация(
			СтруктураПараметровЗачетАванса, 
			мВалютаРегламентированногоУчета,
			РежимПроведения,
			ПроводкиБУ,
			ЭтотОбъект,
			Отказ,
			,
			Истина);
			
			//АБС ВСТАВКА 17481 НАЧАЛО
			Если ПрошлыйПериод Тогда
				Для каждого Строка Из ПроводкиБУ Цикл
					Если Строка.ВалютнаяСуммаДт < 0 и Строка.Сумма > 0 Тогда
						Строка.ВалютнаяСуммаДт = -Строка.ВалютнаяСуммаДт;
					КонецЕсли;	
					Если Строка.ВалютнаяСуммаКт < 0 и Строка.Сумма > 0 Тогда
						Строка.ВалютнаяСуммаКт = -Строка.ВалютнаяСуммаКт;
					КонецЕсли;	
				КонецЦикла;			
				Для каждого Строка Из ПроводкиНУ Цикл
					Если Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
						Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
					КонецЕсли;	
					Если Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
						Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
					КонецЕсли;	
					// Start КТТК Ермолов Е.Л.  17.05.2016 7722270
					Попытка
						Если Не СтруктураШапкиДокумента.СтатьяПрочихДоходовИРасходов.ПринятиеКналоговомуУчету Тогда 
							Если Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
								Строка.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ПР;
							КонецЕсли;	
							Если Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ Тогда
								Строка.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ПР;
							КонецЕсли;
						КонецЕсли;
					Исключение
					КонецПопытки;
					// Stop КТТК Ермолов Е.Л.  17.05.2016
				КонецЦикла;			
			КонецЕсли;
			//АБС ВСТАВКА 17481 КОНЕЦ
			
			ПроводкиБУ.Записать(Ложь);
			ПроводкиНУ.Записать(Ложь);
			
		Конецесли;
	КонецЕсли;
КонецПроцедуры // ДвиженияПоРегистрамРегл()

Функция ПодготовитьТаблицуДвиженийДляРегистраРасчетовПоРеализации(СтруктураПараметров, СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам)
	Перем Счет91, Счет90_03;
	
	Счет91 = ПланыСчетов.Хозрасчетный.ПрочиеДоходыИРасходы;
	Счет90_03 = ПланыСчетов.Хозрасчетный.Продажи_НДС;
	
	ОписаниеТипов_ВидыСубконтоХозрасчетные = Метаданные.ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.Тип;				
	ТаблицаДвижений = новый ТаблицаЗначений();				
	
	ТаблицаДвижений.Колонки.Добавить("ТекущаяТаблица");
	
	ТаблицаДвижений.Колонки.Добавить("ЗаказПокупателя"		, Документы.ТипВсеСсылки());
	
	ТаблицаДвижений.Колонки.Добавить("ВидЦенности"			, Новый ОписаниеТипов("ПеречислениеСсылка.ВидыЦенностей"));
	ТаблицаДвижений.Колонки.Добавить("Номенклатура"			, Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	ТаблицаДвижений.Колонки.Добавить("СтавкаНДС"			, Новый ОписаниеТипов("ПеречислениеСсылка.СтавкиНДС"));
	
	ТаблицаДвижений.Колонки.Добавить("КоррСчет"				, Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	ТаблицаДвижений.Колонки.Добавить("СубконтоБУ"			, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	
	ТаблицаДвижений.Колонки.Добавить("СчетУчетаНУ"			, Новый ОписаниеТипов("ПланСчетовСсылка.Налоговый"));
	ТаблицаДвижений.Колонки.Добавить("СубконтоНУ"			, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	
	ТаблицаДвижений.Колонки.Добавить("СчетНДС"				, Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	
	ТаблицаДвижений.Колонки.Добавить("СуммаСНДС"			, Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаДвижений.Колонки.Добавить("СуммаНДС"				, Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	
	ТаблицаДвижений.Колонки.Добавить("СуммаВзаиморасчетов"	, Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	
	ТаблицаДвижений.Колонки.Добавить("КоррСубконто1"		, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	ТаблицаДвижений.Колонки.Добавить("КоррСубконто2"		, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	ТаблицаДвижений.Колонки.Добавить("КоррСубконто3"		, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	
	ТаблицаДвижений.Колонки.Добавить("СубконтоНДС1"			, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	ТаблицаДвижений.Колонки.Добавить("СубконтоНДС2"			, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	ТаблицаДвижений.Колонки.Добавить("СубконтоНДС3"			, ОписаниеТипов_ВидыСубконтоХозрасчетные);
	
	Если СтруктураШапкиДокумента.ОтражатьВНалоговомУчете тогда
		
		ТаблицаДвижений.Колонки.Добавить("СубконтоНУ1"		, ОписаниеТипов_ВидыСубконтоХозрасчетные);
		ТаблицаДвижений.Колонки.Добавить("СубконтоНУ2"		, ОписаниеТипов_ВидыСубконтоХозрасчетные);
		ТаблицаДвижений.Колонки.Добавить("СубконтоНУ3"		, ОписаниеТипов_ВидыСубконтоХозрасчетные);
		
	КонецЕсли;
	
	ПереименованиеКолонокРезультирующейТаблицы = Новый Структура;
	ПереименованиеКолонокРезультирующейТаблицы.Вставить("КоррСчет", 	"СчетДоходовБУ");
	ПереименованиеКолонокРезультирующейТаблицы.Вставить("СчетУчетаНУ", 	"СчетДоходовНУ");
	ПереименованиеКолонокРезультирующейТаблицы.Вставить("СуммаНДС", 	"НДС");
	
	УчетНДС.ПереименованиеКолонок(ТаблицаДвижений, ПереименованиеКолонокРезультирующейТаблицы);
	
	НаборТаблиц = Новый Массив;
	НаборТаблиц.Добавить(ТаблицаПоТоварам);
	НаборТаблиц.Добавить(ТаблицаПоУслугам);
	
	Для Каждого ТекущаяТаблица Из НаборТаблиц Цикл
		
		Для Каждого СтрокаТаблицы Из ТекущаяТаблица Цикл
			
			СтрокаНовойТаблицы = ТаблицаДвижений.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаНовойТаблицы,СтрокаТаблицы);
			
			СтрокаНовойТаблицы.СчетНДС 				= ?(БухгалтерскийУчет.ЭтоСубсчет(СтрокаТаблицы.СчетРасходовБУ, Счет91),СтрокаТаблицы.СчетРасходовБУ, Счет90_03);
			СтрокаНовойТаблицы.СуммаСНДС 			= СтрокаТаблицы.СуммаБезНДС + СтрокаТаблицы.НДС;
			СтрокаНовойТаблицы.СуммаВзаиморасчетов 	= СтрокаТаблицы.СуммаБезНДСВал + СтрокаТаблицы.НДСВал;
			
			КоррСчет = СтрокаНовойТаблицы.СчетДоходовБУ;
			
			Для НомерСубконто =1 По КоррСчет.ВидыСубконто.Количество() Цикл
				ВидСубк = КоррСчет.ВидыСубконто[НомерСубконто-1].ВидСубконто;
				Если ВидСубк.ТипЗначения.СодержитТип(ТипЗнч(СтрокаНовойТаблицы.СубконтоБУ)) Тогда
					СтрокаНовойТаблицы["КоррСубконто"+НомерСубконто] = СтрокаНовойТаблицы.СубконтоБУ;
				ИначеЕсли ВидСубк.ТипЗначения.СодержитТип(ТипЗнч(СтрокаНовойТаблицы.СтавкаНДС)) тогда
					СтрокаНовойТаблицы["КоррСубконто"+НомерСубконто] = СтрокаНовойТаблицы.СтавкаНДС;
				Конецесли;
			КонецЦикла; 
			
			КоррСчет = СтрокаНовойТаблицы.СчетНДС;
			
			Для НомерСубконто =1 По КоррСчет.ВидыСубконто.Количество() Цикл
				ВидСубк = КоррСчет.ВидыСубконто[НомерСубконто-1].ВидСубконто;
				Если ВидСубк.ТипЗначения.СодержитТип(ТипЗнч(СтрокаНовойТаблицы.СубконтоБУ)) Тогда
					СтрокаНовойТаблицы["СубконтоНДС"+НомерСубконто] = СтрокаНовойТаблицы.СубконтоБУ;
				ИначеЕсли ВидСубк.ТипЗначения.СодержитТип(ТипЗнч(СтрокаНовойТаблицы.СтавкаНДС)) ТОгда
					СтрокаНовойТаблицы["СубконтоНДС"+НомерСубконто] = СтрокаНовойТаблицы.СтавкаНДС;
				Конецесли;
			КонецЦикла; 
			
			Если СтруктураПараметров.ОтражатьВНалоговомУчете тогда
				КоррСчет = СтрокаНовойТаблицы.СчетДоходовНУ;
				Для НомерСубконто =1 по КоррСчет.ВидыСубконто.Количество() Цикл
					ВидСубк = КоррСчет.ВидыСубконто[НомерСубконто-1].ВидСубконто;
					Если ВидСубк.ТипЗначения.СодержитТип(ТипЗнч(СтрокаНовойТаблицы.СубконтоБУ)) Тогда
						СтрокаНовойТаблицы["СубконтоНУ"+НомерСубконто] = СтрокаНовойТаблицы.СубконтоБУ;
					ИначеЕсли ВидСубк.ТипЗначения.СодержитТип(ТипЗнч(СтрокаНовойТаблицы.Номенклатура)) Тогда
						СтрокаНовойТаблицы["СубконтоНУ"+НомерСубконто] = СтрокаНовойТаблицы.Номенклатура;
					Конецесли;
				КонецЦикла; 
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла; 
	
	УчетНДС.ПереименованиеКолонок(ТаблицаДвижений, ПереименованиеКолонокРезультирующейТаблицы, Истина);
	
	ТаблицаДвижений.Колонки.ЗаказПокупателя.Имя = "Сделка";
	
	ЧисловыеКолонкиСтрокой   = "СуммаВзаиморасчетов, СуммаСНДС, СуммаНДС";
	ЧисловыеКолонкиСтруктура = Новый Структура(ЧисловыеКолонкиСтрокой);
	НеЧисловыеКолонкиСтрокой = "";
	
	Для Каждого Колонка Из ТаблицаДвижений.Колонки Цикл
		Если НЕ ЧисловыеКолонкиСтруктура.Свойство(Колонка.Имя) Тогда
			НеЧисловыеКолонкиСтрокой = НеЧисловыеКолонкиСтрокой + ", " + Колонка.Имя;	
		КонецЕсли;  
	КонецЦикла;
	
	Если СтруктураПараметров.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоДоговоруВЦелом Тогда
		ТаблицаДвижений.ЗаполнитьЗначения(Неопределено, 			  "Сделка");
	ИначеЕсли СтруктураПараметров.ВедениеВзаиморасчетов = Перечисления.ВедениеВзаиморасчетовПоДоговорам.ПоСчетам Тогда
		ТаблицаДвижений.ЗаполнитьЗначения(СтруктураПараметров.Сделка, "Сделка");
	КонецЕсли;
	
	НеЧисловыеКолонкиСтрокой = Прав(НеЧисловыеКолонкиСтрокой,СтрДлина(НеЧисловыеКолонкиСтрокой)-2);
	
	ТаблицаДвижений.Свернуть(НеЧисловыеКолонкиСтрокой, ЧисловыеКолонкиСтрокой);
	
	Возврат ТаблицаДвижений;
	
КонецФункции


////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ОбработкаЗаполнения(Основание)

	Если ТипЗнч(Основание) = Тип("Структура") Тогда
		
		Возврат;
		
	ИначеЕсли ЗначениеЗаполнено(Основание) Тогда
		
		ДокументСсылка 	  = УчетНДС.ПолучитьИсправляемыйДокументРеализации(Основание, Ложь);
		ДокументОснование = ПолучитьПоследнийКорректирующийДокумент(ДокументСсылка);
		
		#Если Клиент Тогда
		Если ЗначениеЗаполнено(ДокументОснование) И Основание <> ДокументОснование И Основание.Дата < ДокументОснование.Дата Тогда
			Если Вопрос("Для указанного документа существуют более поздние корректировки.
				|Использовать последнюю введенную корректировку?", РежимДиалогаВопрос.ДаНет) <> КодВозвратаДиалога.Да Тогда
					ДокументОснование = Основание;
			КонецЕсли;
		Иначе
			ДокументОснование = Основание;
		КонецЕсли;
		#КонецЕсли
	
		Если ЗначениеЗаполнено(ДокументСсылка)
		 И ЗначениеЗаполнено(ДокументСсылка.ВалютаДокумента) 
		 И ДокументСсылка.ВалютаДокумента <> мВалютаРегламентированногоУчета 
		 И ЗначениеЗаполнено(ДокументСсылка.ДоговорКонтрагента)
		 И ДокументСсылка.ДоговорКонтрагента.РасчетыВУсловныхЕдиницах Тогда
			#Если Клиент Тогда
			Предупреждение("Для договоров в условных единицах, корректировка документов, оформленных в валюте, не поддерживается.
			|Корректируемый документ должен быть оформлен в рублях.");
			#КонецЕсли
			Возврат;			
		КонецЕсли;
		
	Иначе
		
		ДокументОснование = Основание;
		
	КонецЕсли;
	
	//Если ТипЗнч(ДокументОснование) = Тип("ДокументСсылка.КорректировкаРеализации")
	// И Основание.ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение
	// И ВидОперации = Перечисления.ВидыОперацийИсправленияПоступленияРеализации.СогласованноеИзменение Тогда
	//	#Если Клиент Тогда
	//	Предупреждение("Нельзя вводить документ на согласованную корректировку на основании другой согласованной корректировки!");
	//	#КонецЕсли
	//	Возврат;
	//КонецЕсли;
	
	Если ЗначениеЗаполнено(ДокументОснование) Тогда
		ДокументРеализации = ДокументОснование;
		Организация 	   = ДокументРеализации.Организация;
	КонецЕсли;
	
	Дата				= НачалоДня(ТекущаяДата());
	КорректироватьБУиНУ = ДоступнаКорректировкаБУиНУ();
	
	Если ЗначениеЗаполнено(ДокументОснование) Тогда
		ЗаполнитьСвойстваШапки();
		ЗаполнитьПоДокументу();
	КонецЕсли;
	
	СуммаДокумента = УчетНДС.ПолучитьСуммуДокументаСНДС(ЭтотОбъект, "Товары") + УчетНДС.ПолучитьСуммуДокументаСНДС(ЭтотОбъект, "Услуги");

	//АБС+ Тупиков 13209
	Если ЭтоНовый() Тогда
		ПризнаватьЗачитыватьАванс = ДоступноПризнаватьЗачитыватьАванс();
	КонецЕсли;
	//АБС- Тупиков
	
КонецПроцедуры // ОбработкаЗаполнения()

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	
	мДокументРеализацииСсылка = УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Истина);
	
	// Проверим флаги в шапке докмента
	Если КорректироватьБУиНУ И НЕ ОтражатьВУправленческомУчете И НЕ ОтражатьВБухгалтерскомУчете Тогда
		СтрокаСообщения = Нстр("ru = 'Документ должен принадлежать хотя бы одному из видов учета: ""Управленческий"" и (или)  ""Бухгалтерский"".'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрокаСообщения, ЭтотОбъект,,, Отказ);
	КонецЕсли;
	
	Если КорректироватьБУиНУ И НЕ ДоступнаКорректировкаБУиНУ() Тогда
		Если НЕ (мИспользоватьРасширеннуюАналитику И мДатаНачалаИспользованияРасширеннойАналитики <= Дата) Тогда
			СтрокаСообщения = Нстр("ru = 'Корректировка по упр. и регл. учету возможна только в режиме расширенной аналитики'");
		Иначе
			СтрокаСообщения = Нстр("ru = 'Для указанного основания корректировка по упр. и регл. учету не выполняется.'");
		КонецЕсли;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтрокаСообщения, ЭтотОбъект,,, Отказ);
	КонецЕсли;
	
	// Единица измерения мест должна быть заполнена, если указано количество мест
	ОбработкаТабличныхЧастейСервер.ПроверитьЗаполненаЕдиницаИзмеренияМест(Товары, ЭтотОбъект, Отказ);
	
	// Проверим тип номенклатуры в ТЧ Товары
	ОписаниеТипаНоменклатуры = ПолучитьОписаниеТипаНоменклатурыПоОснованию();
	Для Каждого Строка Из Товары Цикл
		Если ЗначениеЗаполнено(Строка.Номенклатура)
		 И НЕ ОписаниеТипаНоменклатуры.СодержитТип(ТипЗнч(Строка.Номенклатура)) Тогда
			ТекстОшибки = НСтр("ru = 'Тип номенклатуры в строке ""%НомерСтроки%"" списка ""Товары"" не соответствует указанному основанию.'");
			ТекстОшибки = СтрЗаменить(ТекстОшибки, "%НомерСтроки%", Строка.НомерСтроки);
			ttk_ОбщегоНазначения.СообщитьОбОшибке(ТекстОшибки, Отказ);
		КонецЕсли;
	КонецЦикла;
	
	// Скорректируем список проверяемых реквизитов документа
	НепроверяемыеРеквизиты = Новый Массив;
	
	Если НЕ КорректироватьБУиНУ Тогда
		НепроверяемыеРеквизиты.Добавить("Товары.Номенклатура");
		НепроверяемыеРеквизиты.Добавить("Услуги.Номенклатура");
	КонецЕсли;
	
	Если НЕ (КорректироватьБУиНУ И ЭтоКорректировкаРТиУ()) Тогда
		НепроверяемыеРеквизиты.Добавить("Товары.ЕдиницаИзмерения");
	 	НепроверяемыеРеквизиты.Добавить("Услуги.Содержание");
	КонецЕсли;
	
	Если НЕ УчитыватьНДС Тогда
		НепроверяемыеРеквизиты.Добавить("Товары.СтавкаНДС");
		НепроверяемыеРеквизиты.Добавить("Услуги.СтавкаНДС");
	КонецЕсли;
	
	Для Каждого Реквизит Из НепроверяемыеРеквизиты Цикл
		НомерУдаляемогоЭлемента = ПроверяемыеРеквизиты.Найти(Реквизит);
		Если НомерУдаляемогоЭлемента <> Неопределено Тогда
			ПроверяемыеРеквизиты.Удалить(НомерУдаляемогоЭлемента);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
               
Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	Перем НайденныйСФ;
	
	//Бобылев А.А. 26.10.2018 АСУП
	Если ttk_ИнтеграцияБП30Сервер.ПроверкаПометкиУдаления(Дата, ПометкаУдаления) Тогда
		ttk_ОбщегоНазначения.СообщитьОбОшибке("Запрещено устанавливать пометку удаления", Истина);
		Ссылка.ПометкаУдаления = Ложь;
	КонецЕсли;
	//Бобылев А.А.---------------

	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	СписокСтатусовДляКонтроля = Новый СписокЗначений;
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.Подготовка);
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.Отказ);
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.Отмена);
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.СогласованиеОФК);	
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.УточнениеОФК);
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.УточнениеБухгалтерией);
	СписокСтатусовДляКонтроля.Добавить(Перечисления.абс_СтатусыПервичныхДокументов.ОбработкаБухгалтером);
		
	Если не СписокСтатусовДляКонтроля.НайтиПоЗначению(абс_СтатусДокумента) = Неопределено Тогда 		
		Если Проведен Тогда			
			РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения;
		Иначе                			
			РежимЗаписи = РежимЗаписиДокумента.Запись;
		КонецЕсли;  		  		
	Иначе         		
		РежимЗаписи = РежимЗаписиДокумента.Проведение; 		
	КонецЕсли;	   	
	
	Если ОтчетностьПодписана = Ложь Тогда
		ОтчетностьПодписана = Истина;
	КонецЕсли;	
	
	мУдалятьДвижения = НЕ ЭтоНовый();
	
	ЗаполнитьСвойстваШапки(Ложь);
	
	Если Услуги.Количество() > 0 И НЕ ВозможнаКорректировкаУслуг() Тогда
		Услуги.Очистить();
	КонецЕсли;
	
	// Проверка заполнения единицы измерения мест и количества мест
	ОбработкаТабличныхЧастей.ПриЗаписиПроверитьЕдиницуИзмеренияМест(Товары);
	ОбработкаТабличныхЧастей.ПриЗаписиПроверитьСтавкуНДС(ЭтотОбъект, Товары);
	ОбработкаТабличныхЧастей.ПриЗаписиПроверитьСтавкуНДС(ЭтотОбъект, Услуги);
	
	ЗаполнитьЗаказыВТЧ();
	ЗаполнитьСкладыВТЧ();
	ОбработатьСуммыДоКорректировки();
	
	КачествоНовый = Справочники.Качество.Новый;
	Для Каждого СтрокаТаблицы Из ЭтотОбъект.Товары Цикл
		Если СтрокаТаблицы.Качество <> КачествоНовый Тогда
			СтрокаТаблицы.Качество = КачествоНовый;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.ЗаказПокупателя)
		 И СтрокаТаблицы.СпособСписанияОстаткаТоваров = Перечисления.СпособыСписанияОстаткаТоваров.ИзРезерва Тогда
			СтрокаТаблицы.СпособСписанияОстаткаТоваров = Перечисления.СпособыСписанияОстаткаТоваров.СоСклада;
		КонецЕсли;
	КонецЦикла;
	
	// Удаление неиспользуемых строк табличной части "Серийные номера".
	УчетСерийныхНомеров.УдалитьНеиспользуемыеСтрокиПодчиненнойТЧ(ЭтотОбъект, мПараметрыСвязиСтрокТЧ, "Товары");
	УчетСерийныхНомеров.УдалитьНеиспользуемыеСтрокиПодчиненнойТЧ(ЭтотОбъект, мПараметрыСвязиСтрокТЧ, "СоставНабора", "СерийныеНомераСоставНабора");
	
	// Посчитать суммы документа и записать ее в соответствующий реквизит шапки для показа в журналах
	СуммаДокумента = УчетНДС.ПолучитьСуммуДокументаСНДС(ЭтотОбъект, "Товары") + УчетНДС.ПолучитьСуммуДокументаСНДС(ЭтотОбъект, "Услуги");
	
	// Проверка счета-фактуры
	УчетНДС.СинхронизацияПометкиНаУдалениеУСчетаФактуры(ЭтотОбъект);
	
	Если НЕ ЗначениеЗаполнено(абс_СтатусДокумента) Тогда
		абс_СтатусДокумента = Перечисления.абс_СтатусыПервичныхДокументов.Подготовка;		
	КонецЕсли;	
	
КонецПроцедуры // ПередЗаписью

Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли;

	УчетНДС.ПроверитьСоответствиеРеквизитовСчетаФактуры(ЭтотОбъект);
	
	// АБС ВСТАВКА Согласование первичных документов
	Попытка 	
		СтатусПоРегистру = абс_БизнесПроцессы.ПолучитьСтатусПервичногоДокументаПоРегистру(Ссылка);	
		Если НЕ абс_СтатусДокумента = СтатусПоРегистру Тогда
			ЗаписатьНовыйСтатус(абс_СтатусДокумента, абс_ПричинаИзмененияСтатуса);
		КонецЕсли;                                                                                		
	Исключение
		ttk_ОбщегоНазначения.СообщитьОбОшибке("Ошибка при записи документа: " + ОписаниеОшибки() + ".", Отказ);		
		Возврат;    		
	КонецПопытки;		
	// АБС ВСТАВКА Согласование первичных документов КОНЕЦ	
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Перем СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам;
	Перем ТаблицаПоВзаиморасчетам, ТаблицаПоРасчетам, ТаблицаТоваровДляУчетаЗатрат;
	
	// Удалим старые движения документа
	Если мУдалятьДвижения Тогда
		ttk_ОбщегоНазначения.УдалитьДвиженияРегистратора(ЭтотОбъект, Отказ, Истина, РежимПроведения);
	КонецЕсли;
	
	// Заголовок для сообщений об ошибках проведения.
	Заголовок = ttk_ОбщегоНазначения.ПредставлениеДокументаПриПроведении(Ссылка);	
	
	// Подготовим данные для проведения документа
	ПодготовитьСтруктуруШапкиДокумента(Заголовок, СтруктураШапкиДокумента, РежимПроведения, Отказ);
	ПодготовитьПараметрыУчетнойПолитики(СтруктураШапкиДокумента, Отказ);
	
	// Проверим правильность заполнения шапки документа
	ПроверитьЗаполнениеШапки(СтруктураШапкиДокумента, Заголовок, Отказ);
	
	// Проверим допустимость для пользователя цен документа
	УправлениеДопПравамиПользователей.ПроверитьДопустимостьЦенОтпуска(ЭтотОбъект, "Товары", Отказ);
	УправлениеДопПравамиПользователей.ПроверитьДопустимостьЦенОтпуска(ЭтотОбъект, "Услуги", Отказ);
	
	Если Отказ Тогда 
		Возврат;
	КонецЕсли;
	
	//Сделаем переменные доступными из подписок на события
	ДополнительныеСвойства.Вставить("СтруктураШапкиДокумента",  СтруктураШапкиДокумента);
	ДополнительныеСвойства.Вставить("СтруктураТабличныхЧастей", Новый Структура);
	
	// Движения по регистрам упр. и рег учета формируем только если в документе установлен реквизит КорректироватьБУиНУ
	// Движения по регистрам учета НДС формируются отдельной обработкой
	Если СтруктураШапкиДокумента.КорректироватьБУиНУ Тогда
		
		// Подготовим данные табличных частей документа
		ПодготовитьТаблицыДокумента(СтруктураШапкиДокумента, ТаблицаПоТоварам, ТаблицаПоУслугам);
		
		// Проверим заполнение ТЧ
		ПроверитьЗаполнениеТабличнойЧастиТовары(ТаблицаПоТоварам, СтруктураШапкиДокумента, Заголовок, Отказ);
		ПроверитьЗаполнениеТабличнойЧастиУслуги(ТаблицаПоУслугам, СтруктураШапкиДокумента, Заголовок, Отказ);
		
		//Проверим счета учета
		СчетаУчетаВДокументах.ПроверитьСчетаУчетаТабличнойЧасти("Товары", ТаблицаПоТоварам, СтруктураШапкиДокумента, Отказ, Заголовок);
		СчетаУчетаВДокументах.ПроверитьСчетаУчетаТабличнойЧасти("Услуги", ТаблицаПоУслугам, СтруктураШапкиДокумента, Отказ, Заголовок);
		
		//Проверим корректность указанных (заполненных) счетов учета
		ПроверитьЗаполнениеТабличнойЧастиТоварыРегл(ТаблицаПоТоварам, СтруктураШапкиДокумента, Заголовок, Отказ);
		
		мСтруктураПараметровВзаиморасчетов.Вставить(
			"СтруктураПодготовленныхТаблиц",
			Новый Структура("Товары, Услуги", ТаблицаПоТоварам, ТаблицаПоУслугам));
		
		УправлениеВзаиморасчетами.ПодготовитьТаблицыДляПроведенияПоВзаиморасчетам(
			ТаблицаПоВзаиморасчетам,
			ТаблицаПоРасчетам, 
			ЭтотОбъект,
			мСтруктураПараметровВзаиморасчетов,
			СтруктураШапкиДокумента, 
			Отказ,
			Заголовок);
		
		//Проверим на возможность проведения в БУ и НУ
		Если СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете ИЛИ СтруктураШапкиДокумента.ОтражатьВНалоговомУчете Тогда
			УправлениеВзаиморасчетами.ПроверкаВозможностиПроведенияВ_БУ_НУ(
				ДоговорКонтрагента,
				СтруктураШапкиДокумента.ВалютаДокумента,
				СтруктураШапкиДокумента.ОтражатьВБухгалтерскомУчете,
				СтруктураШапкиДокумента.ОтражатьВНалоговомУчете,
				мВалютаРегламентированногоУчета,
				Ложь,
				Отказ,
				Заголовок);
		КонецЕсли;
		
		ТаблицаТоваровДляУчетаЗатрат = ТаблицаПоТоварам.СкопироватьКолонки();
		
		// Движения по документу
		Если НЕ Отказ Тогда
			ДвиженияПоРегистрам(
				РежимПроведения, СтруктураШапкиДокумента,
				ТаблицаПоТоварам,ТаблицаПоУслугам, ТаблицаПоВзаиморасчетам, ТаблицаПоРасчетам, ТаблицаТоваровДляУчетаЗатрат,
				Заголовок, Отказ);
		КонецЕсли;
		
	КонецЕсли;
	
	//Сделаем переменные доступными из подписок на события
	ДополнительныеСвойства.СтруктураТабличныхЧастей.Вставить("ТаблицаПоТоварам", ТаблицаТоваровДляУчетаЗатрат);
	
		
	
КонецПроцедуры // ОбработкаПроведения()

// АБС ВСТАВКА Согласование первичных документов
Процедура ЗаписатьНовыйСтатус(НовыйСтатус, Комментарий = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(НовыйСтатус) Тогда
		НовыйСтатус = Перечисления.абс_СтатусыПервичныхДокументов.Подготовка;		
	КонецЕсли;	
	
	ТекПользователь = глЗначениеПеременной("глТекущийПользователь");
	
	НаборЗаписей = РегистрыСведений.абс_ИзменениеСтатусовПервичныхДокументов.СоздатьНаборЗаписей();
	
	НаборЗаписей.Отбор.ПервичныйДокумент.Установить(Ссылка);
	НаборЗаписей.Прочитать();
	
	Запись = НаборЗаписей.Добавить();
	Запись.Период = абс_СерверныеФункции.ПолучитьДатуСервера();

	Запись.ПервичныйДокумент		= Ссылка;
	Запись.Пользователь 			= ТекПользователь;	
	Запись.СтатусДокумента			= НовыйСтатус;
	
	Запись.Комментарий 				= Комментарий;
	
	ОтветственныйСотрудник = абс_БизнесПроцессы.ПолучитьСотрудникаПользователя(ТекПользователь);
	
	Если НЕ ОтветственныйСотрудник = Неопределено Тогда
		Запись.ДолжностьОтветственного	= ОтветственныйСотрудник.Должность;
	КонецЕсли;
	
	НаборЗаписей.Записать();
	
КонецПроцедуры

//++ТТК Готовцев  15.06.2018

Функция ПроверкаЗачетаАванса()
	ЕСли Константы.ttk_РазделениеВзаиморасчетовНаАвасыИЗадолженность.Получить() >  Дата("00010101") ТОгда
		АгрКонтрагент = Справочники.Контрагенты.НайтиПоКоду("K205136");
		ЕСли ЗначениеЗаполнено(ЛогЗагрузкиИзАСР) ТОгда
			ЕСли Дата >= Константы.ttk_РазделениеВзаиморасчетовНаАвасыИЗадолженность.Получить() и СокрЛП(Организация.Код) = "000000001"  ТОгда
			//ЕСли Дата >= Константы.ttk_РазделениеВзаиморасчетовНаАвасыИЗадолженность.Получить()   ТОгда
				Если ВалютаДокумента = Константы.ВалютаРегламентированногоУчета.Получить() и Контрагент <> АгрКонтрагент ТОгда
					Если ЗначениеЗаполнено(ДоговорКонтрагента.ввв_МестонахождениеБиллинга) ТОгда
						Если  ДоговорКонтрагента.ввв_МестонахождениеБиллинга.ТипБиллинга = Справочники.абс_ТипыБиллинга.НайтиПоНаименованию("BRM") Тогда
							Возврат  ложь;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			Конецесли;	
		Конецесли;
	Конецесли;
	Возврат истина;	
КонецФункции	
//--ТТК Готовцев  15.06.2018

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

мВалютаРегламентированногоУчета   			 = глЗначениеПеременной("ВалютаРегламентированногоУчета");
мИспользоватьРасширеннуюАналитику 			 = глЗначениеПеременной("ИспользоватьРасширеннуюАналитикуУчетаНоменклатурыИЗатрат");
мДатаНачалаИспользованияРасширеннойАналитики = глЗначениеПеременной("ДатаНачалаИспользованияРасширеннойАналитикиУчетаНоменклатурыИЗатрат");

мДокументРеализацииСсылка 					 = УчетНДС.ПолучитьИсправляемыйДокументРеализации(ДокументРеализации, Истина);

мПараметрыСвязиСтрокТЧ = Новый Соответствие;
мПараметрыСвязиСтрокТЧ.Вставить("Товары", 		Новый Структура("СвободныйКлюч, ФлагМодификации", Неопределено, Ложь));
мПараметрыСвязиСтрокТЧ.Вставить("СоставНабора", Новый Структура("СвободныйКлюч, ФлагМодификации", Неопределено, Ложь));

мСтруктураПараметровВзаиморасчетов = Новый Структура;
мСтруктураПараметровВзаиморасчетов.Вставить("СтруктураТабличныхЧастей", 	Новый Структура("Товары, Услуги"));
мСтруктураПараметровВзаиморасчетов.Вставить("Направление", 					"Реализация");
мСтруктураПараметровВзаиморасчетов.Вставить("ЕстьЗаказыВТабличныхЧастях", 	Истина);
мСтруктураПараметровВзаиморасчетов.Вставить("ИмяЗаказаВТабличныхЧастях", 	"ЗаказПокупателя");

мУказаниеСкладовВТЧ = Истина;
