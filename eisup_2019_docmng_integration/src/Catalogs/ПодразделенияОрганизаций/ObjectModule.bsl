////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

Перем КонтролироватьПорядок Экспорт;

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ

// Процедура, обработчик события "ПередЗаписью" объекта
//
Процедура ПередЗаписью(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ТекРодитель = Ссылка; 	
	Пока ЗначениеЗаполнено(ТекРодитель.Родитель) Цикл
		ТекРодитель = ТекРодитель.Родитель;
		Если не ТекРодитель.абс_ТипПодразделенияОрганизации = абс_ТипПодразделенияОрганизации Тогда
			Отказ = Истина;
			Сообщить("Элемент с типом «"+абс_ТипПодразделенияОрганизации+"» нельзя размещать в ветке, где родитель имеет тип «"+ТекРодитель.абс_ТипПодразделенияОрганизации+"», код родителя «"+СокрЛП(ТекРодитель.Код)+"»!");	
		КонецЕсли;
	КонецЦикла;	 		
	
	Если Ссылка.абс_ТипПодразделенияОрганизации = Перечисления.абс_ТипыПодразделенийОрганизации.ПодразделениеОрганизации Тогда
		Отказ = Истина;
		Сообщить("Изменение элементов с типа «подразделение организации» не доступно!") 
	КонецЕсли;

	Если НЕ ((РольДоступна("ПолныеПрава") 
			 	и (абс_ТипПодразделенияОрганизации = Перечисления.абс_ТипыПодразделенийОрганизации.ЦФО
			   		или абс_ТипПодразделенияОрганизации = Перечисления.абс_ТипыПодразделенийОрганизации.МестоположениеОС))
		      или (РольДоступна("абс_УчетОСиНМА") 
				и абс_ТипПодразделенияОрганизации = Перечисления.абс_ТипыПодразделенийОрганизации.МестоположениеОС)) Тогда
				
		Отказ = Истина;
		Сообщить("Ввод новых и изменение элементов не доступен!");	
		
	КонецЕсли;
	
	// АБС ВСТАВКА
	абс_Используется = НЕ (абс_Статус = Перечисления.абс_СтатусыНСИ.Архив);
	// АБС ВСТАВКА КОНЕЦ
	
	Если НЕ Отказ Тогда
		ОбщегоНазначения.ПередЗаписьюОбъектаПорядка(Отказ, ЭтотОбъект, КонтролироватьПорядок);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	//АБС_Стрельцов + НАЧАЛО
	//добавлено: 22.03.2013
	//-------------------------------
	Если ЭтотОбъект.абс_ЦФО <> Ссылка.абс_ЦФО или ЭтотОбъект.абс_ЦФУ <> Ссылка.абс_ЦФУ Тогда
		НЗ = РегистрыСведений.абс_ИсторияЦФОЦФУпоПодразделению.СоздатьМенеджерЗаписи();
		
		НЗ.Период = ТекущаяДата();
		НЗ.ПодразделениеОрганизации = Ссылка;
		НЗ.ЦФО = ЭтотОбъект.абс_ЦФО;
		НЗ.ЦФУ = ЭтотОбъект.абс_ЦФУ;
		НЗ.Пользователь = глЗначениеПеременной("глТекущийПользователь");
		НЗ.Записать(Истина);
	КонецЕсли;
	//----------------------------------
	//АБС_Стрельцов - КОНЕЦ
	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = ТИп("Структура") Тогда
		Если ДанныеЗаполнения.Свойство("абс_ТипПодразделенияОрганизации") Тогда
			абс_ТипПодразделенияОрганизации = ДанныеЗаполнения.абс_ТипПодразделенияОрганизации;
		Иначе
			абс_ТипПодразделенияОрганизации = Перечисления.абс_ТипыПодразделенийОрганизации.МестоположениеОС;
		КонецЕсли;			
			
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОПЕРАТОРЫ ОСНОВНОЙ ПРОГРАММЫ

КонтролироватьПорядок = Истина;

// АБС ВСТАВКА Фролов не нужно контролировать порядок
КонтролироватьПорядок = Ложь;
// АБС ВСТАВКА Фролов не нужно контролировать порядок КОНЕЦ
